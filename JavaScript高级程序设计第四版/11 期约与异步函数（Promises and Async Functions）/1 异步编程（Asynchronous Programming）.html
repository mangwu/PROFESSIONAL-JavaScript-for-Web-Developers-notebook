<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>1. 异步编程（Asynchronous Programming）</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style><link rel="stylesheet" href="../../style.css"></head><body><article id="4aaaf06c-276e-47f6-8403-929370786d6e" class="page sans"><header><div class="page-header-icon undefined"><span class="icon">🎱</span></div><h1 class="page-title">1. 异步编程（Asynchronous Programming）</h1></header><div class="page-body"><ul id="1c5d9dce-7114-48c5-8fa7-6ddbe6a4b281" class="bulleted-list"><li style="list-style-type:disc"><strong>同步行为</strong>（<strong>synchronous behavior</strong>）和<strong>异步行为</strong>（<strong>asynchronous behavior</strong>）的<strong>对立统一</strong>（<strong>duality， 二象性</strong>）是计算机科学中一个<strong>基础概念</strong>（<strong>fundamental concept</strong>），尤其像JavaScript这种<strong>单线程事件循环模型</strong>（<strong>single-threaded event loop model</strong>）中语言中，同步行为和异步行为更是需要理解的基础概念<ul id="75555654-8d1b-4fca-a53e-95f79893881e" class="bulleted-list"><li style="list-style-type:circle">同步行为：之前章节学习的所有例子都是同步行为，即按照代码顺序从上到下开始解释执行（代码提升也仅仅是在提升后按顺序执行，仍然属于同步行为）</li></ul><ul id="f7ff3ba7-0c0c-4d07-a31a-9d0430bd4d7c" class="bulleted-list"><li style="list-style-type:circle">异步行为：异步行为<strong>承担</strong>（<strong>is borne out of</strong>）了因<strong>高吞吐量计算</strong>（<strong>higher computational throughput</strong>）而<strong>高延迟</strong>（<strong>high-latency</strong>）的操作的 <strong>优化</strong>（<strong>optimize</strong>）需求；它的核心在于，如果在等待其它操作完成的同时，即使运行其它<strong>指令</strong>（<strong>instructions</strong>），系统也能保持稳定，那么这样做就是务实的</li></ul></li></ul><ul id="a52bca9e-4996-4a0b-a9f3-3f55aa526bce" class="bulleted-list"><li style="list-style-type:disc">更进一步，<strong>异步操作</strong>（<strong>asynchronous operations</strong>）不一定只能在计算量<strong>密集</strong>（<strong>intensive</strong>）而导致高延迟中使用；只要你不想为等待某个操作而<strong>阻塞线程执行</strong>（<strong>block a thread of execution</strong>），那么任何时候都可以使用（即可以将这个操作变为异步操作）</li></ul><div id="d5930898-0ccf-4bd1-b9e8-eec132b43bf1" class="column-list"><div id="4650500e-ae08-480c-888f-9c92e4a2f724" style="width:18.75%" class="column"><nav id="e32800f4-c826-4422-9914-dab7431bc108" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#33531799-b1dd-4063-803b-e2c56f96fa1c">1.1 同步与异步（Synchronous vs. Asynchronous JavaScript）</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#57163fb7-e0ad-4e92-928e-be7162ee6638">1.1.1 同步行为（Synchronous Behavior）</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#6132b02f-29cb-4dd8-951b-a163eedf10f6">1.1.1.1 理解同步行为</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ae6a331d-945e-4760-992d-04138a0d91bb">1.1.1.2 例子</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#3e88f46e-2b40-45cd-9841-52b5095a82e7">1.1.2 异步行为（<strong>Asynchronous Behavior</strong>）</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#502d4f4a-3063-4df0-b5c8-946dd911a721">1.1.2.1 理解异步行为</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f1d54ae5-0e44-40b4-a908-762ec80d453b">1.1.2.2 例子</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#0f8c60c5-316a-4410-ab71-efd7c3a3931a">1.2 以往的异步编程模式（Legacy Asynchronous Programming Patterns）</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#657eb0ff-3c75-4cc0-b47f-ba65566429bb">1.2.1 异步返回值（Return Asynchronous Values）</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#dca0efbf-1350-47de-8fa7-3604fce17094">1.2.2 失败处理（Handling Failure）</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#eb27e0ab-e7a3-4366-8825-b71cf18abb66">1.2.3 嵌套异步回调（Nesting Asynchronous Callbacks）</a></div></nav><p id="c1f8953f-4e17-4cd5-af3c-70e97bfdb509" class="">
</p></div><div id="8c0d5ba8-1705-492b-ad0a-d2e2e4dfd700" style="width:81.25%" class="column"><h1 id="33531799-b1dd-4063-803b-e2c56f96fa1c" class="">1.1 同步与异步（Synchronous vs. Asynchronous JavaScript）</h1><h2 id="57163fb7-e0ad-4e92-928e-be7162ee6638" class="">1.1.1 同步行为（Synchronous Behavior）</h2><h3 id="6132b02f-29cb-4dd8-951b-a163eedf10f6" class="">1.1.1.1 理解同步行为</h3><ul id="38763831-a8f0-4214-a7c4-f7fe445a6648" class="bulleted-list"><li style="list-style-type:disc"><strong><em>同步行为</em></strong>类似于内存中的顺序执行的处理器指令（<strong>sequential processor instructions</strong>）<ul id="a9c73af4-4957-4e8c-bc8c-102e78ab64a2" class="bulleted-list"><li style="list-style-type:circle">每条指令都会严格按照它们出现的顺序来执行</li></ul><ul id="9a5159f1-d11e-4c0a-9da1-c0657aeb6b89" class="bulleted-list"><li style="list-style-type:circle">每条指令之后也能立即<strong>获取</strong>(<strong>retrieving</strong>)存储在系统本地（如<strong>寄存器</strong>&lt;<strong>processeor register</strong>&gt;或系统内存）的信息</li></ul></li></ul><ul id="0c4fcb78-b54e-4ba9-9425-03aa52bb1ccb" class="bulleted-list"><li style="list-style-type:disc">同步行为这样的执行流程容易分析程序在执行到<strong>代码任意位置</strong>时（<strong>given point in code</strong>）的状态（比如变量的值）</li></ul><h3 id="ae6a331d-945e-4760-992d-04138a0d91bb" class="">1.1.1.2 例子</h3><ul id="417d41c0-2184-43a0-8c76-e8d21cbe158b" class="bulleted-list"><li style="list-style-type:disc">下述执行一个简单的数学计算属于同步行为<pre id="904361af-8693-4486-8d2d-f080759d61ad" class="code code-wrap"><code>let x = 3;
x = x + 4;</code></pre><ul id="6933f77e-fe43-4721-b4c5-70f5e3c4d118" class="bulleted-list"><li style="list-style-type:circle">在程序的每一步，都可以推断出程序的状态，因为后面的指令总是在前面的指令完成后才会执行<ul id="0875a778-cbf6-4b94-9e40-98e76d56d58a" class="bulleted-list"><li style="list-style-type:square">在<code>let x = 3;</code> 执行前，程序中没有<code>x</code> 变量</li></ul><ul id="1b8ff287-25ef-468e-a9e2-1ccc4bdac988" class="bulleted-list"><li style="list-style-type:square">在<code>let x = 3;</code> 执行后，<code>x = x + 4;</code> 执行前，程序中有一个<code>x</code> 变量保存原始值3，它可以被立即使用</li></ul><ul id="364ba07d-d6a7-4e79-a3f9-a12b5de7e8c4" class="bulleted-list"><li style="list-style-type:square">在<code>x=x+4;</code> 执行后，程序中的<code>x</code> 变量保存原始值 7，它可以被立即使用</li></ul></li></ul><ul id="3d1ec31b-8529-49bf-b531-2f41c4a3f262" class="bulleted-list"><li style="list-style-type:circle">这两行JavaScript代码对应的<strong>低级指令</strong>（<strong>low-level instructions</strong>）不难编译出（例如，从JavaScript&lt;代码&gt;到x86&lt;指令&gt;），下面三个描述对应三个指令<ul id="3bf80fcf-6b1d-45eb-b83f-39de8d21f14e" class="bulleted-list"><li style="list-style-type:square">首先，操作系统会在栈内存上分配一个存储浮点数值的空间（<code>let x = 3</code>）</li></ul><ul id="bc3abab2-433e-48d2-a796-8335d9541a9f" class="bulleted-list"><li style="list-style-type:square">然后针对这个值做一次数学运算（<code>x + 4</code>）</li></ul><ul id="37251f98-bc0a-40e8-95f1-e41396fee1db" class="bulleted-list"><li style="list-style-type:square">再把计算结果写回之前分配的内存中（<code>x = res</code> ，res就是上一个指令的运算结果）</li></ul></li></ul><ul id="2933be7b-8c85-4498-b2f4-b501166899c2" class="bulleted-list"><li style="list-style-type:circle">所有这些指令都是在单线程中顺序执行的，在低级指令程序的每个时间点（each point），有充足的工具可以确定系统状态</li></ul></li></ul><h2 id="3e88f46e-2b40-45cd-9841-52b5095a82e7" class="">1.1.2 异步行为（<strong>Asynchronous Behavior</strong>）</h2><h3 id="502d4f4a-3063-4df0-b5c8-946dd911a721" class="">1.1.2.1 理解异步行为</h3><ul id="07e2c297-4d19-4c11-8de5-ccdf59b26430" class="bulleted-list"><li style="list-style-type:disc">相对的，<strong><em>异步行为</em></strong>类似于<strong>系统中断</strong>（<strong>interrupts</strong>）,即当前进程<strong>外部的实体</strong>（<strong>entity external</strong>）可以触发（<strong>trigger</strong>）代码执行<ul id="1b78a0f0-800a-4141-8e55-60b74138619f" class="bulleted-list"><li style="list-style-type:circle">异步操作经常是必要的，因为强制进程等待一个长时间的操作通常是不可行的（同步操作必须要等）</li></ul><ul id="578358b6-1471-4734-aba9-429b1f2f8398" class="bulleted-list"><li style="list-style-type:circle">如果代码要访问一些<strong>高延迟的资源</strong>（<strong>high-latency resource</strong>），比如远程服务器（remote server）发送请求并等待响应，那么就会出现长时间的等待</li></ul></li></ul><h3 id="f1d54ae5-0e44-40b4-a908-762ec80d453b" class="">1.1.2.2 例子</h3><ul id="16e099ec-6335-4eda-b88f-a0182d6aee8f" class="bulleted-list"><li style="list-style-type:disc">JavaScript中异步操作的例子可以是在<strong>定时回调</strong>（<strong>timeout</strong>）中执行一次简单的<strong>数学计算</strong>（<strong>arithmetic operation</strong>）<pre id="1e160633-1f91-4622-96f3-612ac38da17b" class="code"><code>let x = 3;
setTimeout(() =&gt; x = x + 4, 1000); </code></pre><ul id="a4cfd39a-178d-44e1-ae02-0b36ea53e114" class="bulleted-list"><li style="list-style-type:circle">这段程序与<a href="1%20%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%EF%BC%88Asynchronous%20Programming%EF%BC%89.html">同步代码</a>执行的任务一样，都是把两个数加在一起，但这一次<strong>执行线程</strong>（<strong>thread of execution</strong>）不知道x值何时会改变，因为这取决于回调何时从<strong>消息队列</strong>（<strong>message queue</strong>）出列并执行</li></ul><ul id="95efd0e4-44f3-404d-9e8c-fd8adfd394d1" class="bulleted-list"><li style="list-style-type:circle">异步代码不容易推断<ul id="70f0f195-4ce0-49fe-aa81-c52481a07b66" class="bulleted-list"><li style="list-style-type:square">虽然这个例子对应的<strong>低级代码</strong>（<strong>low-level instructions</strong>）最终和前面的例子没有什么区别，但<mark class="highlight-blue"><a href="1%20%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%EF%BC%88Asynchronous%20Programming%EF%BC%89.html">第二个</a></mark><mark class="highlight-purple"><a href="1%20%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%EF%BC%88Asynchronous%20Programming%EF%BC%89.html">指令块</a></mark>（<strong>chunk of instructions</strong>， 加操作及赋值操作）是由系统计时器触发的，这会生成一个<strong>入队执行</strong>（<strong>enqueue execution</strong>）的<strong>中断</strong>（<strong>interrupt</strong>）</li></ul><ul id="70c7b5e1-f76c-41dd-a2cd-c1df0fc8f928" class="bulleted-list"><li style="list-style-type:square">到底什么时候会触发这个中断，这对JavaScript运行时来说是一个黑盒，因此实际上无法预知（尽管可以保证这发生在<strong>当前线程的同步代码</strong>（<strong>current thread of synchronous</strong>）执行完成<strong>之后</strong>，否则回调都没有机会出列被执行）</li></ul><ul id="339208ea-080e-4419-8af5-0d1213c533dd" class="bulleted-list"><li style="list-style-type:square">总之，在<strong>排定回调</strong>（<strong>scheduled callback</strong>）以后基本没办法知道系统状态何时变化</li></ul></li></ul></li></ul><ul id="8f765cf5-6be2-4a44-a292-726c1e1266fd" class="bulleted-list"><li style="list-style-type:disc">为了让后续代码能够使用x，异步执行的函数需要在更新x的值以后通知其他代码，如果程序不需要这个值，那么就只管继续执行，不必等待这个结果</li></ul><ul id="7d6b29c2-12de-49ce-904a-dbb5661324f0" class="bulleted-list"><li style="list-style-type:disc">设计一个能够知道x什么时候可以读取的系统是非常难的，JavaScript在实现这样的系统的过程中也经历了几次<strong>迭代</strong>（<strong>iterations</strong>）</li></ul><h1 id="0f8c60c5-316a-4410-ab71-efd7c3a3931a" class="">1.2 以往的异步编程模式（Legacy Asynchronous Programming Patterns）</h1><ul id="e1ec3e08-aaf6-4482-8c37-0a972ad24acb" class="bulleted-list"><li style="list-style-type:disc">异步行为是JavaScript的基础，但以前的实现不理想</li></ul><ul id="b0e0c332-aeed-41de-81d1-475dd91cbb52" class="bulleted-list"><li style="list-style-type:disc">在早期的JavaScript中，只支持定义<strong>回调函数</strong>（<strong>callback function</strong>）来表明异步操作完成，<strong>串联</strong>（<strong>Serializing</strong>）多个异步操作是一个常见的问题，通常需要深度<strong>嵌套的回调函数</strong>（<strong>nested callback functions</strong>）来解决——俗称“回调地狱（callback hell）”<ul id="e35f7464-4fb7-4099-9ca2-54606d215647" class="bulleted-list"><li style="list-style-type:circle">异步编程的关键在于异步操作何时执行完毕</li></ul><ul id="13cf31ff-1c0d-49e4-8dea-bef6b7c5f8a9" class="bulleted-list"><li style="list-style-type:circle">之前的异步编程模式使用回调函数表明异步操作完成</li></ul></li></ul><ul id="41f20606-85d3-4bc3-9616-7bbc2912955d" class="bulleted-list"><li style="list-style-type:disc">假设有如下的异步函数，使用了setTimeout在1秒后执行某些操作<pre id="4b6a0baa-bc1e-47af-ba71-85694340cfb2" class="code code-wrap"><code>// setTimeout是一个异步函数
function double(value) {
  setTimeout(() =&gt; setTimeout(console.log, 0, value * 2), 1000);
}

double(3); // 大约1000ms后执行</code></pre><ul id="e7fa8dea-3962-482f-a07a-b74a5d41d71a" class="bulleted-list"><li style="list-style-type:circle"><code>double</code> 是一个异步函数，关键理解为什么说它是一个异步函数</li></ul><ul id="8a24f942-6eed-4cd3-828b-0a1cddcc930f" class="bulleted-list"><li style="list-style-type:circle"><code>setTimeout</code>可以定义一个在指定时间之后会被调用执行的回调函数</li></ul><ul id="6e513037-f0b3-4a7e-89d6-dd215fa7aaf6" class="bulleted-list"><li style="list-style-type:circle">对于这个例子而言，1000毫秒后，JavaScript<strong>运行时</strong>（<strong>runtime</strong>）会把回调函数推到JavaScript的消息队列上去等待执行；推到队列后，回调什么时候出列被执行对JavaScript代码就完全不可见了</li></ul><ul id="f46c3ef5-5e06-4ab6-9ac8-73dc2accd41c" class="bulleted-list"><li style="list-style-type:circle"><code>double()</code> 函数在<code>setTimeout</code>成功<strong>调度</strong>（<strong>scheduling， </strong>这里指把回调函数推到消息队列）异步操作之后会立即<strong>退出</strong>（<strong>exits</strong>）</li></ul></li></ul><h2 id="657eb0ff-3c75-4cc0-b47f-ba65566429bb" class="">1.2.1 异步返回值（Return Asynchronous Values）</h2><ul id="4e22ac11-7d2d-4378-b011-24b3fcf3238c" class="bulleted-list"><li style="list-style-type:disc">假设<code>setTimeout</code> 操作会返回一个有用的值，一个需要考虑的问题是如何把这个值传递给需要它的地方<ul id="4bd55333-832c-4a75-b646-804640ca85ce" class="bulleted-list"><li style="list-style-type:circle">广泛接受的一个<strong>策略</strong>（<strong>strategy</strong>）是给异步操作提供一个回调函数</li></ul><ul id="f9c59526-2c41-4055-8060-4f626e7e0c50" class="bulleted-list"><li style="list-style-type:circle">这个回调函数中包含要使用<strong>异步返回值</strong>的代码（作为回调的参数）</li></ul></li></ul><ul id="6a6c5a2e-2012-45c4-93ee-fabd66f3f5aa" class="bulleted-list"><li style="list-style-type:disc">一个使用<code>setTimeout</code> 模拟的传递异步操作返回值的函数<pre id="9e709df6-a398-4785-a867-c236d280e5ef" class="code code-wrap"><code>function asyncGetSomething(requestParameters, callback) {
  setTimeout(() =&gt; {
    // 通过requestParameters异步操作获取到一些结果 这里只是简单模拟
    let res = requestParameters * 2;
    // 将结果传递给回调函数
    callback(res);
  }, 1000);
}</code></pre><ul id="dcef5ed1-0206-4e48-9d0e-a039274508a7" class="bulleted-list"><li style="list-style-type:circle"><code>asyncGetSomething</code> 是一个异步函数，给它传递<code>requestParameters</code> （异步请求参数）和<code>callback</code> （请求完毕回调函数）</li></ul><ul id="cca8d553-cce8-4767-91ba-6673c7e25ea0" class="bulleted-list"><li style="list-style-type:circle">使用<code>setTimeout</code> 函数模拟请求过程（在1秒后请求完成），<code>res</code> 是异步操作完毕后获得的请求响应，然后调用回调函数，把异步操作结果<code>res</code> 作为异步返回值传递，表示异步操作和后续的通知执行代码执行完成</li></ul></li></ul><ul id="d8f9426b-18f1-4899-9687-bc9b1a3c0d1a" class="bulleted-list"><li style="list-style-type:disc">之前的<code>double</code> 异步函数依照此方法变为<pre id="282f9089-1a3e-4405-8e27-12ece8c777e4" class="code"><code>function double2(value, callback) {
  console.log(callback);
  setTimeout(() =&gt; callback(value * 2), 1000);
}
double2(3, (x) =&gt; console.log(`I was given: ${x}`)); // I was given: 6</code></pre><ul id="653b5578-1014-4352-8bdb-3ab96bace9c8" class="bulleted-list"><li style="list-style-type:circle">这里<code>setTimeout</code>调用（<strong>invocation</strong>）告诉JavaScript运行时在1000ms之后把一个函数推到消息队列上</li></ul><ul id="ebd3c188-7996-4c2b-8a4f-90b96794cc42" class="bulleted-list"><li style="list-style-type:circle">这个函数（callback）会由<strong>运行时</strong>（<strong>runtime</strong>）负责异步调度执行，而位于函数闭包中的回调及其参数在异步执行时仍是可用的</li></ul></li></ul><h2 id="dca0efbf-1350-47de-8fa7-3604fce17094" class="">1.2.2 失败处理（Handling Failure）</h2><ul id="0d2a44d9-29a2-4611-a191-3bdcf734c8b8" class="bulleted-list"><li style="list-style-type:disc">异步操作的失败处理在<strong>回调模型</strong>（<strong>callback model</strong>）中也要考虑，因此就有了成功回调和失败回调，一般形式是通过<code>try…catch</code> 语句捕获可能的异步操作异常<pre id="81671e13-2f98-443e-ab1e-199d53a2cf84" class="code"><code>function double(value, success, failure) {
  setTimeout(() =&gt; {
    try {
      if (typeof value !== &quot;number&quot;) {
        throw &quot;Must provide number as first arguments&quot;;
      }
      success(2 * value);
    } catch (error) {
      failure(error);
    }
  }, 1000);
}

const successCallback = (x) =&gt; console.log(`Success: ${x}`);
const failureCallback = (e) =&gt; console.log(`Failure: ${e}`);

double(3, successCallback, failureCallback); // Success: 6
double(&quot;2&quot;, successCallback, failureCallback); // Failure: Must provide number as first arguments</code></pre><ul id="d71f4dc6-a739-45a9-82ce-63aa607d7a1f" class="bulleted-list"><li style="list-style-type:circle">失败处理在以前的异步模式中也使用<strong>回调模型</strong>：将失败处理的函数作为一个回调传递给异步操作，异步操作捕获到错误时调用这个失败处理的回调函数，如果异步操作正常获取到想要的值，就可以像之前那样传递异步返回值并调用成功的回调函数</li></ul></li></ul><ul id="9787fac4-9902-4f3d-890c-f847723b847d" class="bulleted-list"><li style="list-style-type:disc">这种模式已经<strong>不可取了</strong>（<strong>undesirable</strong>），因为必须在初始化异步操作时定义回调，异步函数的返回值只在<strong>短时间内存在</strong>（<strong>transient</strong>）,只有预备好将这个短时间内存在的值作为参数的回调才能接收到它</li></ul><h2 id="eb27e0ab-e7a3-4366-8825-b71cf18abb66" class="">1.2.3 嵌套异步回调（Nesting Asynchronous Callbacks）</h2><ul id="d889665e-735f-4bad-966f-2523cdd6639a" class="bulleted-list"><li style="list-style-type:disc">如果异步返回值又依赖另一个异步返回值，那么回调的情况还会进一步边复杂。假设有异步操作A和异步操作B，异步操作B需要将异步操作A的返回值作为参数以获取异步操作B的返回值，所以情况就变成了A ⇒ A的异步返回值 ⇒ B ⇒ B的异步返回值</li></ul><ul id="f0421354-080a-4206-9c15-26eefa8b78bf" class="bulleted-list"><li style="list-style-type:disc">实现这种依赖需要嵌套回调，将A的返回值传递给异步操作B的回调函数<pre id="fb208901-9b81-4ec2-999f-4d3f08456efd" class="code"><code>function double(value, success, failure) {
  setTimeout(() =&gt; {
    try {
      if (typeof value !== &quot;number&quot;) {
        throw &quot;Must provide number as first argument&quot;;
      }
      success(2 * value);
    } catch (error) {
      failure(error);
    }
  }, 1000);
}

const successCallback = (x) =&gt; {
  double(x, (y) =&gt; console.log(`Success: ${y}`));
};

const failureCallback = (e) =&gt; console.log(`Failure: ${e}`);

double(3, successCallback, failureCallback); // Success: 12 (等待约2秒)</code></pre><ul id="78732095-1b1f-4cdb-b72b-76b33d209943" class="bulleted-list"><li style="list-style-type:circle">这里的<code>successCallback</code> 就是异步函数B，它依赖<code>double()</code> 异步操作完毕后执行<code>success()</code> 回调传递值才能执行，且<code>successCallback</code> 被调用也是异步操作，它再次调用<code>double()</code> （另外一次调用）获取第二个异步返回值（12）</li></ul></li></ul><ul id="08e1295e-0c79-4541-8aaf-4cc00a03aba4" class="bulleted-list"><li style="list-style-type:disc">显然，随着代码越来越复杂，回调策略<strong>是不具有扩展性的</strong>（<strong>not</strong> <strong>scale</strong>）。“回调地狱”这个称号可谓实至名归，嵌套回调的代码维护起来就是噩梦</li></ul><p id="6868c990-b3fe-4a7f-8b5c-ad8bd98d2472" class="">
</p></div></div></div></article></body></html>