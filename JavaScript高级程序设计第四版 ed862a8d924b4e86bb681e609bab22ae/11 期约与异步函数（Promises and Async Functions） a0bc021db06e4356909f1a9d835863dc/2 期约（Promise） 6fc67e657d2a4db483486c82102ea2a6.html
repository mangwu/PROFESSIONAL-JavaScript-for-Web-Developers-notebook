<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>2. æœŸçº¦ï¼ˆPromiseï¼‰</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="6fc67e65-7d2a-4db4-8348-6c82102ea2a6" class="page sans"><header><img class="page-cover-image" src="https://www.notion.so/images/page-cover/webb3.jpg" style="object-position:center 50%"/><div class="page-header-icon page-header-icon-with-cover"><span class="icon">â›µ</span></div><h1 class="page-title">2. æœŸçº¦ï¼ˆPromiseï¼‰</h1></header><div class="page-body"><p id="b0037194-d41b-455d-a07f-30cc9bc5122b" class="">
</p><blockquote id="0592bcd5-6a73-4152-99c2-7ad3b6a732a2" class="">A â€œpromiseâ€ is a surrogate entity that acts as a stand-in for a result that does not yet exist. â€”ã€ŠJavaScripté«˜çº§ç¨‹åºè®¾è®¡ï¼ˆç¬¬4ç‰ˆï¼‰ã€‹</blockquote><p id="9744be8c-f2a9-43bd-aebd-64b79275d5c3" class=""><strong>ä¸€ä¸ªâ€œpromiseâ€å°±æ˜¯ä¸€ä¸ªå°šä¸å­˜åœ¨çš„ç»“æœçš„ä¸€ä¸ªä»£ç†å®ä½“</strong>ï¼ˆæ›¿èº«ï¼‰ã€‚</p><p id="de9d2431-5b91-4713-8dfd-6c0060edf776" class="">â€œpromiseâ€œè¿™ä¸ªåå­—æœ€æ—©ç”±Daniel Friedmanå’ŒDavid Wiseåœ¨ä»–ä»¬äº1976å¹´å‘è¡¨çš„è®ºæ–‡â€The Impact of Applicative Programming on Multiprocessingâ€â€œä¸­æå‡ºæ¥çš„ï¼Œç›´åˆ°åå‡ å¹´åï¼ŒBarbara Liskovå’ŒLiuba Shriraåœ¨1988å¹´å‘è¡¨è®ºæ–‡â€œPromises: Linguistic Support for Efficient Asynchronous Procedure Calls in Distributed Systemsâ€,è¿™ä¸ªæ¦‚å¿µæ‰çœŸæ­£ç¡®ç«‹ä¸‹æ¥</p><p id="fcafd371-328e-47f6-8364-68d963869253" class="">åŒä¸€æ—¶æœŸçš„è®¡ç®—æœºç§‘å­¦å®¶è¿˜ä½¿ç”¨äº†â€œeventualâ€ï¼Œâ€œfutureâ€ï¼Œâ€œdelayâ€ï¼Œâ€œdeferredâ€ç­‰æœ¯è¯­æŒ‡ä»£åŒæ ·çš„æ¦‚å¿µï¼Œæ‰€æœ‰<strong>è¿™äº›æ¦‚å¿µæè¿°çš„éƒ½æ˜¯ä¸€ç§å¼‚æ­¥ç¨‹åºæ‰§è¡Œçš„æœºåˆ¶</strong></p><div id="88c66758-be83-4676-8679-89d98600c1d6" class="column-list"><div id="c9108aa6-8347-43e1-bb20-f145f308519c" style="width:18.75%" class="column"><nav id="5f341cf8-4415-43b6-a700-3ff5e68a0ab1" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#580342ac-b881-4567-b386-c1a654f1e523">2.1 Promises/A+è§„èŒƒï¼ˆThe Promises/A+ Specificationï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#e7b50aec-52cd-416b-9eb0-db79fad9121b">2.2 PromiseåŸºç¡€ï¼ˆBasicsï¼‰ </a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#3ad6115b-38c4-465f-9cf4-7b1453c177cb">2.2.1 æœŸçº¦çŠ¶æ€æœºï¼ˆThe Promise State Machineï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#01f250a2-58ca-4aa5-ad33-668cc273124c">2.2.2 è§£å†³å€¼ã€æ‹’ç»ç†ç”±åŠæœŸçº¦ç”¨ä¾‹ï¼ˆResovled Values, Rejection Reasons and Utility of Promisesï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#2df5d17d-7dac-4ec7-b215-6852accf723f">2.2.3 é€šè¿‡æ‰§è¡Œå‡½æ•°æ§åˆ¶æœŸçº¦çŠ¶æ€ï¼ˆControlling Promise State with the Executorï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#4681fba3-7073-4104-92ae-8f3b85428365">2.2.4 Promise.resolve() ï¼ˆPromise Casting with Promise.resolve()ï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0bdbfe62-4571-44cd-80cb-0ef7e38db850">2.2.5 Promise.reject()ï¼ˆPromise Rejection with Promise.reject()ï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#92264bf6-6db3-4c20-8f01-c05dd2009c13">2.2.5 åŒæ­¥/å¼‚æ­¥æ‰§è¡Œçš„äºŒå…ƒæ€§ï¼ˆSynchronous/Asynchronous Execution Dualityï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#4a9accce-259e-4bf8-aa66-c97f049f17b9">2.3 æœŸçº¦çš„å®ä¾‹æ–¹æ³•ï¼ˆPromise Instance Methodï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#f43a3fb8-2648-4556-8ccf-c6fb6149c2a6">2.3.1 å®ç°<em>Thenable</em>æ¥å£ï¼ˆImplementing The <em>Thenable </em>Interfaceï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#74cb9a8d-cbb1-4fc0-aa2c-dff9a7b25ab7">2.3.2 Promise.prototype.then()</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#fa59b667-0153-421d-8205-f7ea3ef207b0">2.3.3 <code>Promise.prototype.catch()</code></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#7271abf5-cd74-4d3d-97dd-033d086d3c62">2.3.4 <code>Promise.prototype.finally()</code></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#d077e0ba-2888-4296-b747-d1e57fe1f069">2.3.5 éé‡å…¥æœŸçº¦æ–¹æ³•ï¼ˆNon-Reentrant Promise Methodsï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#75f01ae3-df67-4ef6-9f01-329bdeae4845">2.3.6 ä¸´è¿‘å¤„ç†ç¨‹åºçš„æ‰§è¡Œé¡ºåºï¼ˆSibling Handler Order of Executionï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#82f1a145-3849-48bb-859d-279f3a4f1479">2.3.7 ä¼ é€’è§£å†³å€¼å’Œæ‹’ç»ç†ç”±ï¼ˆResolved Value and Rejected Reason Passingï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#f50719a8-e766-40e1-ba50-9aeb861fd34b">2.3.8 æ‹’ç»æœŸçº¦ä¸æ‹’ç»é”™è¯¯å¤„ç†ï¼ˆRejecting Promises and Rejection Error Handlingï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#03d69894-3966-448e-b166-eb88fbde5879">2.3.8.1 æ‹’ç»æœŸçº¦</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f766aa03-bc39-4acb-90a9-a7d80ed0b8b4">2.3.8.2 æ‹’ç»é”™è¯¯å¤„ç†</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#53dfa334-9baf-47ad-a9a4-df20b66ea1e8">2.4 æœŸçº¦è¿é”ä¸æœŸçº¦åˆæˆï¼ˆPromise Chaining and Compositionï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#15f8e6aa-a53a-49d7-9c7b-ab0105cb262d">2.4.1 Promise Chaining</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#e68a2296-1128-4fc4-b947-6e8f2d8a3d7f">2.4.2 æœŸçº¦å›¾ï¼ˆPromise Graphsï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#43918a86-9bff-49c9-b96b-17a45dd565e6">2.4.3 Promise.all()å’ŒPromise.race() ï¼ˆParallel Promise Composition with Promise.all() and Promise.race() ï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#3b1829ad-27db-49b0-90bb-b4bd4bedca5e">2.4.3.1 Promise.all()</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#a87bbbf7-21ff-419a-9ed9-b1f1830b3d4b">2.4.3.2 Promise.race()</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#87a31ff9-2c1e-4bda-bd44-c4024236961a">2.4.3 ä¸²è¡ŒæœŸçº¦åˆæˆï¼ˆSerial Promise Compositionï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#82474ab2-0f12-4cf4-b2e2-217206868ad9">2.5 æœŸçº¦æ‰©å±•ï¼ˆPromise Extensionsï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#936dd2b7-0e46-4fc0-ba08-afa3c9273c6c">2.5.1 æœŸçº¦å–æ¶ˆï¼ˆPromise Cancelingï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#744f8478-b926-4c5e-9361-190dee459411">2.5.2 æœŸçº¦è¿›åº¦é€šçŸ¥ï¼ˆPromise Progress Notificationsï¼‰</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#a4e4bc09-2d60-443c-af07-7a2a45e35c01">2.6 ç°ä»£ECMAScriptå…³äºPromiseæ–°å¢çš„ç‰¹æ€§</a></div></nav><p id="80cea2e3-422b-49b2-8ca7-f5855c0dcf9b" class="">
</p></div><div id="dd8232d4-9dad-43f4-88eb-87e0bfe25c7a" style="width:81.25%" class="column"><h1 id="580342ac-b881-4567-b386-c1a654f1e523" class="">2.1 Promises/A+è§„èŒƒï¼ˆThe Promises/A+ Specificationï¼‰</h1><ul id="62aec8ec-7eb2-4977-857a-73e16ae8b68d" class="bulleted-list"><li style="list-style-type:disc">æ—©æœŸçš„promisesæœºåˆ¶åœ¨jQueryå’ŒDojoä¸­ä»¥Deferred APIçš„å½¢å¼å‡ºç°ï¼Œåˆ°äº†2010å¹´ï¼ŒCommonJSé¡¹ç›®å®ç°çš„Promises/Aè§„èŒƒæ—¥ç›Šæµè¡Œèµ·æ¥</li></ul><ul id="35747977-9862-4a53-a9e3-0ca0a08ef102" class="bulleted-list"><li style="list-style-type:disc">Qå’ŒBluebirdç­‰ç¬¬ä¸‰æ–¹JavaScript promisesåº“ä¹Ÿè¶Šæ¥è¶Šå¾—åˆ°ç¤¾åŒºè®¤å¯ï¼Œè™½ç„¶è¿™äº›åº“çš„å®ç°å¤šå°‘éƒ½æœ‰äº›ä¸åŒ</li></ul><ul id="e9ab4ea6-fb07-4c3c-bb98-de11622e1b46" class="bulleted-list"><li style="list-style-type:disc">ä¸ºå¼¥åˆç°æœ‰å®ç°ä¹‹é—´çš„å·®å¼‚ï¼Œ2012å¹´Promises/A+ç»„ç»‡<strong>åˆ†å‰äº†</strong>ï¼ˆ<strong>forked</strong>ï¼‰CommonJSçš„Promises/A<strong>å»ºè®®</strong>ï¼ˆ<strong>proposal</strong>ï¼‰ï¼Œå¹¶ä»¥ç›¸åŒçš„åå­—æŒ‡å®šäº†Promises/A+è§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒæœ€ç»ˆæˆä¸ºäº†ECMAScript6è§„èŒƒå®ç°çš„èŒƒæœ¬ </li></ul><hr id="e867b036-28ce-4765-a1ac-fb5d4d31153b"/><ul id="a4957a43-d403-43c7-a7bf-7b9a3b65c394" class="bulleted-list"><li style="list-style-type:disc">ECMAScript 6 å¢åŠ äº†å¯¹Promises/A+è§„èŒƒçš„å®Œå–„æ”¯æŒï¼Œå°±å³<code>Promise</code>ç±»å‹ã€‚ä¸€ç»æ¨å‡ºï¼Œ<code>Promise</code> å°±å¤§å—æ¬¢è¿ï¼Œæˆä¸ºäº†<strong>ä¸»å¯¼æ€§çš„å¼‚æ­¥ç¼–ç¨‹æœºåˆ¶</strong></li></ul><ul id="2260fc83-c142-4e3d-bd57-c445748f9814" class="bulleted-list"><li style="list-style-type:disc">æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒES6 Promises/A+è§„èŒƒï¼Œå¾ˆå¤šå…¶ä»–æµè§ˆå™¨APIï¼ˆå¦‚fetch()å’ŒBattery Status APIï¼‰ä¹Ÿä»¥<code>Promise</code>ä¸ºåŸºç¡€</li></ul><h1 id="e7b50aec-52cd-416b-9eb0-db79fad9121b" class="">2.2 PromiseåŸºç¡€ï¼ˆBasicsï¼‰ </h1><ul id="1279f3fe-865f-4dad-9db0-cbc1bc0807d7" class="bulleted-list"><li style="list-style-type:disc">ECMAScript 6 æ–°å¢çš„å¼•ç”¨ç±»å‹<code>Promise</code> ï¼Œå¯ä»¥é€šè¿‡<code>new</code> æ“ä½œç¬¦æ¥å®ä¾‹åŒ–ã€‚</li></ul><ul id="51b36d7e-33e3-4f8c-b3d8-e97bd66dfdad" class="bulleted-list"><li style="list-style-type:disc">åˆ›å»ºæ–°<code>Promise</code>å¯¹è±¡æ—¶éœ€è¦ä¼ å…¥<strong>æ‰§è¡Œå™¨</strong>ï¼ˆ<strong>executor</strong>ï¼‰å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä¸€ä¸ªç®€å•çš„ä¾‹å­ä½¿ç”¨ç©ºå‡½æ•°å¯¹è±¡å½“ä½œæ‰§è¡Œå™¨åº”ä»˜è§£é‡Šå™¨<pre id="33ea9764-1bee-4f9a-97e2-486a015f9af5" class="code"><code>let promise = new Promise(() =&gt; {});
setTimeout(console.log, 0, promise); // Promise { &lt;pending&gt; }</code></pre><ul id="d9fff93d-6aee-480c-9ccf-0aeb513b6954" class="bulleted-list"><li style="list-style-type:circle">åº”ä»˜è§£é‡Šå™¨çš„æ„æ€å°±æ˜¯åœ¨åˆ›å»º<code>Promise</code> å¯¹è±¡æ—¶å¿…é¡»æä¾›æ‰§è¡Œå™¨å‡½æ•°ï¼Œå¦åˆ™ä¼šæŠ›å‡ºè¯­æ³•é”™è¯¯</li></ul><ul id="4a19c4a5-f9e0-442a-a0d1-c4abadd95d8d" class="bulleted-list"><li style="list-style-type:circle">è¿™é‡Œ<code>setTimeout</code> æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œï¼Œå¯¹æ–°åˆ›å»ºçš„<code>Promise</code>å¯¹è±¡è¿›è¡Œäº†æ‰“å°</li></ul></li></ul><h2 id="3ad6115b-38c4-465f-9cf4-7b1453c177cb" class="">2.2.1 æœŸçº¦çŠ¶æ€æœºï¼ˆThe Promise State Machineï¼‰</h2><ul id="4f431eff-a436-402e-8191-df1965def5b3" class="bulleted-list"><li style="list-style-type:disc">åœ¨æŠŠä¸€ä¸ª<code>Promise</code>å®ä¾‹ä¼ é€’ç»™<code>console.log()</code> æ—¶ï¼Œæ§åˆ¶å°è¾“å‡ºï¼ˆå¯èƒ½å› æµè§ˆå™¨ä¸åŒè€Œæœ‰æ‰€å·®å¼‚ï¼‰è¡¨æ˜è¯¥å®ä¾‹å¤„äº<strong>å¾…å®š</strong>ï¼ˆ<strong>pending</strong>ï¼‰çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>Promise</code> å®ä¾‹æ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„å¯¹è±¡ï¼Œå®ƒå¯èƒ½å¤„äºå¦‚ä¸‹3ç§çŠ¶æ€ä¹‹ä¸€ï¼š<ul id="b0459c20-508c-4061-bca5-463ee0a854fb" class="to-do-list"><li><div class="checkbox checkbox-off"></div> <span class="to-do-children-unchecked"><strong><em>Pending </em></strong><em>ï¼ˆå¾…å®šï¼‰</em></span></li></ul><ul id="3199516c-704e-4a63-a6a8-de860ce70ea3" class="to-do-list"><li><div class="checkbox checkbox-off"></div> <span class="to-do-children-unchecked"><strong><em>Fulfilled</em></strong><em> (å…‘ç°ï¼Œæœ‰æ—¶å€™ä¹Ÿç§°ä¸º</em><strong><em>resolved&lt;è§£å†³&gt;</em></strong><em>)</em></span></li></ul><ul id="41e74b97-0e3b-4d6c-98b0-44ea76157d08" class="to-do-list"><li><div class="checkbox checkbox-off"></div> <span class="to-do-children-unchecked"><strong><em>Rejected </em></strong><em>ï¼ˆæ‹’ç»ï¼‰</em></span></li></ul></li></ul><p id="4c8dfa04-e401-43b8-909a-8e7d2f0b9467" class=""><strong>Pending Fulfilled Rejected</strong></p><ul id="9fe2ce9b-f7d2-416b-84dd-d947fc7b0959" class="bulleted-list"><li style="list-style-type:disc"><strong>Pending&lt;å¾…å®š&gt;</strong>çŠ¶æ€æ˜¯<code>Promise</code> å®ä¾‹<strong>æœ€åˆå§‹</strong>ï¼ˆ<strong>initial</strong>ï¼‰çš„çŠ¶æ€<ul id="f697bfab-ccd1-4b29-97f2-6023626ef116" class="bulleted-list"><li style="list-style-type:circle">åœ¨<strong>pending&lt;å¾…å®š&gt;</strong>çŠ¶æ€ä¸‹ï¼Œ<code>Promise</code>å®ä¾‹å¯ä»¥<strong>è½å®š</strong>ï¼ˆ<strong>settled</strong>ï¼‰<strong>è½¬åŒ–ä¸º</strong>ï¼ˆ<strong>transitioning to</strong>ï¼‰ä»£è¡¨æˆåŠŸçš„<strong>fulfilled&lt;å…‘ç°&gt;</strong>çŠ¶æ€</li></ul><ul id="92529603-e300-4e7c-be02-791d58733085" class="bulleted-list"><li style="list-style-type:circle">ä¹Ÿå¯ä»¥è½å®šä¸ºä»£è¡¨å¤±è´¥çš„<strong>rejected&lt;æ‹’ç»&gt;çŠ¶æ€</strong></li></ul></li></ul><ul id="e5b78405-bbc5-47b0-b84c-86927e394c84" class="bulleted-list"><li style="list-style-type:disc">æ— è®ºè½å®šæˆå“ªç§çŠ¶æ€éƒ½æ˜¯ä¸å¯é€†çš„ï¼Œåªè¦ä»<strong>pending&lt;å¾…å®š&gt;</strong>è½¬æ¢ä¸º<strong>fulfilled&lt;å…‘ç°&gt;</strong>æˆ–<strong>rejected</strong>&lt;<strong>æ‹’ç»</strong>&gt;ï¼Œ<code>Promise</code> å®ä¾‹çš„çŠ¶æ€å°±ä¸ä¼šå†æ”¹å˜</li></ul><ul id="e010b9eb-8225-4637-becc-02995a0b0524" class="bulleted-list"><li style="list-style-type:disc">å¹¶ä¸”ï¼Œä¸èƒ½ä¿è¯<code>Promise</code> å®ä¾‹ä¼šè„±ç¦»<strong>pending</strong>&lt;<strong>å¾…å®š</strong>&gt;çŠ¶æ€ï¼ˆå³ä¸€ä¸ªæœŸçº¦å¯¹è±¡å¯èƒ½ä¸€ç›´å¤„äºå¾…å®šçŠ¶æ€ï¼‰</li></ul><ul id="2297376f-2138-4943-be7c-fa7a19692f5f" class="bulleted-list"><li style="list-style-type:disc">æ‰€ä»¥ï¼Œæ— è®º<code>Promise</code> å¯¹è±¡æ˜¯æˆåŠŸè§£å†³ï¼ˆ<strong>resolveï¼Œ </strong>æŒ‡è¿›å…¥å…‘ç°çŠ¶æ€ï¼‰ï¼Œè¿˜æ˜¯æ‹’ç»ï¼ˆ<strong>reject</strong>ï¼ŒæŒ‡è¿›å…¥æ‹’ç»çŠ¶æ€ï¼‰ï¼Œå¼‚æˆ–æ˜¯æ°¸è¿œå¤„äº<strong>Pending</strong>&lt;<strong>å¾…å®š</strong>&gt;çŠ¶æ€,éƒ½åº”è¯¥ç»„ç»‡åˆç†çš„ä»£ç ç»“æ„ï¼Œé¿å…çŠ¶æ€è½¬æ¢æ··ä¹±</li></ul><p id="29505bd2-180c-4b11-8ca5-c9ce7241ea5d" class=""><strong>State features</strong></p><ul id="93adeb75-fd6d-4d0f-bc35-27ede28cb0af" class="bulleted-list"><li style="list-style-type:disc"><code>Promise</code>å¯¹è±¡çš„çŠ¶æ€æ˜¯<strong>ç§æœ‰ï¼ˆPrivateï¼‰</strong>çš„ï¼Œä¸èƒ½ç›´æ¥é€šè¿‡JavaScriptæ£€æµ‹åˆ°<ul id="a0b9580b-ef5d-45ea-9048-5d077feafbbc" class="bulleted-list"><li style="list-style-type:circle">ä¸»è¦æ˜¯<strong>é¿å…</strong>æ ¹æ®è¯»å–åˆ°çš„<code>Promise</code> å®ä¾‹çŠ¶æ€ä»¥åŒæ­¥æ–¹å¼å¤„ç†ï¼ˆsynchronous programmatic handlingï¼‰Promiseå®ä¾‹</li></ul></li></ul><ul id="5a842472-74d8-4a3b-992c-6f69a398d568" class="bulleted-list"><li style="list-style-type:disc"><code>Promise</code> å¯¹è±¡çš„çŠ¶æ€ä¸èƒ½è¢«å¤–éƒ¨JavaScriptä»£ç ä¿®æ”¹<ul id="ca71a56d-e24c-4a82-a92d-5ed0a7f70938" class="bulleted-list"><li style="list-style-type:circle">ä¸ä¸èƒ½è¯»å–è¯¥çŠ¶æ€çš„åŸå› ä¸€è‡´ï¼šPromiseæ•…æ„å°†å¼‚æ­¥è¡Œä¸º<strong>å°è£…</strong>ï¼ˆ<strong>encapsulates</strong>ï¼‰èµ·æ¥ï¼Œä»è€Œéš”ç¦»å¤–éƒ¨çš„åŒæ­¥ä»£ç </li></ul></li></ul><h2 id="01f250a2-58ca-4aa5-ad33-668cc273124c" class="">2.2.2 è§£å†³å€¼ã€æ‹’ç»ç†ç”±åŠæœŸçº¦ç”¨ä¾‹ï¼ˆResovled Values, Rejection Reasons and Utility of Promisesï¼‰</h2><ul id="6d7ed740-7455-4979-a12e-f1a11da01819" class="bulleted-list"><li style="list-style-type:disc">Promiseç»“æ„æœ‰ä¸¤å¤§ç”¨é€”<ul id="dba73758-43ed-47c9-9271-dc51b45cbb9e" class="bulleted-list"><li style="list-style-type:circle">é¦–å…ˆæ˜¯<strong>æŠ½è±¡åœ°</strong>ï¼ˆ<strong>abstractly</strong>ï¼‰è¡¨ç¤ºä¸€ä¸ª<strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼ˆ<strong>asynchronous execution</strong>ï¼‰<ul id="5df1d35d-e4dc-4fc5-b07d-8f64b5b841b3" class="bulleted-list"><li style="list-style-type:square">ä¸€ä¸ªpromiseçš„çŠ¶æ€èƒ½è¡¨ç¤ºå®ƒæ˜¯å¦å®Œæˆæ‰§è¡Œ</li></ul><ul id="b493074b-022b-4e31-81ae-1f223c095a80" class="bulleted-list"><li style="list-style-type:square"><em><strong>Pending</strong></em>&lt;<strong>å¾…å®š</strong>&gt;çŠ¶æ€è¡¨ç¤ºæ‰§è¡Œè¿˜æœªå¼€å§‹æˆ–æ­£åœ¨æ‰§è¡Œä¸­</li></ul><ul id="56d95498-dd6f-4216-af31-65ba527508c1" class="bulleted-list"><li style="list-style-type:square"><em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;çŠ¶æ€è¡¨ç¤ºæ‰§è¡Œå·²ç»æˆåŠŸå®Œæˆ</li></ul><ul id="4c9c57c7-c263-4728-9699-ec03cad17839" class="bulleted-list"><li style="list-style-type:square"><em><strong>Rejected</strong></em>&lt;<strong>æ‹’ç»</strong>&gt;çŠ¶æ€è¡¨ç¤ºæ‰§è¡Œ<strong>æ²¡æœ‰</strong>æˆåŠŸå®Œæˆ</li></ul><hr id="6f2c87a7-1213-49f1-b490-26ccc3f8472d"/><ul id="02bcee71-8353-4346-8661-94be7d8c804d" class="bulleted-list"><li style="list-style-type:square">æŸäº›æƒ…å†µä¸‹ï¼Œå†…éƒ¨çŠ¶æ€æœºå°±æ˜¯promiseèƒ½æä¾›çš„æœ€æœ‰ç”¨çš„ä¿¡æ¯ï¼šä»…ä»…çŸ¥é“ä¸€æ®µå¼‚æ­¥ä»£ç å·²ç»å®Œæˆ å¯¹ <strong>é€šçŸ¥ç¨‹åºæµ</strong>ï¼ˆ<strong>informing program flow</strong>ï¼‰å°±è¶³å¤Ÿäº†</li></ul><ul id="fb8abfed-1f42-4ea8-a9e9-9a68dce79d66" class="bulleted-list"><li style="list-style-type:square">ä¾‹å¦‚ï¼Œå‡è®¾promiseè¦å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œè¯·æ±‚è¿”å›200~299èŒƒå›´å†…çš„<strong>çŠ¶æ€ç </strong>ï¼ˆ<strong>status code</strong>ï¼‰å°±è¶³ä»¥è®©promiseçš„çŠ¶æ€å˜ä¸º<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;ï¼›å¦‚æœè¯·æ±‚è¿”å›çš„çŠ¶æ€ç ä¸åœ¨200~299è¿™ä¸ªèŒƒå›´å†…ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠpromiseçŠ¶æ€åˆ‡æ¢ä¸º<em><strong>Rejected</strong></em>&lt;<strong>æ‹’ç»</strong>&gt;</li></ul></li></ul><ul id="29745671-bd41-4907-9c88-095e8e84e0ee" class="bulleted-list"><li style="list-style-type:circle">å¦ä¸€ä¸ªç”¨é€”æ˜¯ï¼ŒPromiseå°è£…çš„<strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼ˆ<strong>asynchronous execution</strong>ï¼‰ä¼šå®é™…ç”ŸæˆæŸä¸ªå€¼ï¼Œè€Œç¨‹åºæœŸå¾…promiseçŠ¶æ€æ”¹å˜æ—¶å¯ä»¥è®¿é—®è¿™ä¸ªå€¼<ul id="362fd0a1-e56c-41c8-b642-ad8fc941c4f4" class="bulleted-list"><li style="list-style-type:square">å¦‚æœpromiseè¢«æ‹’ç»ï¼Œç¨‹åºæµå°±ä¼šæœŸå¾…promiseçŠ¶æ€æ”¹å˜æ—¶å¯ä»¥æ‹¿åˆ°<strong>æ‹’ç»çš„ç†ç”±</strong>ï¼ˆ<strong>reason for rejection</strong>ï¼‰</li></ul><ul id="74c21044-2526-4c53-b54d-c71170913a0e" class="bulleted-list"><li style="list-style-type:square">å¦‚æœpromiseæˆåŠŸè§£å†³ï¼ˆ<strong>resolve</strong>ï¼‰ï¼Œç¨‹åºæµå°±ä¼šæœŸå¾…promiseçŠ¶æ€æ”¹å˜æ—¶å¯ä»¥æ‹¿åˆ°<strong>è§£å†³çš„ç»“æœ</strong>ï¼ˆ<strong>result for resolution</strong>ï¼‰</li></ul><hr id="97acde3c-f7d0-4a16-bea0-f4dce2f58635"/><ul id="afe38940-1e01-4d0f-89ec-7e1890cfee33" class="bulleted-list"><li style="list-style-type:square">ä»¥åŒæ ·çš„ä¾‹å­ä¸¾ä¾‹ï¼Œå‡è®¾promiseå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªHTTPè¯·æ±‚å¹¶é¢„å®šä¼šè¿”å›ä¸€ä¸ªJSONæ•°æ®ï¼Œå¦‚æœè¯·æ±‚è¿”å›èŒƒå›´ä¸º200~299çš„çŠ¶æ€ç ï¼Œåˆ™è¶³ä»¥è®©promiseçš„çŠ¶æ€å˜ä¸º<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;ï¼Œæ­¤æ—¶<strong>promiseå†…éƒ¨å°±ä¼šæ”¶åˆ°ä¸€ä¸ªJSONå­—ç¬¦ä¸²ï¼ˆ</strong>è§£å†³çš„ç»“æœ<strong>ï¼‰ï¼›</strong>å¦‚æœè¯·æ±‚è¿”å›èŒƒå›´ä¸å†200~299è¿™ä¸ªèŒƒå›´å†…ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠpromiseçš„çŠ¶æ€å˜ä¸º<em><strong>Rejected</strong></em>&lt;<strong>æ‹’ç»</strong>&gt;ï¼Œæ­¤æ—¶<strong>æ‹’ç»çš„ç†ç”±</strong></li></ul></li></ul></li></ul><ul id="7fd1bd51-f6a1-4b79-b59a-2e8074002119" class="bulleted-list"><li style="list-style-type:disc">ä¸ºäº†æ”¯æŒè¿™ä¸¤ç§ç”¨ä¾‹ï¼Œæ¯ä¸ª<code>Promise</code> å®ä¾‹åªè¦çŠ¶æ€åˆ‡æ¢ä¸º<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;å°±ä¼šæœ‰ä¸€ä¸ª<strong>ç§æœ‰çš„å†…éƒ¨å€¼</strong>ï¼ˆ<strong>private internal value</strong>ï¼‰ï¼›æ¯ä¸ª<code>Promise</code> å®ä¾‹åªè¦çŠ¶æ€åˆ‡æ¢ä¸º<em><strong>Rejected</strong></em>&lt;<strong>æ‹’ç»</strong>&gt;ï¼Œå°±ä¼šæœ‰ä¸€ä¸ª<strong>ç§æœ‰çš„å†…éƒ¨ç†ç”±</strong>ï¼ˆ<strong>private internal reason</strong>ï¼‰<ul id="de7927f8-c9b6-49f7-8554-12f20f066b8f" class="bulleted-list"><li style="list-style-type:circle">æ— è®ºæ˜¯å€¼è¿˜æ˜¯ç†ç”±ï¼Œéƒ½æ˜¯åŒ…å«åŸå§‹å€¼æˆ–å¯¹è±¡çš„<strong>ä¸å¯ä¿®æ”¹å¼•ç”¨</strong>ï¼ˆ<strong>immutable reference</strong>ï¼‰</li></ul><ul id="5cace52f-3c62-427b-9645-35d7e5ad5826" class="bulleted-list"><li style="list-style-type:circle">å¹¶ä¸”äºŒç§éƒ½æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤å€¼éƒ½æ˜¯<code>undefined</code></li></ul><ul id="7aeb3fc6-83ce-4bbb-b6bc-2b95eba2a896" class="bulleted-list"><li style="list-style-type:circle">åœ¨promiseåˆ°è¾¾æŸä¸ª<strong>è½åœ°çŠ¶æ€</strong>ï¼ˆ<strong>settled state</strong>ï¼‰åï¼Œæ‰§è¡Œçš„å¼‚æ­¥ä»£ç å§‹ç»ˆä¼šæ”¶åˆ°è¿™ä¸ªå€¼æˆ–ç†ç”±</li></ul></li></ul><h2 id="2df5d17d-7dac-4ec7-b215-6852accf723f" class="">2.2.3 é€šè¿‡æ‰§è¡Œå‡½æ•°æ§åˆ¶æœŸçº¦çŠ¶æ€ï¼ˆControlling Promise State with the Executorï¼‰</h2><ul id="c70b352b-2d5e-417f-8fe5-55dba394c8a5" class="bulleted-list"><li style="list-style-type:disc">å› ä¸ºPromiseçš„çŠ¶æ€æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥åªèƒ½åœ¨å†…éƒ¨è¿›è¡Œ<strong>æ“ä½œ</strong>ï¼ˆ<strong>manipulate</strong>ï¼‰ï¼Œå†…éƒ¨æ“ä½œåœ¨Promiseçš„<strong>æ‰§è¡Œå™¨å‡½æ•°</strong>ï¼ˆ<strong>executor function</strong>ï¼‰ä¸­æ‰§è¡Œ</li></ul><ul id="a95815e6-76a9-47ad-892a-81f980f445a7" class="bulleted-list"><li style="list-style-type:disc">æ‰§è¡Œå™¨ä¸»è¦æœ‰ä¸¤é¡¹ä¸»è¦èŒè´£ï¼š<ul id="20a17176-a108-4a42-9648-848d93e95c78" class="bulleted-list"><li style="list-style-type:circle">åˆå§‹åŒ–Promiseçš„<strong>å¼‚æ­¥è¡Œä¸º</strong>ï¼ˆ<strong>asynchronous behavior</strong>ï¼‰</li></ul><ul id="2beefa48-56f7-42da-8635-e4c753c373fc" class="bulleted-list"><li style="list-style-type:circle">æ§åˆ¶çŠ¶æ€çš„æœ€ç»ˆè½¬æ¢ï¼ˆany eventual state transitionï¼‰</li></ul></li></ul><ul id="9cd55ce0-fc27-4352-a0c2-204036725690" class="bulleted-list"><li style="list-style-type:disc">å…¶ä¸­ç¬¬äºŒé¡¹æ§åˆ¶PromiseçŠ¶æ€çš„è½¬æ¢æ˜¯é€šè¿‡è°ƒç”¨æ§åˆ¶å™¨å‡½æ•°çš„ä¸¤ä¸ªå‡½æ•°<strong>å‚æ•°</strong>ï¼ˆ<strong>parameters</strong>ï¼‰å®ç°çš„<ul id="ca5f6532-8015-460d-9e4d-5bfdc9385492" class="bulleted-list"><li style="list-style-type:circle"><code>resolve()</code> ï¼šè°ƒç”¨<code>resolve()</code> ä¼šæŠŠçŠ¶æ€åˆ‡æ¢ä¸º<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;</li></ul><ul id="054b023c-1cc2-49d0-befc-76880f549d12" class="bulleted-list"><li style="list-style-type:circle"><code>reject()</code> :è°ƒç”¨<code>reject()</code> ä¼šæŠŠçŠ¶æ€åˆ‡æ¢ä¸º<em><strong>Rejected</strong></em>&lt;<strong>æ‹’ç»</strong>&gt;ï¼Œé€šå¸¸è°ƒç”¨<code>reject()</code> ä¹Ÿä¼šæŠ›å‡ºé”™è¯¯</li></ul><pre id="bffdc871-83b9-404e-b668-382253b2f8e6" class="code"><code>let p1 = new Promise((resolve, reject) =&gt; resolve());
setTimeout(console.log, 0, p1); // PromiseÂ {&lt;fulfilled&gt;: undefined}
let p2 = new Promise((resolve, reject) =&gt; reject());
setTimeout(console.log, 0, p2); // PromiseÂ {&lt;rejected&gt;: undefined}
// Uncaught (in promise) undefined</code></pre><ul id="7df3c7ee-fcf7-4199-aa64-919b35b6aad2" class="bulleted-list"><li style="list-style-type:circle">æ³¨æ„ä¸Šè¿°æ‰“å°éƒ½æ˜¯åœ¨è°·æ­Œæµè§ˆå™¨çš„æ§åˆ¶å°ä¸‹çš„æ‰“å°</li></ul><ul id="d403e0e2-1a6c-439b-ba9a-c7c3236b67d1" class="bulleted-list"><li style="list-style-type:circle">åœ¨nodeç¯å¢ƒä¸‹ï¼Œ<code>p2</code> çš„<code>Promise</code> æ„é€ å‡½æ•°æ„é€ å°±ä¼šæŠ›å‡ºé”™è¯¯<code>UnhandledPromiseRejection</code> ï¼Œå³æ²¡æœ‰ä½¿ç”¨<code>catch</code> æ•è·æ‹’ç»ä¹‹åæŠ›å‡ºçš„é”™è¯¯</li></ul></li></ul><ul id="78b7906c-1c67-40ad-a3c9-a84d283fe187" class="bulleted-list"><li style="list-style-type:disc">ä¸Šé¢è¿™ä¸ªä¾‹å­æ²¡æœ‰å¼‚æ­¥æ“ä½œï¼Œå› ä¸ºåœ¨åˆå§‹åŒ–æ„é€ <code>Promsie</code> å®ä¾‹æ—¶ï¼Œæ‰§è¡Œå™¨å‡½æ•°å°±å·²ç»æ”¹å˜äº†æ¯ä¸ª<code>Promise</code> å®ä¾‹çš„çŠ¶æ€<ul id="dd79b8c4-eff4-431b-8c0e-e19439fe2d41" class="bulleted-list"><li style="list-style-type:circle">å…³é”®åœ¨äºï¼šæ‰§è¡Œå™¨å‡½æ•°æ˜¯<strong>åŒæ­¥ï¼ˆsynchronouslyï¼‰</strong>æ‰§è¡Œçš„ï¼Œå› ä¸ºæ‰§è¡Œå™¨å‡½æ•°æ˜¯Promiseçš„<strong>åˆå§‹åŒ–ç¨‹åº</strong>ï¼ˆ<strong>initializer</strong>ï¼‰</li></ul><pre id="d1f03fa2-86ac-4fea-822e-7f4d61a3069a" class="code code-wrap"><code>// è§‚å¯Ÿé¡ºåº
let p3 = new Promise(() =&gt; setTimeout(console.log, 0, &quot;executor&quot;)); 
console.log(p3);
setTimeout(console.log, 0, &#x27;promise initialized&#x27;);
// æ‰“å°ç»“æœ
Promise { &lt;pending&gt; }
executor
promise initialized</code></pre><ul id="ca3a2014-4cbe-4fee-bf3b-928d9cd7fca2" class="bulleted-list"><li style="list-style-type:circle">ä¸Šé¢çš„æ‰“å°å¯ä»¥å¾—å‡ºï¼Œæ‰§è¡Œé¡ºåºæ˜¯åŒæ­¥æ“ä½œä¼˜å…ˆï¼Œ<code>Promise</code> æ„é€ å‡½æ•°ä¸­çš„æ‰§è¡Œå™¨éšåæ‰§è¡Œï¼Œæœ€åæ˜¯å¤–éƒ¨çš„<code>setTimeout()</code> </li></ul><ul id="16fbffd1-effc-47d1-bd3e-bda902bdb9d3" class="bulleted-list"><li style="list-style-type:circle">åœ¨æ‰§è¡Œå™¨å‡½æ•°ä¸­æ·»åŠ  <code>setTimeout()</code> å¯ä»¥æ¨è¿Ÿåˆ‡æ¢å½¢æ€ï¼Œå¦‚ä¸‹</li></ul><pre id="e7215a8b-c9c9-4996-91e5-de7e733b6523" class="code code-wrap"><code>let p4 = new Promise((resolve, reject) =&gt; setTimeout(resolve, 1000));

setTimeout(console.log, 0, p4);
setTimeout(console.log, 1000, p4);
// æ‰“å°ç»“æœ
PromiseÂ {&lt;pending&gt;}
PromiseÂ {&lt;fulfilled&gt;: undefined}</code></pre><ul id="98077c96-041a-45af-997a-adf7506470a8" class="bulleted-list"><li style="list-style-type:circle">ç¬¬ä¸€ä¸ª<code>setTimeout</code> åœ¨æ‰“å°<code>p4</code> æ—¶ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œè¶…æ—¶è°ƒç”¨ï¼ˆå³æ²¡æœ‰æ‰§è¡Œ<code>resolve()</code>ï¼‰</li></ul><ul id="e578d880-10eb-44b0-8d02-eb1938cb1e0e" class="bulleted-list"><li style="list-style-type:circle">ç¬¬äºŒä¸ª<code>setTimeout</code> åœ¨æ‰“å°<code>p4</code> æ—¶ï¼Œæ‰§è¡Œå™¨ä¸­çš„å¼‚æ­¥æ“ä½œå·²æ‰§è¡Œå®Œæ¯•ï¼ˆæ‰§è¡Œäº†<code>resolve()</code>ï¼‰æ‰€ä»¥æ‰“å°å‡ºçš„<code>p4</code> çŠ¶æ€ä¸º<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;</li></ul></li></ul><ul id="cb97253f-da92-467b-bd19-01bd9e00d1d5" class="bulleted-list"><li style="list-style-type:disc">æ— è®º<code>resolve()</code> è¿˜æ˜¯<code>reject()</code> ä¸­çš„å“ªä¸ªè¢«è°ƒç”¨ï¼ŒçŠ¶æ€è½¬æ¢çš„ä¸å¯<strong>æ’¤é”€ï¼ˆundoneï¼‰</strong>äº†ï¼Œäºæ˜¯ç»§ç»­ä¿®æ”¹çŠ¶æ€ä¼š<strong>é™é»˜å¤±è´¥</strong>(<strong>silently be ignored</strong>)ï¼Œå¦‚ä¸‹<pre id="894301b9-31c2-4759-a965-b0a3c286b5f0" class="code code-wrap"><code>// ä¸å¯æ’¤é”€çš„çŠ¶æ€è½¬æ¢
let p5 = new Promise((resolve, reject) =&gt; {
  resolve();
  reject(); // é»˜è®¤è¢«å¿½ç•¥
  console.log(&quot;----&quot;); // ----
});
console.log(p5); // PromiseÂ {&lt;fulfilled&gt;: undefined}</code></pre></li></ul><ul id="0a8f12f7-aa54-4227-970d-a26452c27fc8" class="bulleted-list"><li style="list-style-type:disc">ä¸ºäº†é¿å…Promiseå¡åœ¨<em><strong>Pending</strong></em>&lt;<strong>å¾…å®š</strong>&gt;çŠ¶æ€ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªå®šæ—¶é€€å‡ºåŠŸèƒ½ï¼Œæ¯”å¦‚ï¼Œé€šè¿‡ä¸€ä¸ª<code>setTimeout</code> è®¾ç½®ä¸€ä¸ª10ç§’é’Ÿåæ— è®ºå¦‚ä½•éƒ½ä¼šæ‹’ç»Promiseçš„å›è°ƒ<pre id="672f0ff5-4d06-4df3-abd7-6964df99a4bc" class="code code-wrap"><code>// é¿å…æœŸçº¦ä¸€ç›´åœ¨ç­‰å¾…çŠ¶æ€
let p6 = new Promise((resolve, reject) =&gt; {
  setTimeout(reject, 10000); // 10ç§’åè°ƒç”¨rejectæ‹’ç»å‡½æ•°
  // è¿›è¡Œè¯·æ±‚
  /** è¯·æ±‚çš„å¼‚æ­¥ä»£ç æœ‰10ç§’çš„è¯·æ±‚æ—¶é—´ï¼Œè¯·æ±‚æˆåŠŸå°±æ‰§è¡Œresolve */
});
setTimeout(console.log, 0, p6); // PromiseÂ {&lt;pending&gt;}
setTimeout(console.log, 11000, p6); // ï¼ˆ11 ç§’åçš„æ‰“å°ï¼‰PromiseÂ {&lt;rejected&gt;: undefined}
// æŠ¥é”™æ‰“å°
Uncaught (in promise) undefined ï¼ˆ10ç§’åçš„æ‰“å°ï¼‰
</code></pre><ul id="784a4e74-3dc0-4b5c-9a41-baf93003fd02" class="bulleted-list"><li style="list-style-type:circle">å› ä¸ºPromiseçš„çŠ¶æ€åªèƒ½æ”¹å˜ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™é‡Œçš„è¶…æ—¶æ‹’ç»é€»è¾‘ä¸­å¯ä»¥æ”¾å¿ƒåœ°è®¾ç½®è®©Promiseå¤„äºå¾…å®šçŠ¶æ€çš„æœ€é•¿æ—¶é—´</li></ul><ul id="f0646ff2-4e10-4a89-824b-cad290b22cca" class="bulleted-list"><li style="list-style-type:circle">å¦‚æœæ‰§è¡Œå™¨ä¸­çš„ä»£ç ä¹‹å‰å·²ç»è§£å†³æˆ–æ‹’ç»ï¼Œé‚£ä¹ˆè¶…æ—¶å›è°ƒä¸­å†å°è¯•æ‹’ç»ä¹Ÿä¼š<strong>é™é»˜å¤±è´¥</strong>(<strong>silently be ignored</strong>)</li></ul></li></ul><h2 id="4681fba3-7073-4104-92ae-8f3b85428365" class="">2.2.4 Promise.resolve() ï¼ˆPromise Casting with Promise.resolve()ï¼‰</h2><ul id="f4d2441b-d350-403d-9510-32147e4aa858" class="bulleted-list"><li style="list-style-type:disc">Promiseå¹¶ä¸æ˜¯ä¸€å®šè¦ä¸€å¼€å§‹å°±æ˜¯<em><strong>Pending</strong></em>&lt;<strong>å¾…å®š</strong>&gt;çŠ¶æ€ï¼Œå®ƒå¯ä»¥åˆ©ç”¨æ‰§è¡Œå™¨å‡½æ•°ä¸€å¼€å§‹å°±è¾¾åˆ°å¦ä¸¤ä¸ª<strong>è½å®šçŠ¶æ€</strong>ï¼ˆ<strong>settled state</strong>ï¼‰</li></ul><ul id="7bd4b9e6-ccb2-4bd4-8b06-331ffdc51d10" class="bulleted-list"><li style="list-style-type:disc">é€šè¿‡è°ƒç”¨<code>Promise.resolve()</code> é™æ€æ–¹æ³•å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ªåœ¨<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;çŠ¶æ€çš„çš„<code>Promise</code> å®ä¾‹ï¼›ä¸‹é¢ä¸¤ä¸ª<code>Promise</code> å¯¹è±¡çš„<strong>å®ä¾‹åŒ–</strong>ï¼ˆ<strong>instantiations</strong>ï¼‰åå®é™…ä¸Šæ˜¯ä¸€æ ·çš„ï¼ˆçŠ¶æ€ä¸€è‡´ï¼‰<pre id="751991c1-69fc-4f8e-8890-1fe4ec6a669e" class="code code-wrap"><code>let p1 = new Promise((resolve, reject) =&gt; resolve());

let p2 = Promise.resolve();

console.log(p1); // PromiseÂ {&lt;fulfilled&gt;: undefined}
console.log(p2); // PromiseÂ {&lt;fulfilled&gt;: undefined}</code></pre><ul id="815a668f-4bb7-4238-b2f0-5cc553dc873e" class="bulleted-list"><li style="list-style-type:circle">å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå£°æ˜äº†ä¸¤ä¸ªçŠ¶æ€éƒ½æ˜¯<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;çš„<code>Promise</code>å¯¹è±¡ï¼Œä½†æ˜¯ä¸¤ä¸ª<code>Promise</code>å¯¹è±¡çš„<strong>å†…éƒ¨å€¼</strong>ï¼ˆ<strong>internal value</strong>ï¼‰éƒ½æ˜¯<code>undefined</code></li></ul></li></ul><ul id="dc7bb150-08f4-473a-9e90-eadb2b2d3067" class="bulleted-list"><li style="list-style-type:disc">è§£å†³çš„Promiseå€¼ï¼ˆ<strong>the value of resolved promise</strong>ï¼‰å¯¹åº”ç€ä¼ ç»™<code>Promise.resolve()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä½¿ç”¨è¿™ä¸ªé™æ€æ–¹æ³•å®é™…ä¸Šå¯ä»¥æŠŠå¦‚ä½•å€¼éƒ½è½¬åŒ–ä¸ºä¸€ä¸ªPromiseå®ä¾‹<pre id="e84f7a79-fcdb-40f0-90af-9221868d2041" class="code code-wrap"><code>setTimeout(console.log, 0, Promise.resolve()); // PromiseÂ {&lt;fulfilled&gt;: undefined}
setTimeout(console.log, 0, Promise.resolve(3)); // PromiseÂ {&lt;fulfilled&gt;: 3}
// å¤šä½™çš„å‚æ•°ä¼šè¢«å¿½ç•¥
setTimeout(console.log, 0, Promise.resolve(3, 4, 5)); // PromiseÂ {&lt;fulfilled&gt;: 3}</code></pre><ul id="c55328bd-edae-4f02-bbf6-b55077e1ec6b" class="bulleted-list"><li style="list-style-type:circle">è¿™ä¸ªé™æ€æ–¹æ³•ç›¸å½“äºå°†å‚æ•°<strong>åŒ…è£…ï¼ˆwrapï¼‰</strong>æˆäº†ä¸€ä¸ªçŠ¶æ€ä¸º<em><strong>Fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;<code>Promise</code> çš„å¯¹è±¡</li></ul></li></ul><ul id="4326197e-acc5-412e-b763-05668d6b0446" class="bulleted-list"><li style="list-style-type:disc">å¦‚æœä¼ å…¥<code>Promise.resolve()</code> çš„å‚æ•°æœ¬èº«å°±æ˜¯ä¸€ä¸ª<code>Promise</code> å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒçš„è¡Œä¸ºç±»ä¼¼äºä¸€ä¸ª<strong>ç©ºåŒ…è£…</strong>ï¼ˆ<strong>passthrough </strong>è‹±æ–‡ç‰ˆä½¿ç”¨é€ä¼ è¿™ä¸ªè¯è¯­è§£é‡Šï¼‰ï¼›å› æ­¤<code>Promise.resolve()</code> å¯ä»¥è¯´æ˜¯ä¸€ä¸ª<strong>å¹‚ç­‰æ–¹æ³•ï¼ˆidempotent methodï¼‰</strong><figure id="2fc34513-d334-440d-bee4-37137adfbd4e" class="link-to-page"><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/%E5%85%B3%E4%BA%8E%E5%B9%82%E7%AD%89%EF%BC%88about%20idempotent%EF%BC%89%202fc34513d334440dbee437137adfbd4e.html"><span class="icon">ğŸ¥</span>å…³äºå¹‚ç­‰ï¼ˆabout idempotentï¼‰</a></figure><pre id="6afeb85d-7dde-4ee4-84e9-21f9eaf2e195" class="code code-wrap"><code>let p3 = new Promise(() =&gt; {});
console.log(p3 === Promise.resolve(p3)); // true
console.log(p3 === Promise.resolve(Promise.resolve(p3))); // true
console.log(p3); // PromiseÂ {&lt;pending&gt;}</code></pre><ul id="7a0c3ded-23a1-4536-9f77-c5060067c0c6" class="bulleted-list"><li style="list-style-type:circle">è¿™ä¸ªå¹‚ç­‰æ€§ä½“ç°åœ¨å¯¹ä¼ å…¥çš„<code>Promise</code> å¯¹è±¡è¿›è¡ŒåŸå°ä¸åŠ¨çš„è¿›è¡Œè¿”å›ï¼Œå¹¶ä¸”ä¼šä¿ç•™<code>Promise</code> å¯¹è±¡åœ¨ä¼ å…¥çš„çŠ¶æ€</li></ul></li></ul><ul id="6fcee4b3-5450-475e-90ab-9b4c5bb05119" class="bulleted-list"><li style="list-style-type:disc">éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªé™æ€æ–¹æ³•èƒ½<strong>åŒ…è£…</strong>ä»»ä½•éPromiseå€¼ï¼ˆå¯¹Promiseå¯¹è±¡æ˜¯é€ä¼ çš„ï¼‰ï¼ŒåŒ…æ‹¬é”™è¯¯å¯¹è±¡ï¼Œå¹¶å°†å™¨è½¬æ¢ä¸º<strong>è§£å†³</strong>ï¼ˆ<strong>resolved</strong>ï¼‰çš„<code>Promise</code>å¯¹è±¡ï¼Œå› æ­¤å¯èƒ½å¯¼è‡´ä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸º<pre id="55f9648b-3eb1-47b7-9a83-84a8fb3439cb" class="code code-wrap"><code>let p4 = Promise.resolve(new Error(&quot;foo&quot;));
console.log(p4);
// æ‰“å°
// è°·æ­Œ
PromiseÂ {&lt;fulfilled&gt;: Error: foo
    at &lt;anonymous&gt;:1:26}
// ç«ç‹
Promise { &lt;state&gt;: &quot;fulfilled&quot;, &lt;value&gt;: Error }</code></pre><ul id="5798963f-af1e-4e02-a690-7c51f47c6597" class="bulleted-list"><li style="list-style-type:circle">ä¸Šé¢æ˜¯è°·æ­Œå’Œç«ç‹æµè§ˆå™¨çš„æ‰“å°ï¼Œè€Œnodeç¯å¢ƒä¸‹ä¼šç›´æ¥æ‰“å°å‡ºé”™è¯¯çš„å®Œæ•´ä½ç½®ï¼ˆä½†ä»ç„¶æ­£å¸¸æ‰§è¡Œï¼‰<figure id="11d73155-a49c-43b7-a228-85d8dc9bea40" class="image"><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/Untitled.png"><img style="width:1259px" src="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/Untitled.png"/></a></figure></li></ul></li></ul><h2 id="0bdbfe62-4571-44cd-80cb-0ef7e38db850" class="">2.2.5 Promise.reject()ï¼ˆPromise Rejection with Promise.reject()ï¼‰</h2><ul id="1c816898-7974-4833-b5d9-a6b30a35e966" class="bulleted-list"><li style="list-style-type:disc">ä¸<code>Promise.resolve()</code> ç±»ä¼¼çš„é™æ€æ–¹æ³•ï¼Œ<code>Promise.reject()</code> ä¼šå®ä¾‹åŒ–ä¸€ä¸ªå¤„äº<strong><em>Rejected &lt;</em></strong><strong>æ‹’ç»</strong><em>&gt;</em>çŠ¶æ€çš„<code>Promise</code> å¯¹è±¡ï¼Œ<strong>å¹¶æŠ›å‡ºä¸€ä¸ªå¼‚æ­¥é”™è¯¯(asynchronous errorï¼Œ</strong>è¿™ä¸ªå¼‚æ­¥é”™è¯¯ä¸èƒ½é€šè¿‡<code>try/catch</code> è¯­å¥æ•è·ï¼Œè€Œåªèƒ½é€šè¿‡æ‹’ç»å¤„ç†ç¨‹åºæ•è·<strong>ï¼Œ</strong>ä¸‹é¢ä¸¤ä¸ª<code>Promise</code> å¯¹è±¡çš„<strong>å®ä¾‹åŒ–</strong>ï¼ˆ<strong>instantiations</strong>ï¼‰åå®é™…ä¸Šæ˜¯ä¸€æ ·çš„ï¼ˆçŠ¶æ€ä¸€è‡´ï¼‰<pre id="74adef1b-b8af-4573-9765-d24d0c5165ea" class="code code-wrap"><code>let p1 = Promise.reject();
let p2 = new Promise((resolve, reject) =&gt; reject());
console.log(p1); // PromiseÂ {&lt;rejected&gt;: undefined}
console.log(p2); // PromiseÂ {&lt;rejected&gt;: undefined}
// é”™è¯¯ä¿¡æ¯
Uncaught (in promise) undefined</code></pre><ul id="c52975a0-7acb-42e3-8685-2513604a87bd" class="bulleted-list"><li style="list-style-type:circle">nodeç¯å¢ƒä¸‹ç›´æ¥<a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6.html">æŠ›å‡ºé”™è¯¯</a>ï¼ˆä¸ä¼šæ‰§è¡Œæ‰“å°è¯­å¥ï¼‰ï¼›ä¸Šè¿°æ‰“å°æ˜¯è°·æ­Œæµè§ˆå™¨ä¸‹çš„æ‰“å°</li></ul></li></ul><ul id="aa5c9322-a755-4b77-9242-474368b23b01" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.reject()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æ‹’ç»çš„Promiseçš„ç†ç”±ï¼ˆâ€˜reasonâ€™ filedï¼‰ï¼Œè¿™ä¸ªå‚æ•°ä¹Ÿä¼šä¼ é€’ç»™åç»­çš„<strong>æ‹’ç»å¤„ç†ç¨‹åº</strong>ï¼ˆ<strong>reject handler</strong>ï¼‰<pre id="c2c65e17-1519-4e3c-b282-8c74a7820efe" class="code code-wrap"><code>// ç¬¬ä¸€ä¸ªå‚æ•°æ¥å—æ‹’ç»çš„æœŸçº¦çš„ç†ç”±
let p = Promise.reject(&quot;reason&quot;);
console.log(p); // PromiseÂ {&lt;rejected&gt;: &#x27;reason&#x27;
p.then(null, (e) =&gt; {
  console.log(e); // reason
}) // thenæ–¹æ³•æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæ–°æœŸçº¦ PromiseÂ {&lt;fulfilled&gt;: undefined}</code></pre><ul id="66f0bb86-574b-46dd-9395-fd491e942c16" class="bulleted-list"><li style="list-style-type:circle">è¿™é‡Œ<code>then</code>æ–¹æ³•ä¼šåœ¨åç»­ä»‹ç»ï¼Œå®ƒèƒ½æ¥å—PromiseçŠ¶æ€è½¬æ¢åçš„å†…éƒ¨å€¼ï¼Œå¹¶ä¸”è®©æ‹’ç»çš„Promiseèƒ½æ­£å¸¸æ‰§è¡Œï¼ˆä¸ä¼šæŠ›å‡ºæŠ¥é”™çº¢å­—ï¼‰</li></ul></li></ul><ul id="648ba93b-2dae-4007-9fed-7ec4a8362036" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.reject()</code> çš„åŒºåˆ«é™¤äº†ç”Ÿæˆçš„<code>Promise</code> å¯¹è±¡çŠ¶æ€ä¸ä¸€æ ·å¤–ï¼Œ<code>Promise.reject()</code> æ²¡æœ‰ç…§æ¬<code>Promise.resolve()</code> çš„å¹‚ç­‰é€»è¾‘ï¼Œå¦‚æœç»™å®ƒä¼ é€’ä¸€ä¸ª<code>Promise</code> å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šæˆåŠŸå®ƒè¿”å›çš„<strong>æ‹’ç»æœŸçº¦</strong>ï¼ˆ<strong>rejected promise</strong>ï¼‰çš„â€œç†ç”±ï¼ˆreasonï¼‰â€<pre id="d9ad5376-2114-4dbb-9b77-e6d29432e371" class="code"><code>console.log(Promise.reject(Promise.resolve(5))); // PromiseÂ {&lt;rejected&gt;: Promise}
// æŠ¥é”™ä¿¡æ¯
Uncaught (in promise) PromiseÂ {&lt;fulfilled&gt;: 5}</code></pre><ul id="1a071650-a7db-431b-a062-4240b349468f" class="bulleted-list"><li style="list-style-type:circle">åœ¨è°·æ­Œæµè§ˆå™¨ä¸­ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹<figure id="044a51f4-0a76-48e9-9e80-53025242a4cb" class="image"><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/1.png"><img style="width:720px" src="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/1.png"/></a></figure></li></ul></li></ul><h2 id="92264bf6-6db3-4c20-8f01-c05dd2009c13" class="">2.2.5 åŒæ­¥/å¼‚æ­¥æ‰§è¡Œçš„äºŒå…ƒæ€§ï¼ˆSynchronous/Asynchronous Execution Dualityï¼‰</h2><ul id="8013bf87-ba9c-4a84-bf57-446ccc9f62a5" class="bulleted-list"><li style="list-style-type:disc">Promiseçš„è®¾è®¡å¾ˆå¤§ç¨‹åº¦ä¸Šä¼šå¯¼è‡´ä¸€ç§å®Œå…¨ä¸åŒäºJavaScriptçš„<strong>è®¡ç®—æ¨¡å¼</strong>ï¼ˆ<strong>computation mode</strong>ï¼‰ï¼Œä¸‹é¢çš„ä¾‹å­å®Œç¾åœ°å±•ç¤ºäº†è¿™ä¸€ç‚¹ï¼Œå®ƒæŒ‡å‡ºäº†ä¸¤ç§æ¨¡å¼åœ¨é”™è¯¯å¤„ç†æƒ…å†µä¸‹çš„ä¸åŒ<pre id="27fc3070-2d23-4398-a6e0-4eaa46ea38d7" class="code"><code>// åŒæ­¥æ‰§è¡Œä¸å¼‚æ­¥æ‰§è¡Œçš„äºŒå…ƒæ€§
try {
  throw new Error(&quot;foo&quot;);
} catch (error) {
  console.log(error.toString()); // Error: foo
}
try {
  Promise.reject(new Error(&quot;bar&quot;)); 
// PromiseÂ {&lt;rejected&gt;: Error: bar
//    at &lt;anonymous&gt;:8:18}
} catch (error) {
  console.log(error.toString());
}</code></pre><ul id="64b9fe4f-9a62-415a-911f-dc40b7d619d3" class="bulleted-list"><li style="list-style-type:circle">ç¬¬ä¸€ä¸ª<code>try/catch</code> æŠ›å‡ºå¹¶æ•è·äº†å¼‚å¸¸ï¼Œç¬¬äºŒä¸ª<code>try/catch</code> ä¸­<code>try</code> ä¸­çš„<code>Promise</code> è¯­å¥è°ƒç”¨<code>reject()</code> é™æ€æ–¹æ³•åˆ›å»º<code>Promise</code> å®ä¾‹åŒæ—¶æŠ›å‡ºäº†é”™è¯¯ï¼Œä½†æ˜¯ç¼º<strong>æ²¡æœ‰</strong>è¢«<code>catch</code> æ•è·åˆ°</li></ul><ul id="be3cc29a-6bf6-4e40-87cb-b42620df44a2" class="bulleted-list"><li style="list-style-type:circle">ä¹ä¸€çœ‹å¯èƒ½<strong>è¿åç›´è§‰</strong>ï¼ˆ<strong>counterintuitive</strong>ï¼‰ï¼Œå› ä¸ºä»£ç ä¸­ç¡®å®<strong>åŒæ­¥ï¼ˆsynchronouslyï¼‰</strong>åˆ›å»ºäº†ä¸€ä¸ªæ‹’ç»çš„æœŸçº¦å®ä¾‹ï¼Œè€Œè¿™ä¸ªå®ä¾‹åœ¨æ‹’ç»æ—¶æŠ›å‡ºäº†é”™è¯¯</li></ul><ul id="a1bff707-6788-41ab-ad98-0362f52a44ff" class="bulleted-list"><li style="list-style-type:circle">è¿™é‡Œçš„åŒæ­¥ä»£ç ä¹‹æ‰€ä»¥æ²¡æœ‰æ•è·æœŸçº¦æŠ›å‡ºçš„é”™è¯¯ï¼Œæ˜¯å› ä¸ºä»£ç æ²¡æœ‰é€šè¿‡åˆé€‚çš„<strong>å¼‚æ­¥æ¨¡å¼ï¼ˆasynchronous modeï¼‰</strong>æ¥æ•è·é”™è¯¯</li></ul><ul id="da1210ac-0ba9-43bb-9c5f-ade0c7bda9d2" class="bulleted-list"><li style="list-style-type:circle">ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºPromiseçœŸæ­£çš„ç‰¹æ€§ï¼šå®ƒä»¬æ˜¯<strong>åŒæ­¥å¯¹è±¡â€”</strong>åœ¨åŒæ­¥æ‰§è¡Œæ¨¡å¼ä¸­ä½¿ç”¨ï¼Œä½†ä¹Ÿæ˜¯<strong>å¼‚æ­¥æ‰§è¡Œæ¨¡å¼</strong>ï¼ˆ<strong>asynchronous mode of execution</strong>ï¼‰å¾—åˆ°åª’ä»‹</li></ul></li></ul><ul id="e9edba7e-2c30-4096-93d0-d4fdffd7a8a4" class="bulleted-list"><li style="list-style-type:disc">åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ‹’ç»æœŸçº¦çš„é”™è¯¯å¹¶æ²¡æœ‰æŠ›åˆ°æ‰§è¡ŒåŒæ­¥ä»£ç ä¸­çš„çº¿ç¨‹ï¼ˆ<strong>thread</strong>ï¼‰é‡Œï¼Œè€Œæ˜¯é€šè¿‡æµè§ˆå™¨å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—æ¥å¤„ç†çš„ï¼Œå› æ­¤ï¼Œ<code>try/catch</code>å—å¹¶ä¸èƒ½æ•è·è¯¥é”™è¯¯ï¼›ä»£ç ä¸€æ—¦å¼€å§‹ä»¥å¼‚æ­¥æ¨¡å¼æ‰§è¡Œï¼Œåˆ™å”¯ä¸€ä¸ä¹‹äº¤äº’çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨å¼‚æ­¥ç»“æ„â€”â€”æ›´ç¡®åˆ‡åœ°è¯´å°±æ˜¯<code>Promise</code> çš„æ–¹æ³•</li></ul><h1 id="4a9accce-259e-4bf8-aa66-c97f049f17b9" class="">2.3 æœŸçº¦çš„å®ä¾‹æ–¹æ³•ï¼ˆPromise Instance Methodï¼‰</h1><p id="8180046f-6698-4836-abb1-032e8e90c73c" class="">Promiseå®ä¾‹æ–¹æ³•æ˜¯è¿æ¥å¤–éƒ¨åŒæ­¥ä»£ç å’Œå†…éƒ¨å¼‚æ­¥ä»£ç ä¹‹é—´çš„æ¡¥æ¢</p><p id="3bf2456d-4e96-4a33-991a-5d557db7fe5d" class="">è¿™äº›æ–¹æ³•å¯ä»¥</p><ul id="39e0c2e5-ef08-4e77-92ba-0500f9658e8f" class="bulleted-list"><li style="list-style-type:disc">è®¿é—®å¼‚æ­¥æ“ä½œè¿”å›çš„æ•°æ®</li></ul><ul id="6e305641-f517-4a29-afc1-5ef28f9f5a9f" class="bulleted-list"><li style="list-style-type:disc">å¤„ç†promiseæˆåŠŸå’Œå¤±è´¥çš„ç»“æœ</li></ul><ul id="128c4e30-9c1f-441e-95f6-38e053d9b892" class="bulleted-list"><li style="list-style-type:disc">è¿ç»­å¯¹promisesæ±‚å€¼</li></ul><ul id="ef08bc78-65fd-485c-a94c-21b87e1d3f32" class="bulleted-list"><li style="list-style-type:disc">æˆ–è€…æ·»åŠ åªæœ‰promiseè¿›å…¥<strong>ç»ˆæ­¢çŠ¶æ€</strong>ï¼ˆ<strong>terminal state</strong>ï¼‰æ—¶æ‰ä¼šæ‰§è¡Œçš„ä»£ç </li></ul><p id="fd63a6f4-c09c-459e-a007-c75c3c9fbfa7" class="">æœŸçº¦çš„æ‰€æœ‰å®ä¾‹æ–¹æ³•å¯ä»¥é€šè¿‡è°·æ­Œæµè§ˆå™¨ä¸­æ‰“å°å‡ºæ¥çš„ç®€å•<code>Promise</code> å¯¹è±¡æŸ¥çœ‹</p><figure id="d7d4928e-42a4-49fe-8504-72008d21ca0b" class="image"><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/2.png"><img style="width:672px" src="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/2.png"/></a></figure><ul id="45544f66-f39e-4e60-9c86-662ee0d8374b" class="bulleted-list"><li style="list-style-type:disc">å¯ä»¥å‘ç°æœ‰<code>catch()</code>ã€<code>finally()</code>ã€<code>then()</code>ç­‰æ–¹æ³•</li></ul><ul id="25b8e938-a55e-4ba4-83d8-46fc7e220071" class="bulleted-list"><li style="list-style-type:disc">å…¶ä¸­<code>constructor</code> å±æ€§å¼•ç”¨<code>Promise</code> æ„é€ å‡½æ•°ï¼Œè¿™ä¸€ç‚¹å’Œä¹‹å‰ä»‹ç»è¿‡çš„åŸå‹å¯¹è±¡é»˜è®¤å±æ€§ä¸€æ ·</li></ul><ul id="9df5d176-b69a-43de-9a55-5cdd5129c623" class="bulleted-list"><li style="list-style-type:disc">é™¤æ­¤ä¹‹å¤–è¿˜æœ‰<code>Symbol(Symbol.toStringTag)</code> ç¬¦å·å±æ€§ï¼Œå¼•ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²ç”¨äºåˆ›å»ºå¯¹è±¡çš„é»˜è®¤å­—ç¬¦ä¸²æè¿°ï¼ˆæ‰€ä»¥è°ƒç”¨æœŸçº¦å®ä¾‹çš„<code>toString()</code> è¿”å›<code>&quot;[object Promise]&quot;</code>ï¼‰</li></ul><h2 id="f43a3fb8-2648-4556-8ccf-c6fb6149c2a6" class="">2.3.1 å®ç°<em>Thenable</em>æ¥å£ï¼ˆImplementing The <em>Thenable </em>Interfaceï¼‰</h2><ul id="ddbb7e8f-9d5f-464a-866c-5dd3f82e8802" class="bulleted-list"><li style="list-style-type:disc">åœ¨ECMAScriptæš´éœ²çš„å¼‚æ­¥ç»“æ„ä¸­ï¼Œ<strong>ä»»ä½•å¯¹è±¡</strong>éƒ½æœ‰ä¸€ä¸ª<code>then()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¢«è®¤ä¸ºå®ç°äº†<strong><em>Thenable</em></strong>æ¥å£</li></ul><ul id="0d0aa55c-255c-458a-a1ca-67cafed3f4ba" class="bulleted-list"><li style="list-style-type:disc"><strong><em>Thenable </em></strong>åˆ†å¼€å°±æ˜¯ then + able ,<del>thenæŒ‡çš„å°±æ˜¯</del><del><code>then()</code></del><del> æ–¹æ³•</del>ï¼Œè€Œableåœ¨è‹±è¯­ä¸­ä½œä¸ºåç¼€è¡¨ç¤ºâ€èƒ½â€¦çš„â€œä¹‹æ„ï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºï¼šThenableè¡¨ç¤ºâ€å…·æœ‰thenç‰¹æ€§çš„â€œ</li></ul><ul id="dd40c18b-ed1d-4edd-9d24-aea77604ef0b" class="bulleted-list"><li style="list-style-type:disc">ä¸€ä¸ªç®€å•çš„å®ç°Thenableæ¥å£çš„ç±»å¦‚ä¸‹<pre id="a0d07f37-ff4b-476a-b56f-93c838542237" class="code"><code>// Thenableæ¥å£
class MyThenable {
  then() {}
}</code></pre></li></ul><ul id="71a320fd-08dc-47e5-9447-5701bd3972c9" class="bulleted-list"><li style="list-style-type:disc">ECMAScriptçš„<code>Promise</code>ç±»å‹å®ç°äº†<strong><em>Thenable</em></strong> æ¥å£ï¼›è¿™ä¸ªç®€åŒ–çš„æ¥å£ï¼ˆæŒ‡ä¸Šé¢çš„ä¾‹å­ï¼‰è·ŸTypeScriptæˆ–å…¶ä»–åŒ…ä¸­çš„æ¥å£æˆ–ç±»å‹å®šä¹‰ä¸åŒï¼Œå®ƒä»¬éƒ½è®¾å®šäº†<strong><em>Thenable</em></strong>æ¥å£æ›´å…·ä½“çš„å½¢å¼</li></ul><figure class="block-color-blue_background callout" style="white-space:pre-wrap;display:flex" id="61f4082a-edb2-47ab-9ae7-089020d834cd"><div style="font-size:1.5em"><span class="icon">ğŸ’¡</span></div><div style="width:100%">æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯ç®€å•è§£é‡Šä»¥ä¸‹<strong><em>Thenable </em></strong>æ¥å£ï¼Œåé¢ä»‹ç»å¼‚æ­¥å‡½æ•°æ—¶è¿˜ä¼šå†è°ˆåˆ°å®ƒçš„<em>ç”¨é€”ï¼ˆutilityï¼‰</em>å’Œ<em>ç›®çš„ï¼ˆpurposeï¼‰</em></div></figure><h2 id="74cb9a8d-cbb1-4fc0-aa2c-dff9a7b25ab7" class="">2.3.2 Promise.prototype.then()</h2><ul id="27a49187-34cf-4192-86e3-0dde65be425e" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.prototype.then()</code> æ˜¯ä¸ºäº†<code>Promise</code> å®ä¾‹<strong>æ·»åŠ å¤„ç†ç¨‹åº</strong>ï¼ˆ<strong>attach handlers</strong>ï¼‰çš„ä¸»è¦æ–¹æ³•ï¼Œå®ƒæ¥å—æœ€å¤šä¸¤ä¸ªå‚æ•°ï¼ˆéƒ½æ˜¯å¯é€‰çš„ï¼‰<ul id="cb6ae546-2763-438b-840a-54613584198e" class="bulleted-list"><li style="list-style-type:circle"><code>onResolved</code> å¤„ç†ç¨‹åºå‡½æ•°ï¼Œæä¾›çš„è¯ï¼Œä¼šåœ¨<code>Promise</code> å®ä¾‹è¿›å…¥<em><strong>fulfilled</strong></em>&lt;<strong>å…‘ç°</strong>&gt;çŠ¶æ€æ—¶æ‰§è¡Œ</li></ul><ul id="ac610822-6575-4b16-996e-902f5bd72c91" class="bulleted-list"><li style="list-style-type:circle"><code>onRejected</code> å¤„ç†ç¨‹åºå‡½æ•°ï¼Œæä¾›çš„è¯ï¼Œä¼šåœ¨<code>Promise</code> å®ä¾‹è¿›å…¥<strong><em>rejected</em></strong>&lt;<strong>æ‹’ç»</strong>&gt;çŠ¶æ€æ—¶æ‰§è¡Œ</li></ul></li></ul><ul id="bba5f9d6-9755-4607-8baa-4a28a7cbe8be" class="bulleted-list"><li style="list-style-type:disc">å› ä¸º<code>Promise</code> å®ä¾‹çš„çŠ¶æ€åªèƒ½è½¬æ¢ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæ“ä½œï¼ˆå¤„ç†ç¨‹åºå‡½æ•°ï¼‰ä¸€å®šæ˜¯äº’æ–¥çš„ï¼ˆåªèƒ½æœ‰ä¸€ä¸ªè¢«æ‰§è¡Œï¼‰ï¼Œå¦‚ä¸‹<pre id="a708536d-c50f-4c30-8053-b59a3e7c678e" class="code"><code>// Promiseè¿›å…¥å…‘ç°çŠ¶æ€æ—¶çš„å¤„ç†ç¨‹åº
function onResolved(id) {
  setTimeout(console.log, 0, id, &quot;resolved&quot;);
}
// Promiseè¿›å…¥æ‹’ç»çŠ¶æ€æ—¶çš„å¤„ç†ç¨‹åº
function onRejected(id) {
  setTimeout(console.log, 0, id, &quot;rejected&quot;);
}
// 3ç§’åè¿›å…¥å…‘ç°çŠ¶æ€
let p1 = new Promise((resolve, reject) =&gt; setTimeout(resolve, 3000));
// 3ç§’åè¿›å…¥æ‹’ç»çŠ¶æ€
let p2 = new Promise((resolve, reject) =&gt; setTimeout(reject, 3000));

p1.then(
  () =&gt; onResolved(&quot;p1&quot;),
  () =&gt; onRejected(&quot;p1&quot;)
);
p2.then(
  () =&gt; onResolved(&quot;p2&quot;),
  () =&gt; onRejected(&quot;p2&quot;)
);
// 3ç§’åçš„æ‰“å°
p1 resolved
p2 rejected</code></pre><ul id="94ac5902-f36d-4ffb-97b6-ecc672a16b3d" class="bulleted-list"><li style="list-style-type:circle">ä¸¤ä¸ªå¤„ç†ç¨‹åºå‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œè¿™é‡Œç»™<code>p1.then()</code> å’Œ<code>p2.then()</code> éƒ½ä¼ é€’äº†ä¸¤ä¸ªè¿›å…¥ä¸åŒçŠ¶æ€åçš„å¤„ç†ç¨‹åºå‚æ•°</li></ul></li></ul><ul id="44d17eab-ad22-4ba4-8516-4714bf7c7177" class="bulleted-list"><li style="list-style-type:disc">å¦‚æœåªæƒ³æä¾›<code>onRebjected</code> å‚æ•°ï¼Œå¯ä»¥åœ¨<code>onResolved</code> å‚æ•°ä½ç½®ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ä¸Šä¼ å…¥<code>undefined</code> ï¼ˆ<strong>canonical è§„èŒƒ</strong>çš„é€‰æ‹©ï¼‰ ï¼Œè¿™æ ·æœ‰åŠ©äºé¿å…åœ¨å†…å­˜ä¸­åˆ›å»ºå¤šä½™çš„<strong>ä¸´æ—¶</strong>ï¼ˆ<strong>temporary</strong>ï¼‰å¯¹è±¡ï¼ˆä¼šè¢«è§£é‡Šå™¨å¿½ç•¥ï¼‰ï¼Œå¯¹æœŸå¾…å‡½æ•°å‚æ•°çš„ç±»å‹ç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªäº¤ä»£ï¼›å¹¶ä¸”ä¼ é€’ç»™ä»»ä½•éå‡½æ•°ç±»å‹çš„å‚æ•°éƒ½ä¼šè¢«<strong>é™æ€å¿½ç•¥</strong>ï¼ˆ<strong>silently ignored</strong>ï¼‰<pre id="ad2a1eb4-959a-4d59-8306-437537022a37" class="code"><code>// 3ç§’åè¿›å…¥å…‘ç°çŠ¶æ€
let p3 = new Promise((resolve, reject) =&gt; setTimeout(resolve, 3000));
// 3ç§’åè¿›å…¥æ‹’ç»çŠ¶æ€
let p4 = new Promise((resolve, reject) =&gt; setTimeout(reject, 3000));
// ä¼šè¢«å¿½ç•¥ï¼Œä¸æ¨è
p3.then(&quot;auisdhc&quot;);
// ä¸ä¼ é€’onResolvedå¤„ç†ç¨‹åºçš„è§„èŒƒå†™æ³•
p4.then(null, () =&gt; onRejected(&quot;p4&quot;)); // p4 rejected ï¼ˆ3ç§’åæ‰“å°ï¼‰</code></pre></li></ul><hr id="5edc5721-f1b1-4218-ae54-9e239a1de85a"/><ul id="ba5ddcb5-5c2d-4a23-926d-1db3b9784563" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.prototype.then()</code> æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„<code>Promise</code> å¯¹è±¡<ul id="3381ca61-4c4c-49f3-be32-6a6a36c17e21" class="bulleted-list"><li style="list-style-type:circle">è¿™ä¸ªæ–°å¯¹è±¡åŸºäº<code>onResovled</code> å¤„ç†ç¨‹åºçš„è¿”å›å€¼æ„å»ºï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å¤„ç†ç¨‹åºçš„è¿”å›å€¼é€šè¿‡<code>Promise.resolve()</code> é™æ€æ–¹æ³•åŒ…è£…ç”Ÿæˆæ–°<code>Promise</code> å¯¹è±¡</li></ul><ul id="b170ee17-e6fd-4715-8092-73f94738cca0" class="bulleted-list"><li style="list-style-type:circle">å¦‚æœæ²¡æœ‰æä¾›å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œåˆ™<code>Promise.resolve()</code> å°±ä¼šåŒ…è£…ä¸Šä¸€ä¸ª<code>Promise</code> è§£å†³ä¹‹åçš„å€¼ï¼ˆ<strong>åŒ…æ‹¬</strong>æ‹’ç»çš„Promiseå¯¹è±¡ï¼‰</li></ul><ul id="06bd54e4-4913-47c0-b2f2-977d001b35c6" class="bulleted-list"><li style="list-style-type:circle">å¦‚æœæä¾›äº†å¤„ç†ç¨‹åºä½†æ˜¯æ²¡æœ‰æ˜¾å¼çš„è¿”å›è¯­å¥ï¼Œåˆ™<code>Promise.resolve()</code> ä¼šé»˜è®¤åŒ…è£…é»˜è®¤çš„è¿”å›å€¼<code>undefined</code></li></ul><pre id="d01cae5c-cc50-4a11-8818-7162aeb8d438" class="code"><code>// p.then()çš„è¿”å›å€¼
// 4ç§’åè¿›å…¥å…‘ç°çŠ¶æ€
let p5 = new Promise((resolve, reject) =&gt; setTimeout(resolve, 4000));
let reP5 = p5.then(() =&gt; {
  // onResolved
  console.log(&quot;p5 resolved&quot;);
  // è¿”å›p5ä½œä¸ºp5.thenè¿”å›å€¼(Promiseå…‘ç°)åŒ…è£…çš„å€¼
  return &quot;p5&quot;;
});
setTimeout(console.log, 4000, reP5); 
// å››ç§’åæ‰“å°
// p5 resolved
// PromiseÂ {&lt;fulfilled&gt;: &#x27;p5&#x27;}

// 3ç§’åè¿›å…¥å…‘ç°çŠ¶æ€
let p6 = new Promise((resolve, reject) =&gt;
  setTimeout(() =&gt; {
    resolve(&quot;foo&quot;);
  }, 500)
);
// ä¸ä¼ é€’ä»»ä½•å¤„ç†ç¨‹åº
let p7 = p6.then();
setTimeout(() =&gt; {
  console.log(p6);
  console.log(p7);
  console.log(p6 === p7);
}, 500);
// åŠç§’åæ‰“å°
// PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;}
// PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;}
// false

// è¿”å›çš„Promiseå…‘ç°å†…éƒ¨å€¼éƒ½æ˜¯undefinedçš„ä¾‹å­
let p8 = p6.then(() =&gt; undefined);
let p9 = p6.then(() =&gt; {});
let p10 = p6.then(() =&gt; Promise.resolve());
setTimeout(() =&gt; {
  console.log(p8);
  console.log(p9);
  console.log(p10);
}, 500);
// åŠç§’åæ‰“å°
// PromiseÂ {&lt;fulfilled&gt;: undefined}
// PromiseÂ {&lt;fulfilled&gt;: undefined}
// PromiseÂ {&lt;fulfilled&gt;: undefined}</code></pre><ul id="a7b304e1-cfe8-41d9-b987-9de603141773" class="bulleted-list"><li style="list-style-type:circle">å¦‚æœç›´æ¥è°ƒç”¨<code>then()</code> ä¸ä¼ é€’ä»»ä½•å¤„ç†ç¨‹åºï¼Œç›¸å½“äº<strong>é€ä¼ </strong>ï¼ˆ<strong>passthrough</strong>ï¼‰è¿”å›ä¸€ä¸ªæ–°çš„ä¸è°ƒç”¨è€…çŠ¶æ€å’Œå€¼éƒ½ç›¸åŒçš„<code>Primise</code> å®ä¾‹</li></ul><ul id="0b7c942b-7537-456a-b5af-e2772f509192" class="bulleted-list"><li style="list-style-type:circle">æœ‰å¯¹åº”çš„å¤„ç†ç¨‹åºä¸”è¯¥å¤„ç†ç¨‹åºæœ‰è¿”å›å€¼ï¼Œé‚£ä¹ˆ<code>Promise.resovle()</code> çš„ä¼šåŒ…è£…è¿™ä¸ªå€¼ï¼Œå¦‚ä¸Šé¢çš„<code>p5</code> å’Œ<code>reP5</code></li></ul><ul id="35bce063-3891-421a-9007-b7c309cf0c8a" class="bulleted-list"><li style="list-style-type:circle"> åœ¨ä¸è¿”å›å€¼ï¼Œæˆ–è€…è¿”å›æ²¡æœ‰å€¼çš„<code>Promise</code> å®ä¾‹æ—¶ï¼Œ<code>then()</code> è¿”å›çš„æ–°åˆ›å»ºçš„<code>Promise</code> å®ä¾‹å†…éƒ¨ä¹Ÿä¼šæ²¡æœ‰å€¼ï¼Œå°±åƒ<code>p8</code>, <code>p9</code>, <code>p10</code></li></ul></li></ul><ul id="765386b5-1260-4882-885f-96f17c116458" class="bulleted-list"><li style="list-style-type:disc">å¦‚æœåœ¨å¤„ç†ç¨‹åºä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œ<code>then()</code> ä¼šè¿”å›ä¸€ä¸ªæ‹’ç»çš„<code>Promise</code> å®ä¾‹ï¼Œè€ŒæŠŠé”™è¯¯å¯¹è±¡åœ¨å¯¹åº”çš„å¤„ç†ç¨‹åºä¸­ä½œä¸ºè¿”å›å€¼ä¸ä¼šè§¦å‘æ‹’ç»è¡Œä¸ºï¼ˆæµè§ˆå™¨å¼•æ“ä¸ä¼šæŠ›å‡ºçº¢å­—é”™è¯¯ï¼‰<pre id="399cf86c-e8c0-43c4-a852-b3af0e688f92" class="code"><code>// åœ¨å¤„ç†ç¨‹åºä¸­æŠ›å‡ºå¼‚å¸¸
const p11 = Promise.resolve(&quot;foo&quot;);
let p12 = p11.then(() =&gt; {
  throw &quot;baz&quot;;
});
setTimeout(() =&gt; {
  console.log(p12);
}, 0);
let p13 = p11.then(() =&gt; Error(&quot;qux&quot;));
setTimeout(() =&gt; {
  console.log(p13);
}, 0);</code></pre><figure id="7600ebf1-7769-4079-b436-944d109f81b9" class="image" style="text-align:center"><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/3.png"><img style="width:672px" src="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/3.png"/></a></figure><ul id="36e1e66f-496f-4ac9-b215-8c60fd2eb029" class="bulleted-list"><li style="list-style-type:circle">å¯ä»¥çœ‹åˆ°åœ¨å¯¹åº”çš„å¤„ç†ç¨‹åºä¸­æŠ›å‡ºé”™è¯¯ï¼Œ<code>p12</code> å°±æ˜¯ä¸€ä¸ªçŠ¶æ€ä¸º<strong><em>Rejected </em></strong><strong>&lt;æ‹’ç»&gt;</strong>ï¼Œå€¼ä¸ºæŠ›å‡ºçš„å¼‚å¸¸çš„<code>Promise</code> å¯¹è±¡ï¼Œå› ä¸ºæ²¡æœ‰åœ¨å†…éƒ¨æ•æ‰æ‹’ç»çš„åŸå› ï¼Œæ‰€ä»¥æµè§ˆå™¨æ‰“å°å‡ºçº¢å­—é”™è¯¯ï¼ˆ<code>Uncaught</code>ï¼‰</li></ul><ul id="cf1f57dc-1133-4a2a-b69f-bb49fe666534" class="bulleted-list"><li style="list-style-type:circle">ä½†æ˜¯ç›´æ¥å°†é”™è¯¯ä½œä¸ºè¿”å›å€¼åœ¨å¯¹åº”çš„å¤„ç†ç¨‹åºä¸­è¿”å›ï¼Œ<code>p13</code> å°±æ˜¯ä¸€ä¸ªçŠ¶æ€ä¸º<strong><em>Fulfilled</em></strong><em> &lt;</em><strong>å…‘ç°</strong><em>&gt;</em>ï¼Œå€¼ä¸ºè¿”å›çš„é”™è¯¯å¯¹è±¡çš„<code>Promise</code> å®ä¾‹ï¼Œä¸”ä¸ä¼šè§¦å‘æµè§ˆå™¨çš„æœªæ•è·é”™è¯¯ä¿¡æ¯ï¼ˆå› ä¸ºè¿™ä¸ªé”™è¯¯å¯¹è±¡æœªè¢«æŠ›å‡ºï¼‰</li></ul><ul id="9663da3e-b98f-43b9-a29d-9e85fe7cfc6d" class="bulleted-list"><li style="list-style-type:circle">æ³¨æ„è¿™é‡Œä½¿ç”¨<code>setTimeout</code> å‡½æ•°<strong>å¼‚æ­¥</strong>æ‰“å°ä¸¤ä¸ª<code>Promise</code> å¯¹è±¡ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨<code>console.log()</code> ä¼šæ‰“å°å‡ºä¸¤ä¸ªå¤„äº<strong><em>Pending &lt;</em></strong>å¾…å®š<em>&gt;</em>çŠ¶æ€çš„<code>Promise</code> å¯¹è±¡ï¼Œå› ä¸º<code>then()</code> æ˜¯å¼‚æ­¥å‡½æ•°</li></ul></li></ul><hr id="0aabcb74-f662-4b15-a4d2-f2ff8fa44662"/><ul id="99a443c9-15b7-45b4-900d-92a74cc17e66" class="bulleted-list"><li style="list-style-type:disc">ä¸Šè¿°ä»‹ç»çš„<code>then()</code> è¿”å›å€¼çš„è°ƒç”¨è€…éƒ½æ˜¯è§£å†³çš„<code>Promise</code>å®ä¾‹â€”â€”å…¨åˆ©ç”¨<code>onResolved</code> å¤„ç†ç¨‹åºçš„è¿”å›å€¼è¿›è¡Œ<code>Promise.resolve()</code> çš„åŒ…è£…åè¿”å›ï¼›ç±»ä¼¼åœ°ï¼Œè€Œæ‹’ç»çš„<code>Promise</code> å®ä¾‹åœ¨<code>onRejected</code> å¤„ç†ç¨‹åºä¸­çš„è¿”å›å€¼ä¹Ÿä¼šè¢«<code>Promise.resolve()</code> åŒ…è£…åä½œä¸º<code>then()</code> çš„è¿”å›å€¼ï¼šè¿™å¯èƒ½æœ‰ç‚¹<strong>è¿åç›´è§‰</strong>ï¼ˆ<strong>counterintuitive</strong>ï¼‰ï¼Œä½†æ˜¯ï¼Œ<code>onRejected</code> å¤„ç†ç¨‹åºçš„ä»»åŠ¡å°±æ˜¯æ•è·<strong>å¼‚æ­¥é”™è¯¯ï¼ˆasynchronous errorï¼‰</strong>ï¼Œå› æ­¤<strong>æ‹’ç»å¤„ç†ç¨‹åº</strong>ï¼ˆ<strong>rejection handler</strong>ï¼‰åœ¨æ•è·å¼‚å¸¸é”™è¯¯åä¸æŠ›å‡ºå¼‚å¸¸æ˜¯ç¬¦åˆPromiseçš„è¡Œä¸ºçš„ï¼Œåº”è¯¥è¿”å›ä¸€ä¸ª<strong>è§£å†³</strong>ï¼ˆ<strong>resolved</strong>ï¼‰<code>Promise</code>å®ä¾‹; ä¸‹é¢çš„ä»£ç å°†ä¹‹å‰ä¾‹å­ä¸­çš„è§£å†³<code>Promise</code>å®ä¾‹æ›¿æ¢ä¸ºæ‹’ç»<code>Promise</code>å®ä¾‹<pre id="e0878260-b101-42ba-9a36-ba4b2acc830e" class="code"><code>// p.then()çš„è¿”å›å€¼
// 4ç§’åè¿›å…¥å…‘ç°çŠ¶æ€
let p5_ = new Promise((resolve, reject) =&gt; setTimeout(reject, 4000));
let reP5_ = p5_.then(() =&gt; {
  // onRjected
  console.log(&quot;p5 rejected&quot;);
  // è¿”å›p5_ä½œä¸ºp5_.thenè¿”å›å€¼(Promiseå…‘ç°)åŒ…è£…çš„å€¼
  return &quot;p5_&quot;;
});
setTimeout(console.log, 4000, reP5_); // ï¼ˆ4ç§’åæ‰“å°ï¼‰p5 rejected PromiseÂ {&lt;fulfilled&gt;: &#x27;p5_&#x27;}

// 3ç§’åè¿›å…¥å…‘ç°çŠ¶æ€
let p6_ = new Promise((resolve, reject) =&gt;
  setTimeout(() =&gt; {
    reject(&quot;foo&quot;);
  }, 500)
);
// ä¸ä¼ é€’ä»»ä½•å¤„ç†ç¨‹åº
let p7_ = p6_.then();
setTimeout(() =&gt; {
  console.log(p6_);
  console.log(p7_);
  console.log(p6_ === p7_);
}, 500); 
// åŠç§’åæ‰“å°
Uncaught (in promise) foo // è¿™é‡Œä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºæ²¡æœ‰å¯¹p7_çš„æ‹’ç»çŠ¶æ€æŠ›å‡ºçš„é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸€ç‚¹ä¸ä¸Šé¢çš„ä¾‹å­ä¸åŒ
// PromiseÂ {&lt;rejected&gt;: &#x27;foo&#x27;}
// PromiseÂ {&lt;rejected&gt;: &#x27;foo&#x27;} 
// false

// è¿”å›çš„Promiseå…‘ç°å†…éƒ¨å€¼éƒ½æ˜¯undefinedçš„ä¾‹å­
let p8_ = p6_.then(null, () =&gt; undefined);
let p9_ = p6_.then(null, () =&gt; {});
let p10_ = p6_.then(null, () =&gt; Promise.resolve());
setTimeout(() =&gt; {
  console.log(p8_);
  console.log(p9_);
  console.log(p10_);
}, 500);
// åŠç§’åæ‰“å°
// PromiseÂ {&lt;fulfilled&gt;: undefined}
// PromiseÂ {&lt;fulfilled&gt;: undefined}
// PromiseÂ {&lt;fulfilled&gt;: undefined}

// åœ¨å¤„ç†ç¨‹åºä¸­æŠ›å‡ºå¼‚å¸¸
const p11_ = Promise.reject(&quot;foo&quot;);
let p12_ = p11_.then(null, () =&gt; {
  throw &quot;baz&quot;;
});
setTimeout(() =&gt; {
  console.log(p12_);
}, 0);
let p13_ = p11_.then(null, () =&gt; Error(&quot;qux&quot;));
setTimeout(() =&gt; {
  console.log(p13_);
}, 0);
// é©¬ä¸Šæ‰“å°
Uncaught (in promise) baz // è¿™é‡Œå’Œä¸Šé¢çš„ä¾‹å­ç›¸åŒä¸ä¼šå› ä¸ºè¿”å›å€¼æ˜¯é”™è¯¯å¯¹è±¡è€Œæ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œè€Œæ˜¯å› ä¸ºæŠ›å‡ºé”™è¯¯è€Œæ‰“å°é”™è¯¯ä¿¡æ¯
// PromiseÂ {&lt;rejected&gt;: &#x27;baz&#x27;}
// PromiseÂ {&lt;fulfilled&gt;: Error: qux
   // at &lt;anonymous&gt;:9:34}</code></pre><ul id="497d2fa3-9f86-443f-9d1c-03c678b08633" class="bulleted-list"><li style="list-style-type:circle">å¯ä»¥çœ‹åˆ°ï¼Œå”¯ä¸€ä¸åŒçš„åœ°æ–¹åœ¨ç›´æ¥è°ƒç”¨<code>then()</code> ä¸ä¼ é€’ä»»ä½•å¤„ç†ç¨‹åºæ—¶ï¼Œæ‹’ç»çš„<code>Promise</code> å®ä¾‹å› ä¸ºé€ä¼ çš„åŸå‹ï¼Œ<code>then()</code> çš„è¿”å›å€¼ä¹Ÿæ˜¯æ–°çš„æ‹’ç»çš„<code>Promise</code>å®ä¾‹ï¼Œå› ä¸ºæ–°çš„æ‹’ç»<code>Promise</code> å®ä¾‹æŠ›å‡ºçš„é”™è¯¯æœªè¢«æ•è·ï¼Œæ‰€ä»¥æµè§ˆå™¨å¼•æ“æ‰“å°å‡ºçº¢è‰²é”™è¯¯<code>Uncaught</code></li></ul></li></ul><h2 id="fa59b667-0153-421d-8205-f7ea3ef207b0" class="">2.3.3 <code>Promise.prototype.catch()</code></h2><ul id="7ddb8909-a640-4e5d-9117-177bb11ae4e8" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.prototype.catch()</code> æ–¹æ³•ç”¨äºç»™Promiseæ·»åŠ <strong>æ‹’ç»å¤„ç†ç¨‹åº</strong>ï¼ˆ<strong>reject handler</strong>ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼š<code>onRejected</code>å¤„ç†ç¨‹åº</li></ul><ul id="2872f82d-8e87-4549-9438-a0dd351012a1" class="bulleted-list"><li style="list-style-type:disc">å®é™…ä¸Šå®ƒå°±æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œä½¿ç”¨<code>Promise.prototype.then()</code> èƒ½å®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œè°ƒç”¨å®ƒç›¸å½“äºè°ƒç”¨<code>Promise.prototype.then(null, onRejected)</code><pre id="fb987876-6e1a-4d90-8624-20a67a79e8b0" class="code"><code>let p = Promise.reject(&quot;reason&quot;);
let onRejected = function (e) {
  console.log(e);
  setTimeout(console.log, 0, &quot;rejected&quot;);
};

// ä¸¤ç§æ·»åŠ æ‹’ç»å¤„ç†ç¨‹åºçš„æ–¹å¼æ˜¯ä¸€æ ·çš„
p.then(null, onRejected); // reason \n rejected
p.catch(onRejected); // reason \n rejected</code></pre></li></ul><ul id="5921968e-1d26-4772-8371-8fed083d877b" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.prototype.catch()</code> è¿”å›ä¸€ä¸ªæ–°çš„<code>Promise</code> å®ä¾‹ï¼Œè¿™æ–¹é¢çš„è¡Œä¸ºå’Œ<code>Promise.prototype.then()</code> çš„<code>onRejected</code> å¤„ç†ç¨‹åºæ˜¯ä¸€æ ·çš„<pre id="ea573319-120c-403e-bc7b-c3e29cbdad6f" class="code"><code>let p1 = new Promise(() =&gt; {});
let p2 = p1.catch();
setTimeout(console.log, 0, p1); // PromiseÂ {&lt;pending&gt;}
setTimeout(console.log, 0, p2); // PromiseÂ {&lt;pending&gt;}
setTimeout(console.log, 0, p1 === p2); // false</code></pre></li></ul><h2 id="7271abf5-cd74-4d3d-97dd-033d086d3c62" class="">2.3.4 <code>Promise.prototype.finally()</code></h2><ul id="cc3740b9-e602-4142-82e2-d80c662b4f0b" class="bulleted-list"><li style="list-style-type:disc"> <code>Promise.prototype.finally()</code>æ–¹æ³•ç»™Promiseæ·»åŠ <code>onFinally</code> å¤„ç†ç¨‹åºï¼Œè¿™ä¸ªå¤„ç†ç¨‹åºåœ¨<code>Promise</code> å®ä¾‹è½¬æ¢ä¸º<strong>è§£å†³æˆ–æ‹’ç»çŠ¶æ€</strong>ï¼ˆ<strong>resolved or rejected state</strong>ï¼‰æ—¶éƒ½ä¼šæ‰§è¡Œ</li></ul><ul id="73c01966-c527-4973-bc24-a7a9e24ac04a" class="bulleted-list"><li style="list-style-type:disc">è¿™ä¸ªæ–¹æ³•å¯ä»¥é¿å…<code>onResolved</code> å’Œ<code>onRejected</code> å¤„ç†ç¨‹åºä¸­å‡ºç°<strong>å†—ä½™ä»£ç </strong>ï¼ˆ<strong>code duplication</strong>ï¼‰</li></ul><ul id="cc61c7d1-8cbb-4411-8642-66ecaf790007" class="bulleted-list"><li style="list-style-type:disc">ä½†æ˜¯<code>onFinally</code> å¤„ç†ç¨‹åºæ²¡æœ‰åŠæ³•çŸ¥é“Promiseçš„çŠ¶æ€æ˜¯è§£å†³è¿˜æ˜¯æ‹’ç»ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºæ·»åŠ <strong>æ¸…ç†ä»£ç ï¼ˆcleanupï¼‰</strong><pre id="50030d32-0720-4297-bba0-8ac31cc75879" class="code"><code>let p1 = Promise.resolve(&quot;resolved value&quot;);
let p2 = Promise.reject(&quot;rejected reason&quot;);

let onFinally = function () {
  setTimeout(console.log, 0, &quot;Finally!&quot;);
};

p1.finally(onFinally); // Finally!
p2.finally(onFinally); // Finally!
// è°·æ­Œæµè§ˆå™¨æ‰“å°
Uncaught (in promise) rejected reason</code></pre><ul id="5bee6f9e-299b-451a-8951-5cdfcea42af4" class="bulleted-list"><li style="list-style-type:circle">æ³¨æ„<code>onFinally</code> å¤„ç†ç¨‹åºæ²¡æœ‰å‚æ•°ï¼Œä¸èƒ½è·å–è°ƒç”¨è€…ï¼ˆ<code>Promise</code>å®ä¾‹ï¼‰çš„å†…éƒ¨å€¼ï¼ˆæ‹’ç»å’Œè§£å†³å¤„ç†ç¨‹åºå¯ä»¥è·å–åˆ°è°ƒç”¨è€…çš„å†…éƒ¨å€¼ï¼‰</li></ul><ul id="58fcbf6e-aeb9-4b58-aa34-ca5f830cf598" class="bulleted-list"><li style="list-style-type:circle">ä¸Šé¢<code>p2</code> è¢«æ‹’ç»ï¼Œæ‰€ä»¥å®ƒä¼šæŠ›å‡ºé”™è¯¯ï¼Œ<code>finally()</code> ä¸èƒ½åƒ<code>then()</code> å’Œ<code>catch()</code> ä¸€æ ·æ•è·é”™è¯¯ï¼Œæ‰€ä»¥nodeç¯å¢ƒä¼šç›´æ¥æŠ¥é”™ï¼ˆä¸èƒ½è¿è¡Œï¼‰ï¼Œè€Œè°·æ­Œæµè§ˆå™¨ä¼šæ‰“å°å‡º<code>Uncaght</code> çš„é”™è¯¯ä¿¡æ¯</li></ul></li></ul><ul id="01799993-a759-46a9-8816-43ad42bd1425" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.prototype.finally()</code> æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„<code>Promise</code> å®ä¾‹ï¼Œå®ƒè¿”å›çš„å®ä¾‹ä¸åŒä¸<code>Promise.prototype.catch()</code> å’Œ<code>Promise.prototype.then()</code> è¿”å›çš„å®ä¾‹ï¼Œå› ä¸º<code>onFinally</code> å¤„ç†ç¨‹åºè¢«è®¾ç½®ä¸ºä¸€ä¸ª<strong>çŠ¶æ€æ— å…³</strong>ï¼ˆ<strong>state-agnostic</strong>ï¼‰çš„æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨<strong>å¤§å¤šæ•°æƒ…å†µä¸‹</strong>å®ƒå°†è¡¨ç°ä¸ºçˆ¶Promiseçš„ä¼ é€’ï¼ˆ<strong>passthroughï¼Œé€ä¼ </strong>ï¼‰ï¼Œå¯¹äºå·²è§£å†³å’Œè¢«æ‹’ç»çŠ¶æ€éƒ½æ˜¯å¦‚æ­¤ï¼ˆå³è¿”å›çš„æ–°<code>Promise</code> å®ä¾‹çš„çŠ¶æ€å’Œå†…éƒ¨å€¼å’Œè°ƒç”¨è€…ä¸€è‡´ï¼‰<pre id="30c65963-72da-46b5-b23e-a02c56d73967" class="code"><code>let p = Promise.resolve(&quot;foo&quot;);
let pa = p.finally();
setTimeout(console.log, 0, p, pa); // PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;} PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;}
setTimeout(console.log, 0, p === pa); // false

let pb = p.finally(() =&gt; undefined);
let pc = p.finally(() =&gt; {});
let pd = p.finally(() =&gt; &#x27;bar&#x27;);
let pe = p.finally(() =&gt; Promise.resolve(&#x27;bar&#x27;));
let pf = p.finally(() =&gt; new Error(&#x27;qux&#x27;));
// æ‰“å°çš„Promiseå®ä¾‹å¼•ç”¨ä¸ªä¸ç›¸åŒï¼Œä½†æ˜¯çŠ¶æ€å’Œå†…éƒ¨å€¼å’Œpä¸€è‡´
setTimeout(console.log, 0, pb); // PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;}
setTimeout(console.log, 0, pc); // PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;}
setTimeout(console.log, 0, pd); // PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;} 
setTimeout(console.log, 0, pe); // PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;}
setTimeout(console.log, 0, pf); // PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;}</code></pre></li></ul><ul id="7acc1c52-15b9-44cc-93e7-9d02275351e7" class="bulleted-list"><li style="list-style-type:disc">å°‘æ•°æƒ…å†µä¸‹ï¼Œ<code>onFinally</code> ä¸ä¼šè¡¨ç°ä¸ºçˆ¶Promiseçš„ä¼ é€’<ul id="d336941b-3d15-418f-8e16-df44f1de3094" class="bulleted-list"><li style="list-style-type:circle">è¿”å›çš„æ˜¯ä¸€ä¸ªå¤„äº<strong><em>Pending &lt;</em></strong><strong>å¾…å®š</strong><em>&gt;</em>çŠ¶æ€çš„Promiseå®ä¾‹ï¼Œè¿”å›å¾…å®šPromiseå®ä¾‹</li></ul><ul id="5bf0eb0f-6181-4ed9-99c1-8cfbd2b546ab" class="bulleted-list"><li style="list-style-type:circle"><code>onFinally</code> å¤„ç†ç¨‹åºæŠ›å‡ºé”™è¯¯ï¼ŒåŒ…æ‹¬æ˜¾å¼æŠ›å‡ºé”™è¯¯ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªæ‹’ç»Promiseå®ä¾‹éšå¼æŠ›å‡ºï¼Œè¿”å›ç›¸åº”çš„æ‹’ç»<code>Promise</code>å®ä¾‹</li></ul><pre id="58c50826-fe5e-4b3a-a4af-9ca25ebc8ec1" class="code"><code>// è¿”å›å¾…å®šå’Œæ‹’ç»çš„æƒ…å†µ
let pg = p.finally(() =&gt; new Promise(() =&gt; {}));
let ph = p.finally(() =&gt; Promise.reject(&quot;reason&quot;));

setTimeout(console.log, 0, pg); // PromiseÂ {&lt;pending&gt;}
setTimeout(console.log, 0, ph); // PromiseÂ {&lt;rejected&gt;: &#x27;reason&#x27;}
// è°·æ­Œæµè§ˆå™¨çš„é”™è¯¯ä¿¡æ¯æ‰“å°
Uncaught (in promise) reason

let pi = p.finally(() =&gt; {
  throw new Error(&quot;baz&quot;);
});

setTimeout(console.log, 0, pi); 
// PromiseÂ {&lt;rejected&gt;: Error: baz
   // at &lt;anonymous&gt;:9:9
   // at &lt;anonymous&gt;}
// è°·æ­Œæµè§ˆå™¨çš„é”™è¯¯ä¿¡æ¯æ‰“å°
Uncaught (in promise) Error: baz
    at &lt;anonymous&gt;:9:9
    at &lt;anonymous&gt;</code></pre></li></ul><ul id="ce18caf5-2bed-4099-bbee-7c08f3bfe08c" class="bulleted-list"><li style="list-style-type:disc">å¯¹äºä¸Šé¢çš„ç‰¹æ®Šæƒ…å†µï¼Œè¿”å›å¤„äº<strong><em>Pending &lt;</em></strong><strong>å¾…å®š</strong><em>&gt;</em>çŠ¶æ€çš„Promiseå®ä¾‹å¹¶<strong>ä¸å¸¸è§</strong>ï¼Œå› ä¸ºè¿™ä¸ªå¾…å®šPromiseåªè¦ä¸€è§£å†³ï¼ˆresolvesï¼‰ï¼Œè¿”å›çš„æ–°æœŸçº¦å°±ä¼šè¢«é€ä¼ ä¸ºå’Œçˆ¶Promiseï¼ˆè°ƒç”¨è€…ï¼‰ä¸€æ ·çš„çŠ¶æ€å’Œå€¼çš„Promiseå®ä¾‹<pre id="8c041fe8-9a43-454b-972d-bfc3d2acc47f" class="code"><code>let p = Promise.resolve(&quot;foo&quot;);
// è¿”å›å¾…å®šçš„æœŸçº¦å¹¶ä¸å¸¸è§ï¼Œè¿™ä¸ªå¾…å®šçš„æœŸçº¦ä¸€æ—¦è¢«è§£å†³ï¼Œå°±ä¼šè¿”å›ä¸ºé€ä¼ çš„æ–°æœŸçº¦
// è¿”å›ä¸€ä¸ªå¾…å®šçš„æœŸçº¦ï¼Œè¿™ä¸ªæœŸçº¦åœ¨100msåä¼šè¢«è§£å†³
let pj = p.finally(
  () =&gt; new Promise((resolve, reject) =&gt; setTimeout(() =&gt; resolve(&quot;bar&quot;), 100))
);

setTimeout(console.log, 0, pj); // PromiseÂ {&lt;pending&gt;} 
// 0msæ—¶è¿”å›çš„å°±æ˜¯åœ¨onFinallyä¸­åˆ›å»ºçš„æ–°æœŸçº¦
setTimeout(console.log, 0, pj == p); // false

setTimeout(console.log, 200, pj); // PromiseÂ {&lt;fulfilled&gt;: &#x27;foo&#x27;} 
// 200msæ—¶è¿”å›çš„å°±æ˜¯é€ä¼ çš„å’Œè°ƒç”¨è€…ä¸€æ ·(çŠ¶æ€å’Œå†…éƒ¨å€¼)çš„æ–°æœŸçº¦
setTimeout(console.log, 200, pj == p); // false</code></pre><ul id="86126e2e-1004-483b-a14d-9c68da42136b" class="bulleted-list"><li style="list-style-type:circle">åœ¨0~100msæœŸé—´çš„<code>pj</code> æ˜¯åœ¨<code>onFinally</code> ç¨‹åºå¤„ç†ç¨‹åºä¸­ä¸´æ—¶åˆ›å»ºçš„å¾…å®šçŠ¶æ€çš„<code>Promise</code> ï¼Œå®ƒï¼ˆæŒ‡ä¸´æ—¶åˆ›å»ºçš„<code>Promise</code> å®ä¾‹ï¼‰è§£å†³åå°±æ˜¯å†…éƒ¨å€¼ä¸ºâ€™barâ€™çš„<strong><em>Fulfilled</em></strong><em> &lt;</em><strong>å…‘ç°</strong><em>&gt;</em>Promiseå®ä¾‹ï¼Œä½†æ˜¯ä¹‹å<code>pj</code> å°±æ˜¯ä¸€ä¸ªæ–°åˆ›å»ºçš„å’Œè°ƒç”¨è€…ä¸€æ ·çš„çŠ¶æ€å’Œå€¼çš„<code>Promise</code> å®ä¾‹ï¼ˆä¸æ˜¯ä¹‹å‰ä¸´æ—¶åˆ›å»ºçš„<code>Promise</code>å®ä¾‹ï¼‰</li></ul></li></ul><h2 id="d077e0ba-2888-4296-b747-d1e57fe1f069" class="">2.3.5 éé‡å…¥æœŸçº¦æ–¹æ³•ï¼ˆNon-Reentrant Promise Methodsï¼‰</h2><p id="01b22a2f-e126-48ed-b6cc-ae9b9f02e13c" class="">å…³äºå¯é‡å…¥å‡½æ•°å¯ä»¥æŸ¥çœ‹<a href="https://www.notion.so/reentrant-function-19a89b87fa6040d090f1f24bda16b9be"><span class="icon">ğŸª</span>å¯é‡å…¥å‡½æ•°ï¼ˆreentrant functionï¼‰</a> ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªå‡½æ•°åœ¨è°ƒç”¨æ‰§è¡Œå®Œå…¨ä¹‹å‰ï¼ˆè¢«ä¸­æ–­ï¼‰ï¼Œå®ƒèƒ½è¢«å®‰å…¨åœ°å†æ¬¡è°ƒç”¨ï¼ˆ<strong>safely called again</strong>ï¼‰ï¼ŒJavaScriptå…¸å‹çš„å¯é‡å…¥å‡½æ•°å°±æ˜¯<strong>ç”Ÿæˆå™¨</strong></p><hr id="31d155c0-3f96-4060-8d54-2c5fa07cc622"/><ul id="d5f53650-c464-4472-bc2c-bb39a4a3bf87" class="bulleted-list"><li style="list-style-type:disc">å½“ä¸€ä¸ª<code>Promise</code> å®ä¾‹è¿›å…¥<strong>è½åœ°çŠ¶æ€</strong>ï¼ˆ<strong>settled state</strong>ï¼‰æ—¶ï¼Œä¸è¯¥çŠ¶æ€ç›¸å…³çš„å¤„ç†ç¨‹åºä»…ä»…ä¼šè¢«<strong>æ’æœŸ</strong>ï¼ˆ<strong>scheduled</strong>ï¼‰ï¼Œè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œï¼ˆä¹Ÿå°±æ˜¯è¯´<code>then()</code>ï¼Œ<code>catch()</code> ç­‰å‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œä¼ é€’ç»™å®ƒä»¬çš„å¤„ç†ç¨‹åºå¼‚æ­¥æ‰§è¡Œï¼‰</li></ul><ul id="47d874b0-b8af-496d-ab16-4c0bdcacedb4" class="bulleted-list"><li style="list-style-type:disc">è¿™å°±å¯¼è‡´è·Ÿåœ¨è¿™ä¸ªå¤„ç†ç¨‹åºçš„ä»£ç ä¹‹åçš„<strong>åŒæ­¥ï¼ˆSynchronousï¼‰</strong>ä»£ç ä¸€å®šä¼šåœ¨å¤„ç†ç¨‹åºè¢«è°ƒç”¨ä¹‹å‰æ‰§è¡Œï¼Œå³ä½¿<code>Promise</code> å®ä¾‹ä¸€å¼€å§‹å°±æ˜¯ä¸<strong>æ–°é™„åŠ å¤„ç†ç¨‹åº</strong>ï¼ˆ<strong>newly attached handler</strong>ï¼‰å…³è”çš„çŠ¶æ€ï¼Œæ‰§è¡Œé¡ºåºä¹Ÿæ˜¯è¿™æ ·çš„</li></ul><ul id="e0df9b6b-4d78-46bf-a028-cb72ea053720" class="bulleted-list"><li style="list-style-type:disc">è¿™ç§ç‰¹æ€§ç”±JavaScript<strong>è¿è¡Œæ—¶</strong>ï¼ˆ<strong>runtime</strong>ï¼‰ä¿è¯ï¼Œè¢«ç§°ä¸ºâ€<strong>éé‡å…¥</strong>â€œï¼ˆ<strong>non-reentrancy</strong>ï¼‰ç‰¹æ€§<pre id="932f469b-07d5-489b-bc34-a4fa44110b3f" class="code"><code>// åˆ›å»ºè§£å†³çš„æœŸçº¦
let p = Promise.resolve();

// æ·»åŠ è§£å†³å¤„ç†ç¨‹åº
p.then(() =&gt; console.log(&quot;onResolved handler&quot;));

/// æ·»åŠ onFinallyå¤„ç†ç¨‹åº
p.finally(() =&gt; console.log(&quot;onFinally handler&quot;));

// åŒæ­¥è¾“å‡º
console.log(&quot;then() returns&quot;);
// å®é™…çš„è¾“å‡º
then() returns
onResolved handler
onFinally handler</code></pre><ul id="ef142e96-9f31-4a81-9aad-42a2deef6298" class="bulleted-list"><li style="list-style-type:circle">åœ¨ä¸€ä¸ª<strong><em>fulfilled</em></strong>&lt;<strong>å…‘ç°</strong>&gt;çŠ¶æ€Promiseå®ä¾‹ä¸Šè°ƒç”¨<code>then()</code>ä¼šæŠŠ<code>onResolved</code> å¤„ç†ç¨‹åºæ¨è¿›æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè°ƒç”¨<code>finally()</code> ä¼šæŠŠ<code>onFinally</code> å¤„ç†ç¨‹åºæ¨è¿›æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†è¿™ä¸ªä¸¤ä¸ªå¤„ç†ç¨‹åºåœ¨å½“å‰çº¿ç¨‹ä¸Šçš„åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆå‰ä¸ä¼šæ‰§è¡Œï¼Œå› æ­¤è·Ÿåœ¨<code>then()</code> å’Œ<code>finally()</code> åé¢çš„åŒæ­¥ä»£ç ä¸€å®šå…ˆäºå¤„ç†ç¨‹åºæ‰§è¡Œ</li></ul></li></ul><ul id="5b946885-92eb-4103-bfa1-454ff656dbdf" class="bulleted-list"><li style="list-style-type:disc">å®é™…ä¸Š<strong>éé‡å…¥ </strong>æœ€åŸºç¡€çš„<strong>å……åˆ†æ¡ä»¶</strong>å°±æ˜¯ä¸èƒ½è¢«<strong>ä¸­æ–­</strong>ï¼Œå› ä¸ºJavaScriptå•çº¿ç¨‹çš„ç¼˜æ•…ï¼Œå¯¹äºä¸¤ä¸ªéé‡å…¥çš„å¤„ç†ç¨‹åºè€Œè¨€ï¼Œè¿è¡Œæ—¶ä¸èƒ½åœ¨æ‰§è¡Œä¸€ä¸ªå¤„ç†ç¨‹åºçš„ä¸­é€”è¢«ä¸­æ–­æ‰§è¡ŒåŒæ­¥è¾“å‡ºä»£ç ï¼Œæ‰€ä»¥ä¼šå…ˆæ‰§è¡Œå®Œåç»­æ‰€æœ‰çš„åŒæ­¥ä»£ç å†æ‰§è¡Œä¸¤ä¸ªå¤„ç†ç¨‹åº</li></ul><hr id="efdc4bf4-e36a-4bb5-9ae9-af28da3f331a"/><ul id="7b4925a8-333b-4585-8aad-f02502714e11" class="bulleted-list"><li style="list-style-type:disc">å…ˆæ·»åŠ å¤„ç†ç¨‹åºåè§£å†³Promiseå…·æœ‰ä¸€æ ·çš„æ•ˆæœï¼ˆå³å…ˆè®©å¤„äº<strong><em>Pending</em></strong>&lt;ç­‰å¾…&gt;çŠ¶æ€çš„æœŸçº¦è°ƒç”¨<code>then()</code> ï¼Œç„¶åè°ƒç”¨åŒæ­¥æ–¹æ³•è§£å†³Promiseè®©å…¶è½åœ°çŠ¶æ€ï¼Œæœ€åä¹¦å†™åŒæ­¥ä»£ç ï¼Œè¿™ä¸ªæ—¶å€™çš„åŒæ­¥ä»£ç ä»ç„¶å‘ç”Ÿåœ¨<code>then()</code> æ‰§è¡Œå¤„ç†ç¨‹åºå‰ï¼‰ï¼Œåœ¨æ·»åŠ å¤„ç†ç¨‹åºä¹‹åï¼ŒåŒæ­¥ä»£ç æ‰æ”¹å˜PromiseçŠ¶æ€ï¼Œé‚£ä¹ˆå¤„ç†ç¨‹åºä»ç„¶ä¼šåŸºäºè¯¥çŠ¶æ€å˜åŒ–è¡¨ç°å‡º<strong>éé‡å…¥</strong>ç‰¹æ€§ï¼Œå¦‚ä¸‹<pre id="96da4ed8-2910-4be1-b332-f3a09c3677ef" class="code"><code>let synchronousResolve = null;

let p1 = new Promise((resolve) =&gt; {
  synchronousResolve = function () {
    console.log(&quot;1: invoking resolve()&quot;);
    resolve();
    console.log(&quot;2: resolve return&quot;);
  };
});

p1.then(() =&gt; console.log(&quot;4:then() handler executes&quot;));

synchronousResolve();
console.log(&quot;3: synchronousResolve() returns&quot;);
// å®é™…è¾“å‡º
1: invoking resolve()
2: resolve return
3: synchronousResolve() returns
4:then() handler executes</code></pre><ul id="1bea606e-a028-4b71-9ae1-b372134d854b" class="bulleted-list"><li style="list-style-type:circle"><code>p1</code> çš„çŠ¶æ€å˜åŒ–å‘ç”Ÿåœ¨æ·»åŠ å¤„ç†å™¨ä¹‹åï¼Œå¤„ç†å™¨ç¨‹åºä¹Ÿä¼šç­‰åˆ°è¿è¡Œçš„æ¶ˆæ¯é˜Ÿåˆ—è®©å®ƒå‡ºåˆ—æ—¶æ‰ä¼šæ‰§è¡Œ</li></ul></li></ul><ul id="48ffe712-0018-4d8b-9c38-d2bf9f7bb6c4" class="bulleted-list"><li style="list-style-type:disc">éé‡ç”¨ç‰¹æ€§é€‚ç”¨äº<code>onResolved</code>/<code>onRejected</code>å¤„ç†ç¨‹åºï¼Œ<code>catch()</code> å¤„ç†ç¨‹åºå’Œ<code>finally()</code> å¤„ç†ç¨‹åºï¼Œä¸‹é¢çš„ä¾‹å­ä¸­çš„å¤„ç†ç¨‹åºéƒ½åªèƒ½å¼‚æ­¥æ‰§è¡Œ<pre id="06162380-33d7-4253-8cf7-b49afcc11231" class="code"><code>let pa = Promise.resolve();
let pb = Promise.reject();
let pc = Promise.reject();
let pd = Promise.resolve();

// è¿›å…¥è½åœ°çŠ¶æ€æ—¶è°ƒç”¨å¯¹åº”çš„å¤„ç†ç¨‹åº
pa.then(() =&gt; console.log(&quot;5: pa.then() onResolved&quot;));
pb.then(null, () =&gt; console.log(&quot;6: pb.then() onRejected&quot;));
pc.catch(() =&gt; console.log(&quot;7: pc.catch onRejected&quot;));
pd.finally(() =&gt; console.log(&quot;8: pd.finally onFinally&quot;));

console.log(&quot;1: pa.then() returns&quot;);
console.log(&quot;2: pb.then() returns&quot;);
console.log(&quot;3: pc.catch() returns&quot;);
console.log(&quot;4: pd.finally() returns&quot;);
// æ‰“å°ç»“æœ
1: pa.then() returns
2: pb.then() returns
3: pc.catch() returns
4: pd.finally() returns
4:then() handler executes
5: pa.then() onResolved
6: pb.then() onRejected
7: pc.catch onRejected
8: pd.finally onFinally</code></pre></li></ul><h2 id="75f01ae3-df67-4ef6-9f01-329bdeae4845" class="">2.3.6 ä¸´è¿‘å¤„ç†ç¨‹åºçš„æ‰§è¡Œé¡ºåºï¼ˆSibling Handler Order of Executionï¼‰</h2><ul id="f99eec99-c61d-4a28-a674-7f9cc596ff6d" class="bulleted-list"><li style="list-style-type:disc">å¦‚æœç»™Promiseæ·»åŠ å¤šä¸ªå¤„ç†ç¨‹åºï¼Œå½“æœŸçº¦çŠ¶æ€å˜åŒ–æ—¶ï¼Œç›¸å…³å¤„ç†ç¨‹åºä¼šæŒ‰ç…§æ·»åŠ å®ƒä»¬çš„å±é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œæ— è®ºæ˜¯<code>then()</code>,<code>catch()</code> ,<code>finally()</code> æ·»åŠ çš„å¤„ç†ç¨‹åºéƒ½æ˜¯å¦‚æ­¤ï¼ˆè¿™ä¸€ç‚¹åœ¨ä¸Šä¸€èŠ‚çš„ä¾‹å­ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ï¼‰<pre id="2b6e6725-d445-4306-96d8-802d64116a43" class="code"><code>// ä¸´è¿‘å¤„ç†ç¨‹åºçš„é¡ºåº
let p1 = Promise.resolve();
let p2 = Promise.reject();

p1.then(() =&gt; console.log(1));
p1.then(() =&gt; setTimeout(console.log, 0, 4));

p2.catch(() =&gt; console.log(2));
p2.catch(() =&gt; setTimeout(console.log, 0, 5));

p1.finally(() =&gt; console.log(3));
p1.finally(() =&gt; setTimeout(console.log, 0, 6));
// æ‰“å°
1
2
3
4
5
6</code></pre></li></ul><h2 id="82f1a145-3849-48bb-859d-279f3a4f1479" class="">2.3.7 ä¼ é€’è§£å†³å€¼å’Œæ‹’ç»ç†ç”±ï¼ˆResolved Value and Rejected Reason Passingï¼‰</h2><ul id="212a1d62-86df-4476-9437-604fb33f505c" class="bulleted-list"><li style="list-style-type:disc">åˆ°äº†<strong>è½å®šçŠ¶æ€</strong>ï¼ˆ<strong>settled state</strong>ï¼‰åï¼Œpromiseä¼šæä¾›å…¶è§£å†³å€¼ï¼ˆå¦‚æœå…‘ç°ï¼Œfulfilledï¼‰è·å–æ‹’ç»ç†ç”±ï¼ˆå¦‚æœæ‹’ç»ï¼Œrejectedï¼‰ç»™ç›¸å…³çŠ¶æ€çš„å¤„ç†ç¨‹åºï¼Œæ‹¿åˆ°è¿”å›å€¼åï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥å¯¹è¿™ä¸ªå€¼è¿›è¡Œæ“ä½œï¼Œè¿™ç§ä¸²è¡Œçš„åœºæ™¯å¯¹éœ€è¦è¿›è¡Œ<strong>è¿ç»­çš„ä¸²è¡Œè®¡ç®—å—</strong>ï¼ˆ<strong>successive blocks of serial computation</strong>ï¼‰æ—¶å¾ˆæ–¹ä¾¿</li></ul><ul id="e1b2262e-b642-4785-af10-8063a8a3e783" class="bulleted-list"><li style="list-style-type:disc">ä¾‹å¦‚ï¼Œç¬¬ä¸€æ¬¡<strong>ç½‘ç»œè¯·æ±‚</strong>ï¼ˆ<strong>network request</strong>ï¼‰è¿”å›JSONæ˜¯å‘é€ç¬¬äºŒæ¬¡è¯·æ±‚å¿…é¡»çš„æ•°æ®ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡è¯·æ±‚è¿”å›çš„å€¼å°±åº”è¯¥ä¼ ç»™<code>onResolved</code> å¤„ç†ç¨‹åºç»§ç»­å¤„ç†ï¼›å½“ç„¶å¤±è´¥çš„ç½‘ç»œè¯·æ±‚ä¹Ÿåº”è¯¥æŠŠHTTPçŠ¶æ€ç ä¼ ç»™<code>onRejected</code> å¤„ç†ç¨‹åº</li></ul><ul id="505ccc73-7424-45d1-a8cb-4436f2f5716e" class="bulleted-list"><li style="list-style-type:disc">è§£å†³çš„å€¼å’Œæ‹’ç»ç†ç”±æ˜¯åœ¨æ‰§è¡Œå‡½æ•°ï¼ˆexecutorï¼‰ä¸­åˆ†åˆ«ä½œä¸º<code>resolve()</code> å’Œ<code>reject()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°å¾€åä¼ çš„ï¼Œç„¶åè¿™äº›å€¼åˆä¼šä¼ ç»™å®ƒä»¬å„è‡ªçš„å¤„ç†ç¨‹åºï¼Œä½œä¸º<code>onResolved</code>æˆ–<code>onRejected</code> å¤„ç†ç¨‹åºçš„å”¯ä¸€å‚æ•°ï¼Œä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†ä¸Šè¿°ä¼ é€’çš„è¿‡ç¨‹<pre id="596a9232-0889-4f75-9a00-19ecdbc595e1" class="code"><code>let p1 = new Promise((resolve, reject) =&gt; resolve(&quot;foo&quot;));
let p2 = new Promise((resolve, reject) =&gt; reject(&quot;reason&quot;));

p1.then((value) =&gt; console.log(value)); // foo
p2.catch((reason) =&gt; console.log(reason)); // reason</code></pre><ul id="d172777b-1caa-4a12-9680-e178c19737ac" class="bulleted-list"><li style="list-style-type:circle">å°†<code>p1</code>å’Œ<code>p2</code> èµ‹å€¼ä¸º<code>Promise.resolve()</code> å’Œ<code>Promise.reject()</code> é™æ€æ–¹æ³•åˆ›å»ºçš„å…‘ç°æœŸçº¦å’Œæ‹’ç»æœŸçº¦å…·æœ‰ä¸€æ ·çš„æ•ˆæœ</li></ul></li></ul><h2 id="f50719a8-e766-40e1-ba50-9aeb861fd34b" class="">2.3.8 æ‹’ç»æœŸçº¦ä¸æ‹’ç»é”™è¯¯å¤„ç†ï¼ˆRejecting Promises and Rejection Error Handlingï¼‰</h2><h3 id="03d69894-3966-448e-b166-eb88fbde5879" class="">2.3.8.1 æ‹’ç»æœŸçº¦</h3><ul id="17f30567-30fe-4b8f-95c2-34e1806ec556" class="bulleted-list"><li style="list-style-type:disc">æ‹’ç»ä¸€ä¸ª<code>Promise</code>å®ä¾‹ç›¸å½“äºä¸€ä¸ª<code>throw</code>è¡¨è¾¾å¼ï¼Œå®ƒä»¬éƒ½ä»£è¡¨ä¸€ç§ç¨‹åºçŠ¶æ€ï¼Œå³éœ€è¦<strong>ä¸­æ–­</strong>ï¼ˆ<strong>discontinuation</strong>ï¼‰æˆ–ç‰¹æ®Š<strong>åç»­</strong>ï¼ˆ<strong>subsequent</strong>ï¼‰å¤„ç†</li></ul><ul id="d140e832-46b8-43d8-9760-f38544897295" class="bulleted-list"><li style="list-style-type:disc">å°†ä¸€ä¸ª<code>Promise</code> ç”±ç­‰å¾…çŠ¶æ€å˜ä¸ºæ‹’ç»çŠ¶æ€çš„æ‹’ç»æœŸçº¦åŠ¨ä½œåŒ…å«<ul id="3ca0671c-bae4-4f35-9643-7323609bebe8" class="bulleted-list"><li style="list-style-type:circle">åœ¨<code>Promise</code> å®ä¾‹çš„æ‰§è¡Œå‡½æ•°ï¼ˆexecutorï¼‰ä¸­æŠ›å‡ºé”™è¯¯ï¼Œé”™è¯¯å¯¹è±¡ä¼šä½œä¸ºæ‹’ç»çš„åŸå› </li></ul><ul id="ab6e57a0-801e-4328-9ec3-344057a90762" class="bulleted-list"><li style="list-style-type:circle">åœ¨<code>Promise</code> å®ä¾‹çš„æ‰§è¡Œå‡½æ•°ä¸­è°ƒç”¨æ‰§è¡Œå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°<code>reject()</code> éšå¼æŠ›å‡ºå¼‚å¸¸ï¼Œ<code>reject()</code> çš„å‚æ•°ä¼šæ‹’ç»çš„åŸå› </li></ul><ul id="e771b0a0-d638-4283-9dff-9fdb4aff60ec" class="bulleted-list"><li style="list-style-type:circle">åœ¨<code>Promise</code> å®ä¾‹çš„å¤„ç†ç¨‹åºä¸­æŠ›å‡ºé”™è¯¯ï¼Œé”™è¯¯å¯¹è±¡ä¼šä½œä¸ºæ‹’ç»çš„åŸå› </li></ul><ul id="928f72c7-4491-49cc-8405-de526d61dfbc" class="bulleted-list"><li style="list-style-type:circle">åœ¨<code>Promise</code> å®ä¾‹çš„å¤„ç†ç¨‹åºä¸­è¿”å›æ‹’ç»çš„<code>Promise</code> å®ä¾‹</li></ul><ul id="0fb12b64-27e8-4782-a2cb-a3e3ff9221b6" class="bulleted-list"><li style="list-style-type:circle">ç›´æ¥è°ƒç”¨<code>Promise.reject()</code> æ–¹æ³•</li></ul><hr id="dd3eadb8-5eaf-4a6a-b7c5-533d99a47d70"/><ul id="3f064f4c-baad-46e8-8518-e74cf8ca05b1" class="bulleted-list"><li style="list-style-type:circle">ä¾‹å­å¦‚ä¸‹<pre id="8abfeec5-6c40-4bda-8484-b3c71ea33145" class="code"><code>// æ‹’ç»æœŸçº¦
let p1 = new Promise((resolve, reject) =&gt; reject(Error(&quot;foo&quot;)));
let p2 = new Promise((resolve, reject) =&gt; {
  throw new Error(&quot;foo&quot;);
});
let p3 = Promise.resolve().then(
  () =&gt; new Promise((resolve, reject) =&gt; reject(new Error(&quot;foo&quot;)))
);
let p4 = Promise.resolve().then(() =&gt; {
  throw new Error(&quot;foo&quot;);
});

let p5 = Promise.reject(new Error(&quot;foo&quot;));
setTimeout(console.log, 0, p1);
setTimeout(console.log, 0, p2);
setTimeout(console.log, 0, p3);
setTimeout(console.log, 0, p4);
setTimeout(console.log, 0, p5);
// æ‰“å°ç»“æœ
PromiseÂ {&lt;rejected&gt;: Error: foo
    at &lt;anonymous&gt;:2:50
    at new Promise (&lt;anonymous&gt;)
    at &lt;anonymous&gt;:2:10}
PromiseÂ {&lt;rejected&gt;: Error: foo
    at &lt;anonymous&gt;:4:9
    at new Promise (&lt;anonymous&gt;)
    at &lt;anonymous&gt;:3:10}
PromiseÂ {&lt;rejected&gt;: Error: foo
    at &lt;anonymous&gt;:7:49
    at new Promise (&lt;anonymous&gt;)
    at &lt;anonymous&gt;:7:9}
PromiseÂ {&lt;rejected&gt;: Error: foo
    at &lt;anonymous&gt;:10:9}
PromiseÂ {&lt;rejected&gt;: Error: foo
    at &lt;anonymous&gt;:13:25}
// åŒæ—¶ä¼šæŠ›å‡º5ä¸ªæœªæ•è·çš„é”™è¯¯ï¼ˆçº¢å­—ï¼‰
Uncaught (in promise) Error: foo Ã— 5
...</code></pre></li></ul></li></ul><ul id="90187f56-99b7-4f02-a83f-628687b2fb50" class="bulleted-list"><li style="list-style-type:disc">æœŸçº¦å¯ä»¥ä½¿ç”¨ä»»ä½•ç†ç”±æ‹’ç»ï¼ŒåŒ…æ‹¬<code>undefined</code> ï¼Œä½†æ˜¯æœ€å¥½ç»Ÿä¸€ä½¿ç”¨é”™è¯¯å¯¹è±¡ï¼Œè¿™æ ·åšä¸»è¦æ˜¯å› ä¸ºåˆ›å»ºé”™è¯¯å¯¹è±¡å¯ä»¥è®©æµè§ˆå™¨ä¸ä¼šé”™è¯¯å¯¹è±¡ä¸­çš„<strong>æ ˆè¿½è¸ªä¿¡æ¯</strong>(<strong>capture the stack trace</strong>)ï¼Œè€Œè¿™äº›ä¿¡æ¯å¯¹è°ƒè¯•éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚å‰é¢æµè§ˆå™¨æŠ›å‡ºçš„5ä¸ªæœªæ•è·çš„é”™è¯¯<pre id="e08bd0bd-21e8-4e2d-a101-7dc30b836775" class="code"><code>Uncaught (in promise) Error: foo
    at &lt;anonymous&gt;:2:50
    at new Promise (&lt;anonymous&gt;)
    at &lt;anonymous&gt;:2:10
Uncaught (in promise) Error: foo
    at &lt;anonymous&gt;:4:9
    at new Promise (&lt;anonymous&gt;)
    at &lt;anonymous&gt;:3:10
Uncaught (in promise) Error: foo
    at &lt;anonymous&gt;:13:25
Uncaught (in promise) Error: foo
    at &lt;anonymous&gt;:10:9
Uncaught (in promise) Error: foo
    at &lt;anonymous&gt;:7:49
    at new Promise (&lt;anonymous&gt;)
    at &lt;anonymous&gt;:7:9</code></pre></li></ul><ul id="80a150ea-1136-45ab-8876-6afef232e251" class="bulleted-list"><li style="list-style-type:disc">æ‰€æœ‰é”™è¯¯éƒ½æ˜¯<strong>å¼‚æ­¥</strong>ï¼ˆ<strong>asynchronously</strong>ï¼‰æŠ›å‡ºä¸”æœªå¤„ç†çš„ï¼Œé€šè¿‡é”™è¯¯å¯¹è±¡æ•è·çš„æ ˆè¿½è¸ªä¿¡æ¯å±•ç¤ºäº†é”™è¯¯å‘ç”Ÿçš„è·¯å¾„ï¼›åŒæ—¶ï¼Œéœ€è¦æ³¨æ„æµè§ˆå™¨<strong>æŠ›å‡ºé”™è¯¯çš„é¡ºåºï¼šp1 p2 p5 p4 p3</strong>,ï¼ˆæ‰“å°Promiseå®ä¾‹çš„é¡ºåºæ˜¯æ­£å¸¸çš„p1, p2, p3, p4, p5ï¼‰,è¿™æ˜¯å› ä¸º<code>p1</code>, <code>p2</code> éƒ½æ˜¯åœ¨æ‰§è¡Œå‡½æ•°ä¸­å°±æŠ›å‡ºé”™è¯¯ï¼Œè€Œ<code>p5</code> ä½¿ç”¨é™æ€æ–¹æ³•çš„æ–¹å¼<a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6.html">ç­‰åŒäº</a>åœ¨æ‰§è¡Œå‡½æ•°ä¸­å°±æŠ›å‡ºé”™è¯¯ï¼Œå®ƒåº”è¯¥æ’åœ¨<code>p1</code>å’Œ<code>p2</code>åï¼Œè€Œ<code>p3</code>å’Œ<code>p4</code> éƒ½ä½¿ç”¨äº†<code>then()</code> æ–¹æ³•åœ¨ç›¸åº”çš„å¤„ç†ç¨‹åºä¸­æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦åœ¨<strong>è¿è¡Œæ—¶æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼ˆ<strong>runtimeâ€™s message queue</strong>ï¼‰ä¸­<strong>æ·»åŠ </strong>å¤„ç†ç¨‹åºï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æœ€ç»ˆæŠ›å‡ºçš„æœªæ•è·é”™è¯¯ä¹‹å‰è¿˜ä¼šåˆ›å»ºå¦ä¸€ä¸ª<code>Promise</code>å®ä¾‹ï¼Œåˆå› ä¸º<code>p3</code> éœ€è¦é¢å¤–åˆ›å»º2ä¸ªPromiseå®ä¾‹è€Œ<code>p4</code> åªéœ€è¦é¢å¤–åˆ›å»º1ä¸ªPromiseå®ä¾‹ï¼Œæ‰€ä»¥<code>p4</code> æŠ›å‡ºçš„é”™è¯¯ä¿¡æ¯åœ¨<code>p3</code> ä¹‹å‰</li></ul><ul id="d9e1c01b-45cb-48b3-b041-45b281ea8477" class="bulleted-list"><li style="list-style-type:disc">è¿™ä¸ªä¾‹å­åŒæ ·æ­ç¤ºäº†å¼‚æ­¥é”™è¯¯æœ‰æ„æ€çš„å‰¯ä½œç”¨ï¼š<ul id="6bd51c45-9601-4a15-b390-c5a3137bbd98" class="bulleted-list"><li style="list-style-type:circle">æ­£å¸¸æƒ…å†µä¸‹é€šè¿‡<code>throw</code> å…³é”®å­—æŠ›å‡ºé”™è¯¯æ—¶ï¼ŒJavaScriptè¿è¡Œæ—¶çš„é”™è¯¯å¤„ç†æœºåˆ¶ä¼šåœæ­¢æ‰§è¡ŒæŠ›å‡ºé”™è¯¯ä¹‹åçš„ä»»ä½•æŒ‡ä»¤<pre id="51d594cf-bf4f-4059-88df-b195e8231356" class="code"><code>throw Error(&quot;foo&quot;);
console.log(&quot;bar&quot;); // è¿™ä¸€è¡Œä¸ä¼šæ‰§è¡Œ
// æŠ›å‡ºå¼‚å¸¸ä¿¡æ¯
Uncaught Error: foo</code></pre></li></ul><ul id="6c85f514-278b-444a-ae32-d609a5514889" class="bulleted-list"><li style="list-style-type:circle">ä½†æ˜¯ï¼Œåœ¨PromiseæŠ›å‡ºé”™è¯¯æ—¶ï¼Œå› ä¸ºé”™è¯¯å®é™…ä¸Šæ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å¼‚æ­¥æŠ›å‡ºçš„ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šé˜»æ­¢è¿è¡Œæ—¶ç»§ç»­æ‰§è¡ŒåŒæ­¥æŒ‡ä»¤ï¼ˆå³åŒæ­¥å’Œå¼‚æ­¥æ“ä½œå…·æœ‰ä¸€å®šçš„ç‹¬ç«‹æ€§ï¼Œä½†æ˜¯nodeç¯å¢ƒä¸‹æŠ›å‡ºå¼‚æ­¥é”™è¯¯ä¹Ÿä¼šç«‹é©¬ç»ˆæ­¢æ‰§è¡Œï¼‰<pre id="abce9240-fd60-45af-b69b-73b49cba81f0" class="code"><code>// å¼‚æ­¥æŠ›å‡ºé”™è¯¯
Promise.reject(Error(&quot;foo&quot;))
console.log(bar); // ä¼šæ‰§è¡Œ
// Uncaught (in promise) Error: foo</code></pre></li></ul></li></ul><h3 id="f766aa03-bc39-4acb-90a9-a7d80ed0b8b4" class="">2.3.8.2 æ‹’ç»é”™è¯¯å¤„ç†</h3><ul id="cae1c34d-0ed4-4d5c-ab83-a32b01487c2b" class="bulleted-list"><li style="list-style-type:disc">æ‹’ç»çš„Promiseä¼šéšå¼æŠ›å‡ºå¼‚æ­¥é”™è¯¯ï¼Œå¼‚æ­¥é”™è¯¯åªèƒ½é€šè¿‡å¼‚æ­¥çš„<code>onRejected</code>å¤„ç†ç¨‹åºè¿›è¡Œæ•è·ï¼Œè€Œä¸èƒ½ä½¿ç”¨åŒæ­¥çš„<code>try/catch</code> è¯­å¥è¿›è¡Œæ•è·<pre id="d0279a9f-f74f-444b-8026-a37c7dec8e82" class="code"><code>Promise.reject(Error(&quot;foo&quot;)).catch(e =&gt; console.log(e)) 
// Error: foo
  // at &lt;anonymous&gt;:1:16</code></pre><figure class="block-color-red_background callout" style="white-space:pre-wrap;display:flex" id="66041bf4-efff-44d1-a1a9-99f2cfdb4bc0"><div style="font-size:1.5em"><span class="icon">ğŸš«</span></div><div style="width:100%">try {
  Promise.reject(Error(&quot;foo&quot;));
} catch (error) {} // é”™è¯¯çš„æ•è·æ–¹å¼</div></figure></li></ul><ul id="50ba2d96-4e42-4bdb-8dc0-c30b0c623a51" class="bulleted-list"><li style="list-style-type:disc">ä½†æ˜¯åœ¨æ‰§è¡Œå‡½æ•°ï¼ˆ<code>executor</code>ï¼‰ä¸­çš„é”™è¯¯ï¼Œåœ¨è§£å†³å’Œå†³ç»Promiseå‰ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨<code>try/catch</code> åœ¨æ‰§è¡Œå‡½æ•°ä¸­æ•è·é”™è¯¯ï¼ˆå› ä¸ºæ‰§è¡Œå‡½æ•°åŒæ­¥æ‰§è¡Œï¼‰<pre id="65e296dc-d828-43ef-991d-9b1b38b204f0" class="code"><code>// åœ¨æ‰§è¡Œå‡½æ•°ä¸­ä½¿ç”¨try catch
let p = new Promise((resolve, reject) =&gt; {
  try {
    throw new Error(&quot;foo&quot;);
  } catch (error) {
    console.log(error);
// Error: foo
//    at &lt;anonymous&gt;:4:11
//    at new Promise (&lt;anonymous&gt;)
//    at &lt;anonymous&gt;:2:9
  }
  resolve();
});
setTimeout(console.log, 0, p); // PromiseÂ {&lt;fulfilled&gt;: undefined}</code></pre></li></ul><ul id="a4ce8d52-ee2d-468c-9612-4a2cf697bf39" class="bulleted-list"><li style="list-style-type:disc"><code>then()</code> å’Œ<code>catch()</code> çš„<code>onRejected</code> å¤„ç†ç¨‹åºåœ¨<strong>è¯­ä¹‰</strong>ï¼ˆ<strong>semantics</strong>ï¼‰ä¸Šç›¸å½“äº<code>try/catch</code> å‡ºå‘ç‚¹éƒ½æ˜¯æ•è·é”™è¯¯ä¹‹åå°†å…¶<strong>éš”ç¦»</strong>ï¼ˆ<strong>neutralize</strong>ï¼‰ï¼ŒåŒæ—¶ä¸å½±å“æ­£å¸¸é€»è¾‘æ‰§è¡Œï¼Œä¸ºæ­¤ï¼Œ<code>onRejected</code> å¤„ç†ç¨‹åºçš„ä»»åŠ¡åº”è¯¥æ˜¯åœ¨æ•è·å¼‚æ­¥é”™è¯¯ä¹‹åè¿”å›ä¸€ä¸ª<a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6.html"><strong>è§£å†³</strong></a><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6.html">çš„æœŸçº¦</a><pre id="b0ffe373-07f1-414b-8d6a-39f45944a203" class="code"><code>// åŒæ­¥é”™è¯¯å¤„ç†å’Œå¼‚æ­¥é”™è¯¯å¤„ç†
console.log(&quot;å¼€å§‹åŒæ­¥é”™è¯¯å¤„ç†&quot;);
try {
  throw new Error(&quot;foo&quot;);
} catch (error) {
  console.log(&quot;æ•è·é”™è¯¯:&quot;, error.toString());
}
console.log(&quot;ç»“æŸåŒæ­¥é”™è¯¯å¤„ç†&quot;);

new Promise((resolve, reject) =&gt; {
  console.log(&quot;å¼€å§‹å¼‚æ­¥æ‹’ç»é”™è¯¯å¤„ç†&quot;);
  reject(new Error(&quot;foo&quot;));
})
  .catch((reason) =&gt; {
    console.log(&quot;æ•è·å¼‚æ­¥é”™è¯¯ï¼š&quot;, reason.toString());
  })
  .then(() =&gt; {
    console.log(&quot;ç»“æŸå¼‚æ­¥æ‹’ç»é”™è¯¯å¤„ç†&quot;);
  });
// æ‰“å°
å¼€å§‹åŒæ­¥é”™è¯¯å¤„ç†
æ•è·é”™è¯¯: Error: foo
ç»“æŸåŒæ­¥é”™è¯¯å¤„ç†
å¼€å§‹å¼‚æ­¥æ‹’ç»é”™è¯¯å¤„ç†
æ•è·å¼‚æ­¥é”™è¯¯ï¼š Error: foo
ç»“æŸå¼‚æ­¥æ‹’ç»é”™è¯¯å¤„ç†</code></pre></li></ul><h1 id="53dfa334-9baf-47ad-a9a4-df20b66ea1e8" class="">2.4 æœŸçº¦è¿é”ä¸æœŸçº¦åˆæˆï¼ˆPromise Chaining and Compositionï¼‰</h1><p id="a90910ef-763d-40d3-93c2-348387294a55" class="">Compositionï¼Œç»„æˆï¼Œæ„æˆä¹‹æ„</p><p id="8feb8414-e9cf-4871-a7d0-38e695be3006" class="">å¤šä¸ªPromiseå®ä¾‹<strong>ç»„åˆåœ¨ä¸€èµ·</strong>ï¼ˆ<strong>Combining together</strong>ï¼‰å¯ä»¥æ„æˆå¼ºå¤§çš„<strong>ä»£ç é€»è¾‘</strong>ï¼ˆ<strong>code patterns</strong>ï¼‰ï¼Œè¿™ç§ç»„åˆè¡Œä¸ºæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š<div class="indented"><p id="aa691824-1c22-4e7b-831d-8ca9446ace84" class=""><strong>æœŸçº¦è¿é”</strong>ï¼ˆ<strong>Promise Chaining</strong>ï¼‰ï¼Œå°±æ˜¯ä¸€ä¸ªPromiseæ¥ä¸€ä¸ªPromiseåœ°<strong>æ‹¼æ¥ï¼ˆsequencingï¼‰</strong></p><p id="9d633b51-8b2e-453d-9cb1-9494e1cac328" class=""><strong>æœŸçº¦åˆæˆ</strong>ï¼ˆ<strong>Promise Composition</strong>ï¼‰ï¼Œå°†å¤šä¸ªPromiseç»„åˆæˆä¸€ä¸ªPromise</p></div></p><h2 id="15f8e6aa-a53a-49d7-9c7b-ab0105cb262d" class="">2.4.1 Promise Chaining</h2><ul id="988485bd-46fc-49de-952f-ac12a4a6bb4b" class="bulleted-list"><li style="list-style-type:disc">ECMAScript çš„Promiseæœ€æœ‰ç”¨çš„ç‰¹æ€§ä¹‹ä¸€å°±æ˜¯<strong>æœŸçº¦è¿é”ï¼ˆPromise Chainingï¼‰</strong>:ä¸€ç§å°†éå¸¸æœ‰ç”¨çš„å°†æœŸçº¦é€ä¸ª<strong>ä¸²è”ï¼ˆsequencingï¼‰</strong>èµ·æ¥çš„ç¼–ç¨‹æ¨¡å¼</li></ul><ul id="72f4631a-e42c-48e2-9069-19d10797621d" class="bulleted-list"><li style="list-style-type:disc">èƒ½å°†æœŸçº¦ä¸²è”èµ·æ¥çš„èƒ½åŠ›æ¥æºäºPromise APIçš„ç»“æ„ï¼šæ¯ä¸ª<code>Promise</code>å®ä¾‹çš„<code>then()</code> ,<code>catch()</code> ,<code>finally()</code> æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ª<strong>æ–°çš„ï¼ˆseparateï¼‰</strong><code>Promise</code>å¯¹è±¡ï¼Œè€Œè¿™ä¸ªæ–°å®ä¾‹åˆæœ‰è‡ªå·±çš„å®ä¾‹æ–¹æ³•ï¼Œå¯ä»¥ç»§ç»­è°ƒç”¨Promise APIçš„æ–¹æ³•ã€‚è¿™ç§è¿ç¼€çš„æ–¹æ³•è°ƒç”¨å°±å¯ä»¥æ„æˆæ‰€è°“çš„â€œ<strong>æœŸçº¦è¿é”</strong>â€ï¼Œä¾‹å¦‚<pre id="710dfbf9-485c-47e0-9ff6-5aa5aeb7ab04" class="code code-wrap"><code>let p = new Promise((resolve, _reject) =&gt; {
  console.log(&quot;first&quot;);
  setTimeout(() =&gt; resolve(&quot;DATA&quot;), 500);
});

p.then((res) =&gt; {
  console.log(&quot;second:&quot;, res);
  return `dispose or wrap &#x27;${res}&#x27;`;
})
  .then((res) =&gt; {
    console.log(&quot;third:&quot;, res);
    return `dispose or wrap &#x27;${res}&#x27;`;
  })
  .then((res) =&gt; {
    console.log(&quot;fourth:&quot;, res);
    return `dispose or wrap &#x27;${res}&#x27;`;
  });
	// æ‰“å°ç»“æœ
// first
// second: DATA
// third: dispose or wrap &#x27;DATA&#x27;
// fourth: dispose or wrap &#x27;dispose or wrap &#x27;DATA&#x27;&#x27;</code></pre><ul id="10ce753f-745c-4497-af57-abb068022e11" class="bulleted-list"><li style="list-style-type:circle">è¿™ä¸ªå®ç°æœ€ç»ˆæ‰§è¡Œäº†ä¸€è¿ä¸²çš„<strong>åŒæ­¥</strong>ä»»åŠ¡ï¼ˆchained <strong>synchronous </strong>tasksï¼Œ è¿™é‡ŒæŒ‡åœ¨<code>then()</code> æ–¹æ³•ä¸­æ‰§è¡Œæ‰“å°è¯­å¥ï¼‰ï¼Œè¿™ç§æ–¹å¼æ‰§è¡Œçš„ä»»åŠ¡æ²¡æœ‰é‚£ä¹ˆæœ‰ç”¨ï¼Œå› ä¸ºä½¿ç”¨4ä¸ªåŒæ­¥å‡½æ•°ä¹Ÿå¯ä»¥åšåˆ°</li></ul></li></ul><ul id="67394b35-4a03-468b-a56b-f83b68a5a92f" class="bulleted-list"><li style="list-style-type:disc">è¦çœŸæ­£å®ç°ä¸²è”çš„<strong>å¼‚æ­¥</strong>ä»»åŠ¡ï¼ˆchained <strong>asynchronous </strong>tasksï¼‰ï¼Œå¯ä»¥æ”¹å†™ä¹‹å‰çš„ä¾‹å­ï¼Œè®©æ¯ä¸ªå¤„ç†ç¨‹åºéƒ½è¿”å›ä¸€ä¸ªPromiseå®ä¾‹ï¼Œæ¯ä¸ªæœŸçº¦çš„æ‰§è¡Œå™¨éƒ½ä½¿ç”¨<code>setTimeout</code>æ¨¡æ‹Ÿå¼‚æ­¥æ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥è®©æ¯ä¸ªåç»­Promiseå¯¹è±¡éƒ½ç­‰å¾…ä¹‹å‰çš„Promiseå®ä¾‹ä»PendingçŠ¶æ€åˆ°è¾¾è½åœ°çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯<strong>ä¸²è¡ŒåŒ–å¼‚æ­¥ä»»åŠ¡ï¼ˆserialize asynchronous tasksï¼‰</strong><pre id="1c5dc05e-3204-4d73-ba64-43132cf7bcab" class="code code-wrap"><code>// ä¸²è¡ŒåŒ–å¼‚æ­¥ä»»åŠ¡
let p2 = new Promise((resolve) =&gt; {
  console.log(&quot;p2 executor&quot;);
  setTimeout(resolve, 500, &quot;p2 data&quot;);
});

p2.then((res) =&gt; {
  console.log(res);
  return new Promise((resolve) =&gt; {
    console.log(&quot;p3 executor&quot;);
    setTimeout(resolve, 500, &quot;p3 data&quot;);
  });
}).then((res) =&gt; {
  console.log(res);
  return new Promise((resolve) =&gt; {
    console.log(&quot;p4 executor&quot;);
    setTimeout(resolve, 500, &quot;p4 data&quot;);
  });
}).then((res) =&gt; {
  console.log(res);
  return new Promise((resolve) =&gt; {
    console.log(&quot;p5 executor&quot;);
    setTimeout(resolve, 500, &quot;p5 data&quot;);
  });
})
// æ‰“å°
// p2 exetcuor (ç«‹å³)
// p2 data (500mså)
// p3 executor (500må)
// p3 data (1så)
// p4 executor (1så)
// p4 data (1.5så)
// p5 executor (1.5så)</code></pre></li></ul><ul id="0d5269f0-19d2-4e8e-96bf-0e1e0089697d" class="bulleted-list"><li style="list-style-type:disc">åœ¨æœŸçº¦è¿é”çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡åœ¨<code>then()</code> æ–¹æ³•ä¸­éƒ½è¦åˆ›å»ºæ–°Promiseå¯¹è±¡ï¼Œä¸ºæ­¤å¯ä»¥å°†ç”ŸæˆæœŸçº¦çš„ä»£ç æå–åˆ°ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼ˆ<strong>factory function</strong>ï¼‰ä¸­<pre id="c62c71c0-6996-41a8-a5f6-6f27c99374c1" class="code code-wrap"><code>/**
 * @description ç”ŸæˆPromiseçš„å·¥å‚å‡½æ•°
 * @param {string} pStr æ‰§è¡Œå™¨æ‰“å°å­—ç¬¦ä¸²
 * @param {string} pdata å½“å‰æœŸçº¦çš„å†…éƒ¨å€¼
 * @param {string} preData ä¸Šä¸€ä¸ªæœŸçº¦çš„å†…å¸ƒç½®
 * @returns
 */
function delayedResolve(pStr, pdata, preData = &quot;åˆå§‹æœŸçº¦&quot;) {
  console.log(preData);
  return new Promise((resolve, _reject) =&gt; {
    console.log(pStr);
    setTimeout(resolve, 1000, pdata);
  });
}

delayedResolve(&quot;p1 executor&quot;, &quot;p1 data&quot;)
  .then((res) =&gt; delayedResolve(&quot;p2 executor&quot;, &quot;p2 data&quot;, res))
  .then((res) =&gt; delayedResolve(&quot;p3 executor&quot;, &quot;p3 data&quot;, res))
  .then((res) =&gt; delayedResolve(&quot;p4 executor&quot;, &quot;p4 data&quot;, res));
// æ‰“å°
// åˆå§‹æœŸçº¦ (ç«‹å³)
// p1 executor (ç«‹å³)
// p1 data (1så)
// p2 executor (1så)
// p2 data (2så)
// p3 executor (2så)
// p3 data (3så)
// p4 executor (3så)</code></pre><ul id="3ab2e9e3-3b38-4ede-a7c0-4de59513b42e" class="bulleted-list"><li style="list-style-type:circle">æ¯ä¸ªåç»­çš„å¤„ç†ç¨‹åºéƒ½ä¼šç­‰å¾…<strong>å‰ä¸€ä¸ª</strong>ï¼ˆ<strong>predecessor</strong>ï¼‰Promiseå®ä¾‹è§£å†³ï¼Œç„¶åå®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡å¹¶è¿”å›</li></ul><ul id="3cf38d34-7f2c-44ce-93d5-e5a4ace7d392" class="bulleted-list"><li style="list-style-type:circle">è¿™ç§ç»“æ„å¯ä»¥ç®€æ´åœ°å°†å¼‚æ­¥ä»»åŠ¡ä¸²è¡ŒåŒ–ï¼Œè§£å†³äº†ä¹‹å‰ä¾èµ–å›è°ƒï¼ˆ<strong>callbacks</strong>ï¼‰çš„éš¾é¢˜ï¼Œå¦‚æœä½¿ç”¨å›è°ƒä¸Šè¿°ä»£ç å¯èƒ½å¦‚ä¸‹<pre id="6233feba-2c16-49ef-9857-3e5f05b31aee" class="code code-wrap"><code>/**
 * @description å›è°ƒçš„ç»“æ„
 * @param {string} pStr è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œçš„å›è°ƒ
 * @param {string} pdata å½“å‰å›è°ƒè·å¾—çš„æ•°æ®ï¼Œè¿™é‡Œç›´æ¥ä¼ é€’ï¼Œå®é™…ä¸Šæ˜¯åœ¨å›è°ƒå†…éƒ¨é€šè¿‡å¼‚æ­¥æ“ä½œè·å–çš„
 * @param {Function} callback ä¸‹ä¸€ä¸ªå›è°ƒå‡½æ•°
 * @param {string} preData ä¸Šä¸€ä¸ªå›è°ƒäº§ç”Ÿçš„æ•°æ®
 */
function delayedCallback(pStr, pdata, callback, preData = &quot;åˆå§‹å›è°ƒ&quot;) {
  console.log(preData);
  console.log(pStr);
  setTimeout(() =&gt; {
    callback &amp;&amp; callback(pdata);
  }, 1000);
}

delayedCallback(&quot;p1 callback&quot;, &quot;p1 data&quot;, (res) =&gt; {
  delayedCallback(
    &quot;p2 callback&quot;,
    &quot;p2 data&quot;,
    (res) =&gt; {
      delayedCallback(
        &quot;p3 callback&quot;,
        &quot;p3 data&quot;,
        (res) =&gt; {
          delayedCallback(&quot;p4 callback&quot;, &quot;p4 data&quot;, null, res);
        },
        res
      );
    },
    res
  );
});
// æ‰“å°ç»“æœ
// åˆå§‹å›è°ƒ (ç«‹å³)
// p1 callback (ç«‹å³)
// p1 data (1så)
// p2 callback (1så)
// p2 data (2så)
// p3 callback (2så)
// p3 data (3så)
// p4 callback (3så)</code></pre><ul id="befa5970-a6de-4b70-9e4a-7a9a5a651850" class="bulleted-list"><li style="list-style-type:square">å¦‚æœåµŒå¥—å†å¤šå‡ å±‚ï¼Œå°±ä¼šå‡ºç°å¾ˆæ˜æ˜¾çš„<strong>å›è°ƒåœ°ç‹±</strong>ï¼ˆ<strong>callback hell</strong>ï¼‰</li></ul></li></ul></li></ul><ul id="e3a5a2f3-d115-42a6-81e0-8a0de544fde6" class="bulleted-list"><li style="list-style-type:disc">Promiseè¿™ç§æœŸçº¦è¿é”çš„ç‰¹æ€§æ­£å¥½è§£å†³äº†ä»¥å‰çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼çš„å›è°ƒåœ°ç‹±é—®é¢˜ï¼Œå› ä¸º<code>then()</code> ã€<code>catch()</code> ã€<code>finally()</code> éƒ½è¿”å›æœŸçº¦ï¼Œæ‰€ä»¥ä¸²è”è¿™äº›æ–¹æ³•å¾ˆ<strong>ç›´è§‚</strong>ï¼ˆ<strong>straightforward</strong>ï¼‰<pre id="1e38d815-94c1-4369-856d-a7ee87795a02" class="code code-wrap"><code>let pa = new Promise((resovle, reject) =&gt; {
  console.log(&quot;inital pa promise rejects&quot;);
  setTimeout(() =&gt; {
    reject(&quot;test&quot;);
  }, 500);
});
pa.catch((reason) =&gt; {
  console.log(&quot;æ•è·å¼‚æ­¥é”™è¯¯ï¼š&quot;, reason);
  return &quot;é»˜è®¤æ•°æ®&quot;;
})
  .then((res) =&gt; console.log(&quot;å¤„ç†è·å–åˆ°çš„æ•°æ®ï¼š&quot;, res))
  .finally(() =&gt; console.log(&quot;ä¸€äº›æ‹’ç»å’Œè§£å†³éƒ½æœ‰çš„å†—ä½™æ“ä½œ&quot;));
// æ‰“å°ç»“æœ
// inital pa promise rejects
// æ•è·å¼‚æ­¥é”™è¯¯ï¼š test
// å¤„ç†è·å–åˆ°çš„æ•°æ®ï¼š é»˜è®¤æ•°æ®
// ä¸€äº›æ‹’ç»å’Œè§£å†³éƒ½æœ‰çš„å†—ä½™æ“ä½œ</code></pre></li></ul><h2 id="e68a2296-1128-4fc4-b947-6e8f2d8a3d7f" class="">2.4.2 æœŸçº¦å›¾ï¼ˆPromise Graphsï¼‰</h2><ul id="6366f3a3-5db4-4b1f-bf83-a94f4c7715fd" class="bulleted-list"><li style="list-style-type:disc">å› ä¸ºæœŸçº¦å¯ä»¥æœ‰ä»»æ„å¤šä¸ªå¤„ç†ç¨‹åºï¼Œæ‰€ä»¥æœŸçº¦è¿é”å¯ä»¥æ„å»º<strong>æœ‰å‘éå¾ªç¯å›¾ï¼ˆdirected acyclic graphsï¼‰</strong><ul id="87eb4aac-227b-4749-942d-f7b83ca609b2" class="bulleted-list"><li style="list-style-type:circle">æ¯ä¸ªæœŸçº¦éƒ½æ˜¯ä¸€ä¸ªå›¾ä¸­çš„ä¸€ä¸ª<strong>èŠ‚ç‚¹</strong>ï¼ˆ<strong>node</strong>ï¼‰</li></ul><ul id="a363d2da-271b-4c21-a1f5-560b4ff96396" class="bulleted-list"><li style="list-style-type:circle">è€Œä½¿ç”¨å®ä¾‹æ–¹æ³•ï¼ˆ<code>then()</code> ç­‰ï¼‰æ·»åŠ çš„å¤„ç†ç¨‹åºåˆ™æ˜¯<strong>æœ‰å‘é¡¶ç‚¹</strong>ï¼ˆ<strong>directed vertex</strong>ï¼‰</li></ul><ul id="b728417e-a2c5-4dc9-a638-23dd4b0b3a57" class="bulleted-list"><li style="list-style-type:circle">å›¾çš„æ–¹å‘å°±æ˜¯æœŸçº¦çš„è§£å†³æˆ–æ‹’ç»é¡ºåºï¼Œå› ä¸ºå›¾ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹è½åœ°</li></ul></li></ul><ul id="85e71f44-6c83-4399-9105-4fd6efb885d4" class="bulleted-list"><li style="list-style-type:disc">ä¸€ä¸ªç®€å•ä¾‹å­<pre id="9d2e3007-015c-42d1-91b6-b3a3055f30a0" class="code code-wrap"><code>let A = new Promise((resovle, reject) =&gt; {
  console.log(&quot;A&quot;);
  resovle();
});

let B = A.then(() =&gt; console.log(&quot;B&quot;));
let C = A.then(() =&gt; console.log(&quot;C&quot;));

B.then(() =&gt; console.log(&quot;D&quot;));
B.then(() =&gt; console.log(&quot;E&quot;));
C.then(() =&gt; console.log(&quot;F&quot;));
C.then(() =&gt; console.log(&quot;G&quot;));
// æ‰“å°
A
B
C
D
E
F
G
// å›¾
//    A
//   / \
//  B   C
// /\   /\
// D E  F G</code></pre><ul id="d660048e-43f3-4509-a7b5-2a2ca801d3d3" class="bulleted-list"><li style="list-style-type:circle">æ—¥å¿—çš„è¾“å‡ºè¯­å¥æ˜¯å¯¹äºŒå‰æ ‘ï¼ˆ<strong>binary tree</strong>ï¼‰çš„<strong>å±‚åºéå†</strong>ï¼ˆ<strong>level-order traversal</strong>ï¼‰</li></ul><ul id="436996ee-033e-4f59-b54c-46447edb0e1f" class="bulleted-list"><li style="list-style-type:circle">æœŸçº¦çš„å¤„ç†ç¨‹åºæŒ‰ç…§å®ƒä»¬æ·»åŠ çš„é¡ºåºæ‰§è¡Œï¼Œç”±äºæœŸçº¦çš„å¤„ç†ç¨‹åºæ˜¯<strong>å…ˆ</strong>ï¼ˆ<strong>eagerly</strong>ï¼‰æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ<strong>ç„¶å</strong>ï¼ˆ<strong>lazily</strong>ï¼‰æ‰é€ä¸ªæ‰§è¡Œï¼Œå› æ­¤æ„æˆäº†å±‚åºéå†</li></ul></li></ul><ul id="3ea37002-d777-4af7-974f-01e3d63cc22a" class="bulleted-list"><li style="list-style-type:disc">æ ‘åªæ˜¯æœŸçº¦çš„<strong>ä¸€ç§è¡¨ç°å½¢å¼</strong>ï¼ˆ<strong>one manifestation of</strong>ï¼‰ã€‚è€ƒè™‘åˆ°æ ¹èŠ‚ç‚¹ä¸ä¸€å®šå”¯ä¸€ï¼Œä¸”å¤šä¸ªPromiseå®ä¾‹å¯ä»¥ç»„åˆæˆä¸€ä¸ªæœŸçº¦ï¼ˆä¸‹ä¸€ä¸ªå°èŠ‚ä»‹ç»çš„Promiseçš„é™æ€æ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥<strong>æœ‰å‘éå¾ªç¯å›¾</strong>ï¼ˆ<strong>directed acyclic graph</strong>ï¼‰æ˜¯ä½“ç°æœŸçº¦è¿é”å¯èƒ½æ€§çš„æœ€å‡†ç¡®çš„<strong>è¡¨è¾¾</strong>ï¼ˆ<strong>characterization</strong>ï¼‰</li></ul><h2 id="43918a86-9bff-49c9-b96b-17a45dd565e6" class="">2.4.3 Promise.all()å’ŒPromise.race() ï¼ˆParallel Promise Composition with Promise.all() and Promise.race() ï¼‰</h2><p id="a27a5b7f-e0ee-44cd-b4f9-7d65c9983f54" class="">Parallel è¡¨ç¤ºâ€œå¹¶è¡Œçš„ï¼Œå¹¶è”â€ï¼Œè¿™é‡Œåº”è¯¥è¡¨ç¤ºPromiseçš„<strong>ç»„åˆ</strong>ï¼ˆ<strong>Composition</strong>ï¼‰æ–¹å¼åº”è¯¥æ˜¯å¹¶è”çš„ï¼Œå„ä¸ªPromiseå®ä¾‹å¹¶è¡Œå¹³ç­‰</p><ul id="71efe3b5-1803-4977-9e9e-0f9bfc29c5c9" class="bulleted-list"><li style="list-style-type:disc"><code>Promise</code>ç±»æä¾›ä¸¤ä¸ªå°†å¤šä¸ªPromiseå®ä¾‹ç»„åˆæˆä¸€ä¸ªPromiseæœŸçº¦çš„é™æ€æ–¹æ³•ï¼š<code>Promise.all()</code> å’Œ<code>Promise.race()</code> </li></ul><ul id="91fd983b-26ab-472b-84b8-ce44afeb2bb8" class="bulleted-list"><li style="list-style-type:disc">è€Œå<strong>åˆæˆpromise</strong>ï¼ˆ<strong>composed promise</strong>ï¼‰çš„è¡Œä¸ºå–å†³äºå†…éƒ¨æœŸçº¦çš„è¡Œä¸º</li></ul><h3 id="3b1829ad-27db-49b0-90bb-b4bd4bedca5e" class="">2.4.3.1 Promise.all()</h3><ul id="d95b5933-a702-477b-8c79-f4197cc18c77" class="bulleted-list"><li style="list-style-type:disc">Promise.all()é™æ€æ–¹æ³•åˆ›å»º<code>Promise</code> <strong>ä¼šåœ¨ä¸€ç»„æœŸçº¦å…¨éƒ¨è§£å†³ä¹‹åå†è§£å†³</strong>ï¼Œè¿™ä¸ªé™æ€æ–¹æ³•æ¥å—ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ª<strong>è¦ä¹ˆå…¨æœ‰è¦ä¹ˆå…¨æ— çš„ï¼ˆall-or-nothingï¼‰</strong>æ–°æœŸçº¦<pre id="b3ae7cd9-8fc3-4d17-9391-dc412a95a676" class="code"><code>let p1 = Promise.all([Promise.resolve(), Promise.resolve()]);
console.log(p1);
setTimeout(console.log, 0, p1)
// å¯è¿­ä»£å…ƒç´ å¯ä»¥ä¸æ˜¯æœŸçº¦
// ä½†æ˜¯å®ƒä¼šä½œä¸ºæœŸçº¦çš„å†…éƒ¨å€¼ä¼ é€’ç»™Promise.resolve()è½¬æ¢ä¸ºæœŸçº¦
let p2 = Promise.all([1, 2]);
console.log(p2);
setTimeout(console.log, 0, p2)

// ç©ºçš„å¯è¿­ä»£å¯¹è±¡ç­‰ä»·äºPromise.resolve()
let p3 = Promise.all([]);
console.log(p3);
setTimeout(console.log, 0, p3)
// å¿…é¡»ç»™Promise.allä¼ é€’ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œå¦åˆ™ä¼šæŠ¥é”™
let p4 = Promise.all();
// æ‰“å°ç»“æœ
PromiseÂ {&lt;pending&gt;}
PromiseÂ {&lt;pending&gt;}
PromiseÂ {&lt;fulfilled&gt;: Array(0)}
PromiseÂ {&lt;fulfilled&gt;: Array(2)}
PromiseÂ {&lt;fulfilled&gt;: Array(2)}
PromiseÂ {&lt;fulfilled&gt;: Array(0)}
Uncaught (in promise) TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
    at Function.all (&lt;anonymous&gt;)
    at &lt;anonymous&gt;:12:18</code></pre><ul id="0be48ebc-afd5-4a13-91c6-e0a81733f17d" class="bulleted-list"><li style="list-style-type:circle">æ³¨æ„çœ‹æ‰“å°ç»“æœï¼Œ<code>p1</code> å’Œ <code>p2</code> ç«‹å³æ‰“å°éƒ½æ˜¯<strong><em>Pending&lt;</em></strong><strong>ç­‰å¾…</strong><strong><em>&gt;</em></strong><strong>çŠ¶æ€</strong>ï¼Œè€Œ<code>p3</code> ç«‹å³æ‰“å°å°±æ˜¯<strong><em>filfilled</em></strong>&lt;<strong>å…‘ç°</strong>&gt;çŠ¶æ€ï¼Œè™½ç„¶<code>p1</code> å’Œ<code>p2</code> ç»„æˆçš„æœŸçº¦éƒ½æ˜¯é€šè¿‡<code>Promise.resolve()</code> ç›´æ¥ç”Ÿæˆçš„ï¼Œä½†æ˜¯ç­‰å¾…å®ƒä»¬éƒ½è¢«è§£å†³ä»ç„¶éœ€è¦â€œæ—¶é—´â€ï¼Œæ‰€ä»¥ç«‹å³ï¼ˆåŒæ­¥ï¼‰æ‰“å°è‡ªç„¶æ˜¯ç­‰å¾…çŠ¶æ€ã€‚è€Œ<code>p3</code> åˆ™æ˜¯å› ä¸º<code>Promise.all([])</code> ç­‰ä»·äº<code>Promise.resolve()</code> ï¼Œç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªå¤„äº<strong><em>filfilled</em></strong>&lt;<strong>å…‘ç°</strong>&gt;çŠ¶æ€çš„promiseï¼Œæ‰€ä»¥ç«‹å³æ‰“å°çš„çŠ¶æ€å°±æ˜¯å…‘ç°çŠ¶æ€</li></ul><ul id="d0858b71-f059-4423-a0d0-31e4060f73ef" class="bulleted-list"><li style="list-style-type:circle">ç»™<code>Promise.all()</code> ä¸ä¼ é€’ä»»ä½•å‚æ•°ä¼šæŠ›å‡º<code>TypeError</code> ï¼Œä½†æ˜¯è¿™ä¸ª<code>TypeError</code> ä¸èƒ½ä½¿ç”¨å¤–éƒ¨çš„<code>try/catch</code> è¯­å¥æ•è·åˆ°ï¼Œå› ä¸ºå®ƒå±äºPromiseå†…éƒ¨æŠ›å‡ºçš„å¼‚æ­¥é”™è¯¯ï¼Œèƒ½é€šè¿‡å¯¹åº”çš„æ‹’ç»å¤„ç†ç¨‹åºæ•è·åˆ°é”™è¯¯ï¼Œå…¶ä¸­<code>p4</code> çš„å†…éƒ¨å€¼å°±æ˜¯é”™è¯¯å¯¹è±¡ï¼Œå¦‚ä¸‹<pre id="8ac6fd97-6e5b-451b-9acf-423e6b0c131a" class="code code-wrap"><code>let p4 = Promise.all();
p4.catch((reason) =&gt; {
  console.log(reason.toString());
})
// TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))</code></pre></li></ul></li></ul><ul id="d93a113d-0c87-44e5-a256-4f340086838b" class="bulleted-list"><li style="list-style-type:disc">å› ä¸ºåˆæˆçš„æœŸçº¦(<strong>composed promise</strong>)åªä¼šåœ¨æ¯ä¸ª<strong>åŒ…å«çš„promises</strong>(<strong>contained promises</strong>)éƒ½è§£å†³åæ‰è§£å†³ï¼Œæ‰€ä»¥åˆæˆæœŸçº¦çš„ç­‰å¾…æ—¶é—´å¾€å¾€æ˜¯åŒ…å«çš„promisesä¸­æœ€åä¸€ä¸ªçš„è§£å†³çš„æ—¶é—´<pre id="490f5dd7-63db-4395-9639-7e1a7f352fb1" class="code code-wrap"><code>// åˆæˆçš„æœŸçº¦ç­‰å¾…çš„æ—¶é—´æ˜¯åŒ…å«çš„æœ€åä¸€ä¸ªæœŸçº¦çš„è§£å†³æ—¶é—´
let pa = Promise.all([
  new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      console.log(&quot;1: resolved&quot;);
      resolve();
    }, 589);
  }),
  new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      console.log(&quot;2: resolved&quot;);
      resolve();
    }, 345);
  }),
  new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      console.log(&quot;3: resolved&quot;);
      resolve();
    }, 456);
  }),
  new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      console.log(&quot;4: resolved&quot;);
      resolve();
    }, 590);
  }),
  new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      console.log(&quot;5: resolved&quot;);
      resolve();
    }, 589);
  }),
]);
pa.then(() =&gt; {
  console.log(&quot;pa: resolved&quot;);
});
// æ‰“å°
// 2: resolved (345mså)
// 3: resolved (456mså)
// 1: resolved (589mså)
// 5: resolved (589mså)
// 4: resolved (590mså)
// pa: resolved (590mså)</code></pre><ul id="83b5a171-d6be-4e1a-8243-ebbf6ee6430c" class="bulleted-list"><li style="list-style-type:circle"><code>Promise.all()</code> çš„å‚æ•°ï¼ˆå¯è¿­ä»£å¯¹è±¡ï¼‰çš„ç¬¬å››ä¸ªå…ƒç´ æœ€åè§£å†³ï¼Œæ‰€ä»¥åˆæˆçš„å‚æ•°çš„è§£å†³æ—¶é—´â€œç´§éšå…¶åâ€ï¼ˆç«‹å³ï¼‰</li></ul></li></ul><ul id="dfa3f04a-e1b8-4986-95cd-d18f6a4ce2cc" class="bulleted-list"><li style="list-style-type:disc">å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªåŒ…å«çš„promises(<strong>contained promises</strong>)å¾…å®šï¼Œåˆ™åˆæˆçš„promiseä¹Ÿä¼šå¾…å®šï¼›å¦‚æœæœ‰ä¸€ä¸ªåŒ…å«çš„promiseæ‹’ç»ï¼Œé‚£ä¹ˆåˆæˆçš„promiseä¹Ÿä¼šæ‹’ç»<pre id="4fe9cc5c-6688-4871-a4a5-5b6bfe4af55c" class="code code-wrap"><code>let p_pending = Promise.all([Promise.resolve(&quot;k&quot;), new Promise(() =&gt; {})]);
setTimeout(() =&gt; {
  console.log(p_pending);
}, 0);
// æ‰“å° PromiseÂ {&lt;pending&gt;}</code></pre><ul id="0d9e049f-65f7-4f2c-8087-d42fc1297a4c" class="bulleted-list"><li style="list-style-type:circle">è™½ç„¶å¯è¿­ä»£å¯¹è±¡çš„ç¬¬ä¸€ä¸ªå…ƒç´ æœ¬èº«å¤„äºå…‘ç°çŠ¶æ€ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå…ƒç´ æ°¸è¿œä¸ä¼šè¢«è§£å†³ï¼Œæ‰€ä»¥åˆæˆå‚æ•°ä¸ä¼šè¢«è§£å†³</li></ul><ul id="90000648-04d2-4f1a-9c60-aefbfc2c2d29" class="bulleted-list"><li style="list-style-type:circle">åŒæ—¶éœ€è¦æ³¨æ„åˆæˆå‚æ•°çš„å†…éƒ¨å€¼åœ¨ç­‰å¾…æœŸé—´ä¸€ç›´æ˜¯<code>undefined</code></li></ul><pre id="17d4a548-3212-42b6-9ee3-7fb7e20f54c2" class="code code-wrap"><code>// ä¸€ä¸ªæ‹’ç»çš„æœŸçº¦ä¼šå¯¼è‡´åˆæˆæœŸçº¦å¤„äºæ‹’ç»çŠ¶æ€
let p_reject = Promise.all([
  new Promise((_resolve, reject) =&gt;
    setTimeout(
      (reason) =&gt; {
        console.log(&quot;1: rejected&quot;);
        reject(reason);
      },
      1001,
      &quot;reason1&quot;
    )
  ),
  Promise.resolve(&quot;resolve&quot;),
  Promise.resolve(&quot;resolve&quot;),
  new Promise((_resolve, reject) =&gt;
    setTimeout(
      (reason) =&gt; {
        console.log(&quot;4: rejected&quot;);
        reject(reason);
      },
      1000,
      &quot;reason4&quot;
    )
  ),
  new Promise((_resolve, reject) =&gt;
    setTimeout(
      (reason) =&gt; {
        console.log(&quot;5: rejected&quot;);
        reject(reason);
      },
      1000,
      &quot;reason5&quot;
    )
  ),
]);

p_reject.catch((reason) =&gt; {
  console.log(reason);
});
setTimeout(() =&gt; {
  console.log(p_reject);
}, 1000);
// æ‰“å°ç»“æœ
// 4: rejected (1000mså)
// reason4 (1000mså)
// 5: rejected (1000mså)
// PromiseÂ {&lt;rejected&gt;: &#x27;reason4&#x27;} (1000mså)
// 1: rejected (1001mså)</code></pre><ul id="5156af17-42b4-4af5-832d-46de2ef338ff" class="bulleted-list"><li style="list-style-type:circle">éœ€è¦æ³¨æ„çš„æ˜¯åˆæˆçš„promiseå’ŒåŒ…å«çš„promisesä¹‹é—´æ˜¯<strong>ç›¸äº’ç‹¬ç«‹</strong>çš„ï¼Œåˆæˆçš„promiseæ‹’ç»äº† å¹¶ä¸å½±å“å®ƒåŒ…å«çš„promiseè½å®šè‡ªå·±çš„çŠ¶æ€ï¼Œè¿™ä¸€ç‚¹åœ¨æ‰“å°é™¤äº†åˆæˆçŠ¶æ€åï¼Œç¬¬ä¸€ä¸ªå…ƒç´ åœ¨1msåç«‹å³è¿›å…¥æ‹’ç»çŠ¶æ€æœ‰å…³</li></ul><ul id="3504bbf2-6674-4901-8784-b62b629199b8" class="bulleted-list"><li style="list-style-type:circle">åˆæˆçš„promise<em>ä¼š</em><strong>é™é»˜(</strong><em><strong>will</strong></em><strong> silently handle)</strong>å¤„ç†æ‰€æœ‰åŒ…å«çš„promisesçš„è½åœ°æ‹’ç»çŠ¶æ€æŠ›å‡ºçš„å¼‚æ­¥é”™è¯¯ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬äº”ä¸ªå…ƒç´ å’Œç¬¬ä¸€ä¸ªå…ƒç´ çš„promiseè½åœ°æ‹’ç»çŠ¶æ€åå®ƒä»¬æŠ›å‡ºçš„å¼‚æ­¥é”™è¯¯ï¼Œä¼šå› ä¸ºåˆæˆçš„promiseåœ¨è½åœ°æ‹’ç»çŠ¶æ€æ—¶ï¼ˆè™½ç„¶æ‹’ç»ç†ç”±æ˜¯ç¬¬å››ä¸ªå…ƒç´ çš„æ‹’ç»ç†ç”±ï¼‰ï¼Œåœ¨å¯¹åº”çš„åˆæˆpromiseçš„æ‹’ç»å¤„ç†ç¨‹åºæ•è·è€Œè¢«é™é»˜å¤„ç†</li></ul><ul id="f320c4be-aedb-472e-9746-b6da547d707a" class="bulleted-list"><li style="list-style-type:circle">é™¤æ­¤ä¹‹å¤–ï¼Œåˆæˆçš„promiseæ‹’ç»çš„ç†ç”±æ˜¯å®ƒåŒ…å«çš„promisesä¸­ç¬¬ä¸€ä¸ªæ‹’ç»çš„promiseçš„æ‹’ç»ç†ç”±ï¼Œè™½ç„¶ç¬¬å››ä¸ªå…ƒç´ å’Œç¬¬äº”ä¸ªå…ƒç´ éƒ½åœ¨1000msæ—¶è½å®šæ‹’ç»çŠ¶æ€ï¼Œåœ¨æ—¶é—´ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå°±æŒ‰ç…§å¯è¿­ä»£å¯¹è±¡çš„å…ƒç´ é¡ºåºå†³å®šåˆæˆpromiseçš„æ‹’ç»ç†ç”±ï¼Œå³é€‰æ‹©ç¬¬å››ä¸ªå…ƒç´ çš„æ‹’ç»ç†ç”±ä½œä¸ºåˆæˆpromiseçš„æ‹’ç»ç†ç”±</li></ul></li></ul><ul id="d087b956-24af-4278-ae0e-229f9ab7fa7e" class="bulleted-list"><li style="list-style-type:disc">å¦‚æœæ‰€æœ‰promiseséƒ½æˆåŠŸè§£å†³ï¼Œåˆ™åˆæˆpromiseåœ¨è½å®šè§£å†³çŠ¶æ€åçš„å†…éƒ¨å€¼å°±æ˜¯<strong>åŒ…å«æ‰€æœ‰promisesè§£å†³å€¼çš„æ•°ç»„</strong>ï¼ŒæŒ‰ç…§è¿­ä»£å™¨é¡ºåº<pre id="c973000e-4ebf-46c9-8c48-fdbac2cea3b7" class="code code-wrap"><code>// åˆæˆçš„æœŸçº¦çš„å†…éƒ¨å€¼
let p_resolved = Promise.all([
  Promise.resolve(5),
  Promise.resolve(),
  Promise.resolve(1),
]);
p_resolved.then((res) =&gt; {
  console.log(&quot;å†…éƒ¨å€¼ï¼š&quot;, res);
}); // [5, undefined, 1]</code></pre></li></ul><h3 id="a87bbbf7-21ff-419a-9ed9-b1f1830b3d4b" class="">2.4.3.2 Promise.race()</h3><ul id="c4c92950-0a6c-43d8-8537-7d4249fbeebd" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.race()</code>é™æ€æ–¹æ³•è¿”å›ä¸€ä¸ªåŒ…è£…æœŸçº¦ï¼Œå®ƒæ˜¯ä¸€ç»„é›†åˆä¸­æœ€å…ˆè§£å†³æˆ–æ‹’ç»çš„promiseçš„<strong>é•œåƒï¼ˆmirrorï¼‰ï¼Œ</strong>è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªæ–°promiseï¼›å®ƒä¸<code>Promise.all()</code> æœ€å¤§çš„åŒºåˆ«æ˜¯ï¼Œå®ƒæ˜¯â€<strong>first-of-all</strong>â€ï¼ˆ<strong>ç¬¬ä¸€ä¸ªè½åœ°çŠ¶æ€çš„promiseé•œåƒ</strong>ï¼‰ è€Œ<code>Promise.all()</code> æ˜¯ï¼ˆ<strong>all-or-nothingï¼‰ï¼ˆè¦ä¹ˆå…¨æœ‰è¦ä¹ˆå…¨æ— çš„&lt;å¯¹äºæˆä¸ºå…‘ç°çŠ¶æ€è€Œè¨€&gt;ï¼‰</strong><pre id="5f9202a1-fc58-4677-be76-15b74797f5db" class="code code-wrap"><code>// Promise.race() è¿”å›ä¸€ç»„åŒ…å«çš„æœŸçº¦ä¸­æœ€å…ˆè½åœ°çŠ¶æ€çš„æœŸçº¦çš„é•œåƒæœŸçº¦
let promises = [Promise.resolve(1), Promise.resolve(2), Promise.reject(&quot;reason&quot;)];
let p1 = Promise.race(promises);

setTimeout(() =&gt; {
  console.log(p1); // PromiseÂ {&lt;fulfilled&gt;: 1}
  console.log(p1 === promises[0]); // false
}, 0);</code></pre><ul id="cf13c12a-06c3-499a-b54f-f77a2b069673" class="bulleted-list"><li style="list-style-type:circle">é€šè¿‡æ‰“å°å¯ä»¥å‘ç°ï¼Œå¦‚æœæœ‰å¤šä¸ªâ€œæœ€å…ˆâ€è§£å†³æˆ–æ‹’ç»çš„åŒ…å«çš„promiseï¼Œå°±ä¼šæŒ‰ç…§å¯è¿­ä»£å¯¹è±¡çš„é¡ºåºé€‰æ‹©ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥åŒ…è£…æœŸçº¦çš„å†…éƒ¨å€¼æ˜¯å‚æ•°çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„å†…éƒ¨å€¼ï¼ŒäºŒè€…çš„çŠ¶æ€å’Œå€¼å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯ä¸æ˜¯åŒä¸€ä¸ªpromiseï¼Œæ‰€ä»¥ç§°ä¸º<strong>é•œåƒï¼ˆmirrorï¼‰</strong></li></ul><ul id="74b2e11f-5003-4511-885f-f6cb35c4e66d" class="bulleted-list"><li style="list-style-type:circle">å’Œ<code>Promise.all()</code> ç›¸ä¼¼çš„è¡Œä¸ºæ˜¯ï¼Œåˆæˆçš„promiseç”Ÿæˆåï¼Œå®ƒä¼šé™é»˜å…¶å®ƒåŒ…å«çš„promisesä¸­çš„æ‹’ç»promise</li></ul></li></ul><ul id="783a9c4c-81ec-468b-ba1c-086b8c5b0176" class="bulleted-list"><li style="list-style-type:disc">å…³äº<code>race()</code> æ¥æ”¶å‚æ•°çš„è¡Œä¸ºä¹Ÿä¸<code>Promise.all()</code> ç±»ä¼¼ï¼Œä»¥ä¸‹ä»¥å¯è¿­ä»£å¯¹è±¡ä»£æŒ‡å‚æ•°<ul id="0bad1af2-a4f5-4f9f-9cb6-781bb4df23d6" class="bulleted-list"><li style="list-style-type:circle">å¦‚æœå¯è¿­ä»£å¯¹è±¡ä¸­çš„å…ƒç´ ä¸æ˜¯promiseï¼Œä¼šé€šè¿‡<code>Promise.resolve()</code> è½¬åŒ–ä¸ºpromise</li></ul><ul id="34497657-3151-449b-b154-dc73b529a9d5" class="bulleted-list"><li style="list-style-type:circle">ç©ºçš„å¯è¿­ä»£å¯¹è±¡ç­‰ä»·äº<code>new Promise(() =&gt; {})</code> </li></ul><ul id="35940d19-cf75-4065-9423-4c478c90700a" class="bulleted-list"><li style="list-style-type:circle">ä¸ä¼ é€’å‚æ•°ä¼šæŠ›å‡ºå¼‚æ­¥é”™è¯¯ï¼Œä¸”è¿™ä¸ªé”™è¯¯ä¸èƒ½è¢«<code>try/catch</code> æ•è·ï¼Œå¯ä»¥ä½¿ç”¨<code>Promise.prototype.catch()</code> è¿›è¡Œæ•è·<pre id="afd3b996-c037-451a-931a-63841618810b" class="code code-wrap"><code>// å‚æ•°
let p2 = Promise.race([5, 3, 4]);
p2.then((res) =&gt; {
  console.log(res); // 5
});

let p3 = Promise.race([]);
setTimeout(() =&gt; {
  console.log(p3); // 
}, 0);

let p4 = Promise.race();
p4.catch((reason) =&gt; {
  console.log(reason.toString());
});
// æ‰“å°ç»“æœ
// TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
// 5
// PromiseÂ {&lt;pending&gt;}</code></pre></li></ul></li></ul><ul id="1a3e5ac3-56f3-4885-a5e3-930a245aedeb" class="bulleted-list"><li style="list-style-type:disc"><code>Promise.race()</code> ä¸ä¼šå¯¹è§£å†³æˆ–æ‹’ç»çš„promiseåŒºåˆ«å¯¹å¾…ï¼Œæ— è®ºæ˜¯è§£å†³è¿˜æ˜¯æ‹’ç»ï¼Œåªè¦æ˜¯ç¬¬ä¸€ä¸ªè½å®šçš„promiseï¼Œå®ƒå°±ä¼šæˆä¸ºPromise.race()ç”Ÿæˆçš„æ–°æœŸçº¦çš„è“æœ¬<ul id="16804c4b-0d1e-4928-a2f5-c4a5003f30cb" class="bulleted-list"><li style="list-style-type:circle">è§£å†³å…ˆå‘ç”Ÿï¼Œè¶…æ—¶åçš„æ‹’ç»å’Œè§£å†³è¢«å¿½ç•¥</li></ul><ul id="bdd6c3a5-4dd1-40fa-9d42-7bad5ffb274b" class="bulleted-list"><li style="list-style-type:circle">æ‹’ç»å…ˆå‘é€ï¼Œè¶…æ—¶åçš„è§£å†³å’Œæ‹’ç»è¢«å¿½ç•¥</li></ul><ul id="5008f4b7-843b-45c2-b025-b5c160d85620" class="bulleted-list"><li style="list-style-type:circle">è¿­ä»£é¡ºåºå†³å®šäº†è½å®šçš„é¡ºåº</li></ul><ul id="7252fa33-7b1d-4703-92a5-b27956a511d9" class="bulleted-list"><li style="list-style-type:circle"><strong>åˆæˆ</strong>ï¼ˆ<strong>composed</strong>ï¼‰çš„æœŸçº¦<em><strong>ä¼š</strong></em><strong>é™é»˜</strong>å¤„ç†<strong>ï¼ˆ</strong><em><strong>will</strong></em><strong> silently </strong>handle<strong>ï¼‰</strong>æ‰€æœ‰<strong>åŒ…å«</strong>ï¼ˆ<strong>contained</strong>ï¼‰æœŸçº¦çš„æ‹’ç»æ“ä½œ</li></ul></li></ul><h2 id="87a31ff9-2c1e-4bda-bd44-c4024236961a" class="">2.4.3 ä¸²è¡ŒæœŸçº¦åˆæˆï¼ˆSerial Promise Compositionï¼‰</h2><p id="ba46c9c8-06f6-4c69-b94c-66bdac61c832" class="">ä¸Šé¢çš„ä¸¤ä¸ª<code>Promise</code> çš„é™æ€åˆæˆæ–¹æ³•éƒ½æ˜¯<strong>å¹¶è¡Œçš„æœŸçº¦åˆæˆï¼ˆParallel Promise Compositionï¼‰ï¼Œ</strong>è€Œåœ¨è®¨è®º<strong>æœŸçº¦è¿é”ï¼ˆPromise Chainingï¼‰</strong>æ—¶ä¸€ç›´å›´ç»•æœŸçº¦çš„ä¸²è¡Œæ‰§è¡Œï¼Œå¹¶ä¸”æœŸçº¦è¿˜æœ‰å¦å¤–ä¸€ä¸ªç‰¹æ€§ï¼š<strong>å¼‚æ­¥ï¼ˆasynchronouslyï¼‰äº§ç”Ÿå€¼å¹¶å°†å…¶ä¼ é€’ç»™å¤„ç†ç¨‹åº</strong></p><hr id="f14e00c0-7ae2-4fe1-b9c7-2a9e65816603"/><ul id="1687b03c-6aee-40f7-8a68-1931231b82e2" class="bulleted-list"><li style="list-style-type:disc">åŸºäºåç»­æœŸçº¦ä½¿ç”¨ä¹‹å‰æœŸçº¦(<strong>predecessor</strong>)çš„è¿”å›å€¼æ¥ä¸²è”æœŸçº¦æ˜¯æœŸçº¦çš„åŸºæœ¬åŠŸèƒ½,è¿™å¾ˆåƒ<strong>å‡½æ•°åˆæˆï¼ˆfunction compositionï¼‰,</strong>å³å°†å¤šä¸ªä¸ªå‡½æ•°åˆæˆä¸ºä¸€ä¸ªå‡½æ•°<pre id="ea932296-b5aa-4dfb-9c09-314fa54f7301" class="code code-wrap"><code>// åç»­æœŸçº¦ä½¿ç”¨ä¹‹å‰çš„æœŸçº¦çš„è¿”å›å€¼æ¥ä¸²è”æœŸçº¦å¾ˆåƒå‡½æ•°åˆæˆ
function addTwo(x) {
  return x + 2;
}
function addThree(x) {
  return x + 3;
}
function addFive(x) {
  return x + 5;
}

// åˆæˆå‡½æ•°
function addTen(x) {
  return addFive(addTwo(addThree(x)));
}
console.log(addTen(7)); // 17</code></pre><ul id="9a5a4e68-1a1b-4ea9-8488-11f64175f679" class="bulleted-list"><li style="list-style-type:circle">åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰ä¸‰ä¸ªå‡½æ•°åŸºäºä¸€ä¸ªå€¼åˆæˆä¸ºä¸€ä¸ªå‡½æ•°ï¼ˆå°½ç®¡è¿™æ ·çœ‹èµ·æ¥å¾ˆå‚»ï¼Œä½†å½“ä¸‰ä¸ªå‡½æ•°åŠŸèƒ½éƒ½ååˆ†å¤æ‚æ—¶ï¼Œè¿™ç§åˆæˆå‡½æ•°çš„ä½œç”¨å°±å¾ˆå¤§äº†ï¼‰</li></ul></li></ul><ul id="b7340f52-c9ee-4a7d-b812-141a4be62577" class="bulleted-list"><li style="list-style-type:disc">ç±»ä¼¼äºå‡½æ•°åˆæˆï¼ŒæœŸçº¦ä¹Ÿå¯ä¹Ÿè¿™æ ·åˆæˆèµ·æ¥ç”¨ï¼Œæ¸è¿›åœ°æ¶ˆè´¹ä¸€ä¸ªå€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ªç»“æœ<pre id="39795d4d-82b8-488a-88c7-c7cf79e785c2" class="code code-wrap"><code>// è½¬åŒ–ä¸ºæœŸçº¦å½¢å¼ï¼Œå‡è®¾æ¯ä¸ªå‡½æ•°éƒ½æ˜¯å¤æ‚çš„æ“ä½œ
function addTen(x) {
  return Promise.resolve(x).then(addTwo).then(addThree).then(addFive);
}

addTen(8).then(console.log); // 18</code></pre><ul id="2f173e97-174b-4263-b805-0604449b517e" class="bulleted-list"><li style="list-style-type:circle">è¿™ç§å°†promiseçš„å¤„ç†ç¨‹åºåˆ†ç¦»ä¸ºå¤šä¸ªå‡½æ•°ä½œä¸ºå¤šä¸ª<code>then()</code> çš„å‚æ•°ä»¥è¾¾åˆ°æˆåŠŸå¤„ç†æœŸçº¦å†…éƒ¨å€¼çš„æ¨¡å¼åˆ©ç”¨åˆ°äº†æœŸçº¦è¿é”çš„ç‰¹æ€§ï¼Œè¿™å°±æ˜¯ä¸€ç§ä¸²è¡Œçš„æœŸçº¦åˆæˆ</li></ul></li></ul><ul id="b4415f8f-0601-4ec2-9fe2-23682a819be6" class="bulleted-list"><li style="list-style-type:disc">å¦‚æœå¤„ç†ç¨‹åºå‡½æ•°è¿‡å¤šï¼Œå¯¼è‡´åˆæˆçš„å‡½æ•°ä¹Ÿæœ‰ä¸€æ¡å¾ˆé•¿çš„ä»£ç ï¼Œå¯ä»¥åˆ©ç”¨<code>Array.pototype.reduce()</code> é«˜é˜¶å‡½æ•°æç‚¼å‡ºä¸€ä¸ªé€šç”¨å‡½æ•°ï¼ŒæŠŠä»»æ„å¤šä¸ªå‡½æ•°ä½œä¸ºå¤„ç†ç¨‹åºåˆæˆä¸€ä¸ªè¿ç»­ä¼ å€¼çš„æœŸçº¦è¿é”ï¼Œå¦‚ä¸‹<pre id="de5a3a94-b797-437f-bb97-e5df245c6a32" class="code code-wrap"><code>// é€šç”¨å‡½æ•°ï¼Œåˆæˆå‡½æ•°æ—¶ä½¿ç”¨reduce()é«˜é˜¶å‡½æ•°ç”Ÿæˆä¸€ä¸ªä¸²è”çš„å‡½æ•°
function compose(...fns) {
  return (x) =&gt;
    fns.reduce((promise, fn) =&gt; promise.then(fn), Promise.resolve(x));
}

let addFifteen = compose(addFive, addTwo, addThree, addFive);
addFifteen(45).then(console.log); // 60</code></pre></li></ul><figure class="block-color-blue_background callout" style="white-space:pre-wrap;display:flex" id="53515ba0-fc2b-481c-9260-cf813b4d61c2"><div style="font-size:1.5em"><span class="icon">ğŸ’¡</span></div><div style="width:100%">æ³¨æ„ï¼šåœ¨è®¨è®ºå¼‚æ­¥å‡½æ•°æ—¶è¿˜ä¼šå‡ºç°è¿™ä¸ªä¸²è¡ŒæœŸçº¦åˆæˆçš„æ¦‚å¿µ</div></figure><h1 id="82474ab2-0f12-4cf4-b2e2-217206868ad9" class="">2.5 æœŸçº¦æ‰©å±•ï¼ˆPromise Extensionsï¼‰</h1><p id="eaa4c0f5-7926-4881-aeaa-77a83a11746d" class="">ä¸Šè¿°åŸºæœ¬ä¸Šå°±æ˜¯ECMAScript6å‚è€ƒPromises/A+è§„èŒƒå®ç°çš„æœŸçº¦çš„å¤§éƒ¨åˆ†ç‰¹æ€§ï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰<strong>ä¸è¶³ä¹‹å¤„ï¼š</strong><div class="indented"><p id="1822f183-4043-4b81-8f70-765baea44660" class=""><strong>æœŸçº¦å–æ¶ˆ</strong>ï¼ˆ<strong>promise canceling</strong>ï¼‰</p><p id="ff18667b-148e-40e8-aef1-5fe230c726ad" class=""><strong>è¿›åº¦è¿½è¸ª</strong>ï¼ˆ<strong>progress tracking</strong>ï¼‰</p></div></p><p id="3fbf617c-9626-4798-aad7-7e1c0aa57cc1" class="">è¿™äº›åœ¨å¾ˆå¤šç¬¬ä¸‰æ–¹æœŸçº¦åº“å®ç°ä¸­å…·å¤‡è€ŒECMAScript 6 è§„èŒƒæœªæ¶‰åŠçš„ä¸¤ä¸ªç‰¹æ€§å°±æ˜¯<strong>æœŸçº¦çš„æ‰©å±•ç‰¹æ€§ï¼ˆPromise Extensionsï¼‰</strong></p><h2 id="936dd2b7-0e46-4fc0-ba08-afa3c9273c6c" class="">2.5.1 æœŸçº¦å–æ¶ˆï¼ˆPromise Cancelingï¼‰</h2><ul id="bd24a7e5-b74b-4e67-bb29-ae7702641edf" class="bulleted-list"><li style="list-style-type:disc">åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œ promiseè¿˜åœ¨<strong>è¿›åº¦</strong>ï¼ˆ<strong>progress</strong>ï¼‰ä¸­ï¼Œ<strong>ç¨‹åº</strong>ï¼ˆ<strong>program</strong>ï¼‰å°±ä¸å…³å¿ƒè¿™ä¸ªpromiseçš„ç»“æœäº†ï¼Œè¿™ä¸ªæ—¶å€™èƒ½â€œ<strong>å–æ¶ˆ</strong>ï¼ˆ<strong>cancel</strong>ï¼‰â€promiseå°±å¥½äº†<ul id="83312c13-b966-4333-9438-68187881cbaa" class="bulleted-list"><li style="list-style-type:circle">ä¸€äº›ç¬¬ä¸‰æ–¹åº“å°±æä¾›äº†è¿™ç§æœŸçº¦çš„æ‰©å±•åŠŸèƒ½ï¼Œå¦‚Bluebird</li></ul><ul id="74742b6a-b0b7-414f-bddf-74fdf11ed146" class="bulleted-list"><li style="list-style-type:circle">å®é™…ä¸ŠTC39å§”å‘˜ä¼šä¹Ÿæ›¾å‡†å¤‡åœ¨ES6çš„æœŸçº¦ä¸­å¢åŠ è¿™ä¸ªç‰¹æ€§ï¼Œä½†æ˜¯ç›¸<a href="https://github.com/tc39/proposal-cancelable-promises">ææ¡ˆ</a>è¢«<strong>æ’¤å›</strong>ï¼ˆ<strong>withdrawn</strong>ï¼‰äº†</li></ul><ul id="509ee5a0-73f9-40a8-a7ca-7ca4f6d09d79" class="bulleted-list"><li style="list-style-type:circle">è¿™å°±å¯¼è‡´ES6çš„æœŸçº¦çš„<strong>å°è£…å‡½æ•°</strong>ï¼ˆ<strong>encapsulated function</strong>ï¼‰å¼€å§‹æ‰§è¡Œï¼Œå°±æ²¡åŠæ³•é˜»æ­¢å®ƒæ‰§è¡Œåˆ°å®Œæˆï¼Œè¿™ä½¿å¾—æœŸçº¦å¾ˆâ€œ<strong>æ¿€è¿›</strong>ï¼ˆ<strong>eager</strong>ï¼‰â€</li></ul></li></ul><ul id="94001bae-bdfb-47d3-8f3d-d3fea09e0860" class="bulleted-list"><li style="list-style-type:disc">è¦å®ç°æœŸçº¦å–æ¶ˆåŠŸèƒ½ï¼Œå¯ä»¥åœ¨ç°æœ‰çš„ECMAScript 6 çš„æœŸçº¦åŸºç¡€ä¸Šæä¾›<strong>ä¸€ç§ä¸´æ—¶æ€§çš„å°è£…</strong>ï¼ˆ<strong>an ad-hoc implementation</strong>ï¼‰<ul id="a70bb28d-87ca-41ed-ac73-7effabf5e587" class="bulleted-list"><li style="list-style-type:circle">Kevin Smith<strong>è®¾è®¡</strong>çš„â€<strong>å–æ¶ˆä»¤ç‰Œ</strong>ï¼ˆ<strong>cancel tokenï¼Œ </strong><a href="https://github.com/zenparsing/es-cancel-token">githubåœ°å€</a>ï¼‰â€<strong>è‰å›¾</strong>ï¼ˆ<strong>design sketch</strong>ï¼‰èƒ½å®ç°è¿™ç§åŠŸèƒ½</li></ul><ul id="9083a04d-7343-44a1-a265-fd52bb35ef26" class="bulleted-list"><li style="list-style-type:circle">ç”Ÿæˆçš„<strong>å–æ¶ˆä»¤ç‰Œå®ä¾‹ï¼ˆcancel tokenï¼‰</strong>æä¾›ä¸€ä¸ªæ¥å£ï¼Œåˆ©ç”¨è¿™ä¸ªæ¥å£å¯ä»¥å–æ¶ˆæœŸçº¦</li></ul><ul id="ae8b8a3b-020d-47f5-88a6-1008b623a193" class="bulleted-list"><li style="list-style-type:circle">åŒæ—¶æä¾›ä¸€ä¸ªæœŸçº¦çš„å®ä¾‹ï¼Œå¯ä»¥ç”¨æ¥è§¦å‘å–æ¶ˆï¼ˆ<strong>tigger cancellation</strong>ï¼‰åçš„æ“ä½œå¹¶æ±‚å€¼å–æ¶ˆçŠ¶æ€<pre id="f3f658b2-5b11-4e7c-a700-30b0eb2765d6" class="code code-wrap"><code>// å–æ¶ˆä»¤ç‰Œ
class CancelToken {
  constructor(cancelFn) {
    this.promise = new Promise((resolve, reject) =&gt; {
      cancelFn(resolve);
    });
  }
}</code></pre><ul id="340442bb-3bea-4df4-a2bd-a498ecd059c1" class="bulleted-list"><li style="list-style-type:square">è¿™ä¸ªç±»åŒ…è£…äº†ä¸€ä¸ªæœŸçº¦ï¼ŒæŠŠè§£å†³æ–¹æ³•æš´éœ²ç»™äº†<code>cancelFn</code>å‚æ•°ï¼Œè¿™æ ·<strong>å¤–éƒ¨ä»£ç </strong>ï¼ˆ<strong>external entity</strong>ï¼‰å°±å¯ä»¥å‘æ„é€ å‡½æ•°ä¸­ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œä»è€Œæ§åˆ¶ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥å–æ¶ˆæœŸçº¦</li></ul><ul id="8ed37ced-c6bf-434b-a17f-7d0b78afc41f" class="bulleted-list"><li style="list-style-type:square">è¿™é‡Œçš„æœŸçº¦æ˜¯ä»¤ç‰Œç±»çš„å…¬å…±æˆå‘˜ï¼Œå› æ­¤å¯ä»¥ç»™å®ƒæ·»åŠ <strong>ç›‘å¬å¤„ç†ç¨‹åº</strong>ï¼ˆ<strong>listeners</strong>ï¼‰ä»¥å–æ¶ˆæœŸçº¦</li></ul></li></ul></li></ul><ul id="094449c9-b0bd-4933-af07-a3d15acc74aa" class="bulleted-list"><li style="list-style-type:disc">ä¸€ä¸ªä½¿ç”¨å–æ¶ˆä»¤ç‰Œçš„æ€æƒ³çš„ä¾‹å­<pre id="84432325-f4ba-49b7-9bed-b1c2f8de6eac" class="code code-wrap"><code>class CancelToken {
  static {
    this.id = 0;
  }
  constructor(cancelFn) {
    this.id = CancelToken.id++;
    this.promise = new Promise((resolve, reject) =&gt; {
      cancelFn(() =&gt; {
        setTimeout(console.log, 0, &quot;delay cancelled&quot;);
        resolve();
      });
    });
  }
}

const startBtn = document.querySelector(&quot;#start&quot;);
const cancelBtn = document.querySelector(&quot;#cancel&quot;);

function cancellableDelayedResolved(delay) {
  setTimeout(() =&gt; console.log(&quot;set delay&quot;), 0);
  return new Promise((resolve, reject) =&gt; {
    const id = setTimeout(() =&gt; {
      setTimeout(console.log, 0, &quot;delayed resolved&quot;);
      resolve();
      cancelBtn.removeEventListener(&quot;click&quot;, listener);
    }, delay);
    let listener = null;
    const cancelToken = new CancelToken((cancelCallback) =&gt; {
      listener = () =&gt; {
        console.log(cancelToken.id);
        cancelCallback();
        cancelRequest();
      };
      cancelBtn.addEventListener(&quot;click&quot;, listener);
    });
    cancelToken.promise.then(() =&gt; {
      clearTimeout(id);
      // ç§»é™¤å½“å‰çš„äº‹ä»¶å¤„ç†ç¨‹åº
      cancelBtn.removeEventListener(&quot;click&quot;, listener);
    });
  });
}

startBtn.addEventListener(&quot;click&quot;, () =&gt;
  cancellableDelayedResolved(1000)
);</code></pre><ul id="f8c38b2f-0ed2-44a2-a40c-3c144e24b7af" class="bulleted-list"><li style="list-style-type:circle">æœ€é‡è¦çš„ä¸¤éƒ¨åˆ†ä»£ç æ˜¯é»„è‰²èƒŒæ™¯çš„ä»£ç ï¼Œç¬¬ä¸€æ®µé»„è‰²èƒŒæ™¯çš„ä»£ç <code>CancelToken</code>å®ä¾‹å£°æ˜åå°±ä¼šç«‹å³å°†æ„é€ å‡½æ•°ä¼ é€’è¿›æ¥çš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶å°†resolveé…åˆå‡½æ•°å‚æ•°ä½œä¸ºå¯¹è±¡ä¼ é€’ï¼Œè®©å¤–éƒ¨ä»£ç å¯ä»¥è·å–åˆ°resolveå†³å®šä½•æ—¶æ‰§è¡Œä»¥å–æ¶ˆå…¶å®ƒçš„promise</li></ul><ul id="ef04feb2-e0df-4aa0-adc1-e11c3dbe6c54" class="bulleted-list"><li style="list-style-type:circle">ç¬¬äºŒæ®µé»„è‰²èƒŒæ™¯çš„ä»£ç å°±æ˜¯åœ¨è¿›è¡Œä¸€æ¬¡Promiseè¯·æ±‚æ—¶åˆ›å»ºå®ƒå¯¹åº”çš„å–æ¶ˆä»¤ç‰Œï¼Œè¿™é‡Œå¾ˆé«˜çº§çš„æ˜¯ï¼Œ<code>cancelCallback</code> å‚æ•°å®é™…ä¸Šå°±æ˜¯åˆ›å»ºè¿‡ç¨‹ä¸­<code>CancelToken</code> ä¼ é€’å‡ºæ¥çš„åŒ…å«<code>resolve</code>çš„å–æ¶ˆå‡½æ•°å¯¹è±¡ï¼Œåœ¨è¿™é‡Œå–æ¶ˆpromiseçš„æ¡ä»¶æ˜¯ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®ï¼Œæ‰€ä»¥ä¼šå£°æ˜ä¸€ä¸ªç‚¹å‡»äº‹ä»¶å¤„ç†ç¨‹åºç”¨äºç›‘å¬æŒ‰é’®çš„ç‚¹å‡»ï¼Œè€Œè¿™ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºå°±ä¼šæ‰§è¡Œ<code>cancelCallback</code> ï¼Œå³æ‰§è¡Œ<code>resolve</code> ç›´æ¥å°†<code>CancelToken</code> å®ä¾‹çš„promiseå®Œæˆï¼ˆå–æ¶ˆç¡®å®šï¼‰ï¼Œåç»­<code>CancelToken</code> å®ä¾‹å°†å½“å‰Promiseè¯·æ±‚ä¸­çš„å¼‚æ­¥æ“ä½œæ¸…é™¤å³å¯ï¼ˆè¿™é‡Œä½¿ç”¨<code>clearTimeout</code>ï¼‰</li></ul><ul id="44850318-6026-46a3-96df-2bef8c11a8d2" class="bulleted-list"><li style="list-style-type:circle">æ³¨æ„åœ¨å–æ¶ˆPromiseå’Œå®ŒæˆPromiseéƒ½éœ€è¦å°†å–æ¶ˆæŒ‰é’®å…³è”çš„<mark class="highlight-yellow_background"><strong>listener</strong></mark>è§£ç»‘ï¼Œå› ä¸º<code><mark class="highlight-yellow_background"><strong>addEventListener</strong></mark></code>çš„ç›‘å¬çš„äº‹ä»¶å¤„ç†ç¨‹åºæ˜¯ç‹¬ç«‹å åŠ çš„ï¼Œé˜²æ­¢ä¸‹ä¸€æ¬¡å–æ¶ˆæ—¶æ‰§è¡Œä¸Šä¸€æ¬¡ç›‘å¬çš„äº‹ä»¶å¤„ç†ç¨‹åºï¼ˆå¦åˆ™ä¼šå¤šæ¬¡è°ƒç”¨ä¸åŒçš„<code>CancelToken</code> å®ä¾‹çš„promiseä¸­çš„resolveï¼Œæ‰“å°å‡ºå¤šä¸ª<mark class="highlight-yellow_background"><strong>&quot;delay cancelled&quot;</strong></mark>ï¼‰</li></ul><ul id="17c3218c-6574-4ec6-ba45-3a7819d56163" class="bulleted-list"><li style="list-style-type:circle">å®Œæ•´ä»£ç åœ¨<a href="https://github.com/mangwu/javascript/blob/master/ProfessionalJavaScriptForWebDeveloper4/ch11%20-%20Promise%20And%20Async%20Functions/11.2%20Promise/11.2.5%20Promise%20Extensions/11.2.5.1%20Promise%20Canceling.js">GitHub</a>ä¸Šï¼Œæ•ˆæœå¦‚ä¸‹<figure id="b3dd349c-eea3-4035-b1e8-ddfaeecf3776" class="image"><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/Promise_Cancelling.gif"><img style="width:776px" src="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/Promise_Cancelling.gif"/></a></figure></li></ul></li></ul><ul id="b7818f36-a09e-4552-8605-380fdfd85951" class="bulleted-list"><li style="list-style-type:disc">å®é™…ä¸Šï¼Œå–æ¶ˆæœŸçº¦çš„æœ¬è´¨å°±æ˜¯ç»ˆæ­¢æœŸçº¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚æ­¥æ“ä½œï¼Œè€Œä¸Šè¿°çš„å–æ¶ˆä»¤ç‰Œæ–¹æ³•å°±æ˜¯åˆ©ç”¨æœŸçº¦çš„<code>resolve()</code> å¤„ç†ç¨‹åºï¼Œè®©å¦å¤–ä¸€ä¸ª<code>Promise</code>å®ä¾‹æ„ŸçŸ¥ç¨‹åºæ˜¯å¦éœ€è¦ç»ˆæ­¢è¿›è¡Œä¸­çš„æœŸçº¦ï¼Œå¦‚æœéœ€è¦ï¼Œå°±è®©å¦ä¸€ä¸ª<code>Promise</code> å®ä¾‹è¿›å…¥å…‘ç°çŠ¶æ€ï¼ˆç¡®å®šå–æ¶ˆï¼‰ï¼Œæ‰§è¡Œå¯¹åº”çš„è§£å†³å¤„ç†ç¨‹åºï¼Œå°†æœŸçº¦çš„å¼‚æ­¥æ“ä½œç»ˆæ­¢ï¼ˆä¾‹å­ä¸­æ˜¯ä½¿ç”¨<code>clearTimeout</code> å‡½æ•°è¿›è¡Œæ¨¡æ‹Ÿï¼‰</li></ul><h2 id="744f8478-b926-4c5e-9361-190dee459411" class="">2.5.2 æœŸçº¦è¿›åº¦é€šçŸ¥ï¼ˆPromise Progress Notificationsï¼‰</h2><ul id="dc27def1-de89-488c-b766-b212a6140cfd" class="bulleted-list"><li style="list-style-type:disc"><strong>æ‰§è¡Œä¸­</strong>ï¼ˆ<strong>in-progress</strong>ï¼‰çš„æœŸçº¦å¯èƒ½ä¼šæœ‰ä¸å°‘çš„<strong>ç¦»æ•£</strong>ï¼ˆ<strong>discrete</strong>ï¼‰çš„â€œé˜¶æ®µâ€ï¼Œåœ¨æœ€ç»ˆè§£å†³ä¹‹å‰å¿…é¡»ä¾æ¬¡ç»è¿‡ï¼ŒæŸäº›æƒ…å†µä¸‹<strong>ç›‘æ§</strong>ï¼ˆ<strong>watch for</strong>ï¼‰æœŸçº¦çš„<strong>æ‰§è¡Œè¿›åº¦</strong>ï¼ˆ<strong>checkpoints</strong>ï¼‰ä¼šå¾ˆæœ‰ç”¨ï¼Œè¿™ç§ç›‘æ§æœŸçº¦çš„æ‰§è¡Œè¿›åº¦çš„ç‰¹æ€§å«åš<strong>è¿›åº¦è¿½è¸ª</strong>ï¼ˆ<strong>progress tracking</strong>ï¼‰<ul id="d0f7ef33-434d-49fe-836a-9458b51268c6" class="bulleted-list"><li style="list-style-type:circle">ECMAScript 6 æœŸçº¦å¹¶ä¸æ”¯æŒ<strong>è¿›åº¦è¿½è¸ª</strong>ï¼ˆ<strong>progress tracking</strong>ï¼‰</li></ul><ul id="297c3148-398b-4b43-807e-23228413ba37" class="bulleted-list"><li style="list-style-type:circle">ä½†æ˜¯å¯ä»¥é€šè¿‡<strong>æ‰©å±•</strong>ï¼ˆ<strong>extends</strong>ï¼‰æ¥å®ç°</li></ul></li></ul><ul id="7b08d8e3-44a9-4640-8f76-97bbed4d8873" class="bulleted-list"><li style="list-style-type:disc">ä¸€ç§å®ç°æ–¹å¼æ˜¯<strong>æ‰©å±•</strong>ï¼ˆ<strong>extends</strong>ï¼‰<code>Promise</code>ç±»ï¼Œä¸ºå®ƒçš„å­ç±»æ·»åŠ <code>notify()</code> æ–¹æ³•<pre id="57053f27-6516-4bf7-b471-1a12a9bd83cd" class="code code-wrap"><code>// è¿›åº¦è·Ÿè¸ª
class TrackablePromise extends Promise {
  constructor(executor) {
    const notifyHandlers = [];
    super((resolve, reject) =&gt; {
      return executor(resolve, reject, (status) =&gt; {
        notifyHandlers.map((handler) =&gt; handler(status));
      });
    });
    this.notifyHandlers = notifyHandlers;
  }
  notify(notifyHandler) {
    this.notifyHandlers.push(notifyHandler);
    return this;
  }
}</code></pre><ul id="f71d09fc-d427-43dc-a2f5-5498d17040c2" class="bulleted-list"><li style="list-style-type:circle">é¦–å…ˆè¿™ä¸ª<code>TrackablePromise</code> çš„æ„é€ å‡½æ•°ä¼šåˆ›å»ºäº†ä¸€ä¸ª<code>notifyHandlers</code> æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„ç”¨äºä¿å­˜åœ¨è¿½è¸ªè¿‡ç¨‹ä¸­çš„è¿½è¸ªå¤„ç†ç¨‹åºï¼ˆå³è¦è¿½è¸ªçš„Promiseï¼‰</li></ul><ul id="9a3a183a-a493-45dd-b772-ea5f0c063776" class="bulleted-list"><li style="list-style-type:circle">ç„¶åè°ƒç”¨<code>super()</code> ä»¥ç»§æ‰¿<code>Promise</code> çš„ç‰¹æ€§ï¼Œè°ƒç”¨<code>super()</code> éœ€è¦ä¼ é€’çˆ¶ç±»çš„<code>executor</code> æ‰§è¡Œå™¨ï¼Œä½†æ˜¯è‡³å°‘ç®€å•çš„è®²å­ç±»çš„<code>executor</code> ä¼ é€’è¿‡å»å°±è¾¾ä¸åˆ°æ‰©å±•çš„æ•ˆæœï¼Œéœ€è¦åœ¨<code>executor</code>ä¸­å¢åŠ é¢å¤–çš„<strong>è¿½è¸ªå‚æ•°å‡½æ•°</strong>ï¼Œä½¿ç”¨ç®­å¤´å‡½æ•°åŒ…è£…ä¸€ä¸‹å†ä¼ é€’ç»™æ‰§è¡Œå‡½æ•°åŸå§‹çš„<code>resolve</code> å’Œ<code>reject</code> ï¼Œç„¶ååœ¨å­ç±»çš„<code>executor</code> æ‰§è¡Œå™¨ä¸­æ·»åŠ é¢å¤–çš„<code>notify</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºåœ¨å®ä¾‹åŒ–Promiseç¼–å†™æ‰§è¡Œå™¨å‡½æ•°æ—¶ä½¿ç”¨ï¼Œç”¨äºè®¾ç½®åœ¨ä½•æ—¶è°ƒç”¨<code>notify</code> ä»¥è®°å½•å½“å‰<code>Promise</code>è¿›åº¦</li></ul><ul id="c5152dfa-bed3-4ab7-b861-aab4ba35be15" class="bulleted-list"><li style="list-style-type:circle">å› ä¸ºåˆå§‹æ—¶<code>notifyHandlers</code> æ˜¯ç©ºæ•°ç»„ï¼Œå¦‚æœä¸æ·»åŠ ç„¶åè¿½è¸ªå¤„ç†ç¨‹åºçš„å‡½æ•°å¯¹è±¡ï¼Œæ‰§è¡Œä¸Šè¿°çš„<code>notify</code> ä¹Ÿæ²¡æœ‰æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>TrackablePromise</code> ä¸Šæ·»åŠ ä¸€ä¸ªåŸå‹æ–¹æ³•ç”¨äºåœ¨<code>notifyHandlers</code> ä¸Šæ·»åŠ è¿½è¸ªå¤„ç†ç¨‹åºï¼ˆã€ŠJavaScripté«˜çº§ç¨‹åºè®¾è®¡ï¼ˆç¬¬4ç‰ˆï¼‰ã€‹ä¸­å°†è¿™ä¸ªåŸå‹æ–¹æ³•ä¹Ÿå®šä¹‰æˆäº†<code>notify</code> ï¼Œæ‰€ä»¥å¯èƒ½ä¸å¥½ç†è§£ï¼‰</li></ul></li></ul><ul id="05958313-1804-4bc2-a3fd-c900f62182d4" class="bulleted-list"><li style="list-style-type:disc">ä½¿ç”¨ä¸Šè¿°å®šä¹‰çš„<code>TrackablePromise</code>  <pre id="333a8cd9-1ffe-4e63-a554-a9f46e1fcdb7" class="code code-wrap"><code>let p = new TrackablePromise((resolve, reject, notify) =&gt; {
  function countDown(x) {
    if (x &gt; 0) {
      notify(`${20 * x} % remainin`);
      setTimeout(() =&gt; countDown(x - 1), 1000);
    } else {
      resolve();
    }
  }
  countDown(5);
});
// æ²¡æœ‰ä»»ä½•æ‰“å°</code></pre><ul id="66475a3c-0815-41aa-ab08-48415025eb38" class="bulleted-list"><li style="list-style-type:circle">æœŸçº¦<code>p</code> ä¼šè¿ç»­5æ¬¡<strong>é€’å½’</strong>(<strong>recursively</strong>)çš„è®¾ç½®1000æ¯«ç§’çš„<strong>è¶…æ—¶</strong>ï¼ˆ<strong>timeout</strong>ï¼‰</li></ul><ul id="3a5ab936-f0fb-4f29-8afd-e260da5e68f3" class="bulleted-list"><li style="list-style-type:circle">æ¯ä¸ªè¶…æ—¶éƒ½ä¼šè°ƒç”¨<code>notify()</code> å¹¶ä¼ å…¥çŠ¶æ€å€¼ï¼Œæ³¨æ„è¿™é‡Œçš„<code>notify()</code> æ˜¯åœ¨<code>executor</code> ä¸Šé¢å¤–å¢åŠ çš„ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œç”¨äºéå†æ‰§è¡Œ<code>notifyHandlers</code> æ•°ç»„ä¸Šçš„æ¯ä¸ªè¿½è¸ªå¤„ç†ç¨‹åº</li></ul><ul id="63c22a8b-7b85-433e-8504-45f638faeea0" class="bulleted-list"><li style="list-style-type:circle"><code>notifyHandlers</code> åˆå§‹ä¸ºç©ºæ•°ç»„ï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨<code>notify(notifyHandler)</code> ï¼ˆåŸå‹æ–¹æ³•ï¼‰å¢åŠ è¿½è¸ªå¤„ç†ç¨‹åºï¼Œæ‰€ä»¥æ²¡æœ‰ä»»ä½•æ‰“å°</li></ul></li></ul><ul id="5092f5da-4277-408f-8447-ffe52563046d" class="bulleted-list"><li style="list-style-type:disc">ä½¿ç”¨åŸå‹æ–¹æ³•å¢åŠ è¿½è¸ªå¤„ç†ç¨‹åºï¼Œä»¥è®°å½•æœŸçº¦æ‰§è¡Œæ—¶çš„æ—¥å¿—<pre id="a1fe7b37-d9b1-4603-98d2-35272e0d5795" class="code code-wrap"><code>let p1 = new TrackablePromise((resolve, reject, notify) =&gt; {
  function countDown(x) {
    if (x &gt; 0) {
      notify(`${20 * x} % remaining`);
      setTimeout(() =&gt; countDown(x - 1), 1000);
    } else {
			notify(`p1 promise resolved`);
      resolve();
    }
  }
  countDown(5);
});

p1.notify((x) =&gt; setTimeout(console.log, 0, &quot;progress:&quot;, x));
// æ‰“å°
// progress: 80 % remaining (1s å)
// progress: 60 % remaining (2s å)
// progress: 40 % remaining (3s å)
// progress: 20 % remaining (4s å) 
// progress: p1 promise resolved (5s å)</code></pre><ul id="1f8d3012-c6e4-4023-95cc-ac54291c3c08" class="bulleted-list"><li style="list-style-type:circle">æ³¨æ„è¿™é‡Œ<strong>æ²¡æœ‰</strong>â€100 % remainingâ€ ç›¸å…³æç¤ºï¼Œå› ä¸ºåœ¨æ‰§è¡Œ<code>countDoun(5)</code> ï¼Œ<code>notify()</code> å‡½æ•°æ‰§è¡Œæ—¶ï¼Œ<code>notifyHandlers</code> è¿˜æ˜¯ç©ºï¼ˆæ‰§è¡Œå™¨æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åé¢æ‰§è¡Œçš„<code>p1.notify()</code> æ™šäº<code>countDown(5)</code>ï¼‰ ï¼Œä¹‹åæ‰æ·»åŠ é€šè¿‡åŸå‹æ–¹æ³•æ·»åŠ ä¸Šä¸€ä¸ª<code>notifyHandler</code> ,æ‰€ä»¥æ‰æœ‰è®°å½•</li></ul></li></ul><ul id="d36ddb34-f650-4738-8eaf-9e59890d9f01" class="bulleted-list"><li style="list-style-type:disc"><code>notify()</code> (åŸå‹)å‡½æ•°å¯ä»¥è¿”å›æœŸçº¦ï¼Œæ‰€ä»¥å¯ä»¥è¿ç¼€è°ƒç”¨ï¼Œè¿ç»­æ·»åŠ å¤„ç†ç¨‹åºï¼Œå¤šä¸ªå¤„ç†ç¨‹åºä¼šé’ˆå¯¹çš„æ¯æ¡æ¶ˆæ¯åˆ†åˆ«æ‰§è¡Œä¸€é<pre id="c1584d55-1872-4367-b9fb-b19e5625f9be" class="code code-wrap"><code>let p1 = new TrackablePromise((resolve, reject, notify) =&gt; {
  function countDown(x) {
    if (x &gt; 0) {
      notify(x);
      setTimeout(() =&gt; countDown(x - 1), 1000);
    } else {
      console.log(`p1 promise resolved`);
      resolve();
    }
  }
  countDown(5);
});

p1.notify((x) =&gt; setTimeout(console.log, 0, `progress: ${x * 20}% remaining`, ));
p1.notify((x) =&gt; setTimeout(console.log, 0, `${x} seconds later, the execution is complete`));
// æ‰“å°ç»“æœ
// progress: 80% remaining (1s å)
// 4 seconds later, the execution is complete (1s å)
// progress: 60% remaining (2s å)
// 3 seconds later, the execution is complete (2s å)
// progress: 40% remaining (3s å)
// 2 seconds later, the execution is complete (3s å)
// progress: 20% remaining (4s å)
// 1 seconds later, the execution is complete (4s å)
// p1 promise resolved (5s å)</code></pre><ul id="427ab523-631a-4b7c-a853-9b2b82f010df" class="bulleted-list"><li style="list-style-type:circle">è™½ç„¶è¿™ä¸ªå®ç°å¾ˆ<strong>ç²—ç³™</strong>ï¼ˆ<strong>crude</strong>ï¼‰ï¼Œä½†æ˜¯å¯ä»¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨<strong>é€šçŸ¥</strong>ï¼ˆ<strong>notification</strong>ï¼‰æŠ¥å‘Šè¿›åº¦äº†</li></ul></li></ul><figure class="block-color-blue_background callout" style="white-space:pre-wrap;display:flex" id="5e4a21e7-2b42-4beb-8838-bca6072a55b1"><div style="font-size:1.5em"><span class="icon">ğŸ’¡</span></div><div style="width:100%">æ³¨æ„ï¼šES6ä¸æ”¯æŒå–æ¶ˆæœŸçº¦å’Œè¿›åº¦è¿½è¸ªï¼Œä¸€ä¸ªä¸»è¦çš„åŸå› å°±æ˜¯è¿™æ ·ä¼šå¯¼è‡´æœŸçº¦è¿é”å’ŒæœŸçº¦åˆæˆè¿‡åº¦å¤æ‚åŒ–ã€‚æ¯”å¦‚åœ¨ä¸€ä¸ªæœŸçº¦è¿é”ä¸­ï¼Œå¦‚æœæŸä¸ªè¢«å…¶ä»–æœŸçº¦ä¾èµ–çš„æœŸçº¦è¢«å–æ¶ˆæˆ–è€…å‘å‡ºäº†ä¸€ä¸ªé€šçŸ¥ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åº”è¯¥å‘ç”Ÿä»€ä¹ˆå®Œå…¨è¯´ä¸æ¸…æ¥šï¼ˆ<del>åç»­çš„æœŸçº¦éƒ½åº”è¯¥å–æ¶ˆï¼Œä¸ªäººè®¤ä¸º</del>ï¼‰ã€‚æ¯•ç«Ÿï¼Œå¦‚æœå–æ¶ˆäº†<code>Promise.all()</code> å…¶ä¸­çš„ä¸€ä¸ªæœŸçº¦ï¼ˆ<del>ä¸ªäººè®¤ä¸ºåº”è¯¥æŒ‰ç…§è¿™ä¸ªæœŸçº¦åˆå¹¶æ—¶å°±ä¸å­˜åœ¨è¿™ç§æƒ…å†µç»§ç»­å¤„ç†</del>ï¼‰ï¼Œæˆ–è€…æœŸçº¦è¿é”ä¸­å‰é¢çš„æœŸçº¦éƒ½å‘é€äº†ä¸€ä¸ªé€šçŸ¥ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åº”è¯¥æ€ä¹ˆåŠæ¯”è¾ƒåˆç†å‘¢ï¼Ÿ</div></figure><h1 id="a4e4bc09-2d60-443c-af07-7a2a45e35c01" class="">2.6 ç°ä»£ECMAScriptå…³äºPromiseæ–°å¢çš„ç‰¹æ€§</h1><p id="a1beac97-5613-43b6-bd37-7bbfc115add5" class="">å‚è€ƒMDN</p><figure id="1d872a8b-0569-4045-ad58-56dde8546fe8" class="link-to-page"><a href="2%20%E6%9C%9F%E7%BA%A6%EF%BC%88Promise%EF%BC%89%206fc67e657d2a4db483486c82102ea2a6/2%206%20%E9%A2%9D%E5%A4%96%E8%A1%A5%E5%85%85%201d872a8b05694045ad5856dde8546fe8.html"><span class="icon">ğŸ¢</span>2.6 é¢å¤–è¡¥å……</a></figure></div></div><p id="ae70bf9a-eb69-4fb5-a557-bd09413b9e6b" class=""> </p><p id="ababaecb-904e-4022-9b25-da9afc242c71" class="">
</p></div></article></body></html>